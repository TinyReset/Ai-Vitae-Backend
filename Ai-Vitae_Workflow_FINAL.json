{
  "name": "Ai-Vitae Workflow",
  "nodes": [
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "id"
        },
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "You are an expert CV writer, resume optimization specialist, and ATS consultant.\n\nYou must rewrite and optimize CVs using ONLY the information provided.\nYou must never invent, guess, or fabricate any details.\n\nNON-NEGOTIABLE RULES:\n- Do NOT invent roles, responsibilities, employers, dates, tools, certifications, or metrics.\n- Use metrics ONLY if explicitly present or clearly implied; never fabricate numbers.\n- If information is missing, OMIT it entirely (no placeholders).\n- Preserve factual accuracy at all times.\n\nCANONICAL IDENTITY (MANDATORY):\n- The official candidate name provided is the source of truth.\n- If the CV contains a different name, DO NOT use it anywhere.\n- If a name header is included, it must use ONLY the official candidate name.\n- Do not invent or infer contact details; omit them if missing.\n\nATS & FORMAT RULES:\n- No tables, columns, emojis, or special characters.\n- Clean single-column text only.\n- Use clear section headings.\n- Bullet points must start with a hyphen (\"-\").\n- Current role = present tense; past roles = past tense.\n\nOUTPUT RULES:\n- Return ONLY the final rewritten CV.\n- No commentary, explanations, or meta text.\n- Do NOT include markers such as \"CV START\" or \"CV END\"."
            },
            {
              "role": "user",
              "content": "Rewrite the candidate's CV to align with the target Job Description.\nImprove clarity, structure, and readability while preserving complete factual accuracy.\n\nPRIORITIES:\n- Emphasize skills and responsibilities relevant to the Job Description.\n- Naturally incorporate role-relevant keywords (no keyword stuffing).\n- Rewrite bullets using action verbs and clear outcomes.\n- Maintain appropriate seniority based on actual experience.\n\nREQUIRED OUTPUT STRUCTURE:\n- Professional Summary (3â€“5 lines, no first-person)\n- Core Skills (10â€“12 skills present in candidate history)\n- Professional Experience (reverse chronological, 4â€“7 bullets per role)\n- Education\n- Certifications (only if present)\n- Tools & Platforms (only if present)\n\nOFFICIAL CANDIDATE NAME (SOURCE OF TRUTH):\n{{ .ctx?.candidateName || .candidateName || '' }}\n\nCANDIDATE CV (RAW TEXT):\n{{ .cvText || '' }}\n\nJOB DESCRIPTION:\n{{ .jobDescription || '' }}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        6720,
        -240
      ],
      "id": "0296b8e7-0e35-487d-a0c1-9354c64cdd22",
      "name": "Rewrite CV",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "// --- Normalise & Validate ---\n// Mode: Run Once for All Items   â€¢   Language: JavaScript\n\nconst inItems = items || [];\n\n// find config + data items\nconst cfgItem = inItems.find(it => it?.json && it.json._cfg);\nconst dataItem = inItems.find(it =>\n  it?.json && (\n    (it.json.body && Object.keys(it.json.body).length > 0) ||\n    it.json.package !== undefined ||\n    it.json.verifiedPackage !== undefined ||\n    it.json.headers !== undefined ||\n    (it.binary && Object.keys(it.binary || {}).length)\n  )\n) || inItems[0] || { json: {}, binary: {} };\n\n// Pull json/binary\nconst inJsonRaw = dataItem.json || {};\nconst hasBody = inJsonRaw.body && Object.keys(inJsonRaw.body).length > 0;\nconst src = hasBody ? inJsonRaw.body : inJsonRaw;\n\n// --- alias any binary key to `cv` (handles cv0, cv1, etc.) ---\nconst binRaw = dataItem.binary || {};\nconst bin = { ...binRaw };\nconst binKeys = Object.keys(binRaw);\nif (!bin.cv && binKeys.length) {\n  const pick = binKeys.find(k => k.startsWith('cv')) || binKeys[0];\n  bin.cv = binRaw[pick];\n}\n\n// ---- config ----\nconst rawCfg = (cfgItem?.json?._cfg) || (inJsonRaw._cfg) || {};\nlet cfg = { ...rawCfg };\nif (typeof cfg.prices === 'string') {\n  try { cfg.prices = JSON.parse(cfg.prices); } catch { cfg.prices = {}; }\n}\n\n// ---------- helpers ----------\nfunction sizeMB(b) {\n  try {\n    if (!b || !b.data) return 0;\n    const bytes = Buffer.from(b.data, 'base64').length;\n    return Math.round((bytes / (1024 * 1024)) * 100) / 100;\n  } catch { return 0; }\n}\nfunction extFromNameOrMime(b) {\n  try {\n    if (!b) return null;\n    if (b.fileName) {\n      const i = b.fileName.lastIndexOf('.');\n      if (i >= 0) return b.fileName.slice(i + 1).toLowerCase();\n    }\n    const m = (b.mimeType || '').toLowerCase();\n    const map = {\n      'text/plain': 'txt',\n      'application/pdf': 'pdf',\n      'application/msword': 'doc',\n      'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',\n    };\n    return map[m] || null;\n  } catch { return null; }\n}\nfunction parseAddons(v) {\n  if (Array.isArray(v)) return v.map(a => String(a).trim().toLowerCase()).filter(Boolean);\n  if (typeof v === 'string') {\n    const t = v.trim();\n    if (!t) return [];\n    try { const p = JSON.parse(t); if (Array.isArray(p)) return p.map(a => String(a).trim().toLowerCase()).filter(Boolean); } catch {}\n    return t.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);\n  }\n  return [];\n}\nfunction uuid() {\n  return (global.crypto && global.crypto.randomUUID\n    ? global.crypto.randomUUID()\n    : require('crypto').randomUUID());\n}\nfunction normEmail(v) {\n  const e = String(v || '').trim().toLowerCase();\n  // Enhanced email validation regex\n  const emailRegex = /^[a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;\n  if (!emailRegex.test(e)) return '';\n  // Block common disposable email domains\n  const disposable = ['tempmail.com', 'throwaway.com', 'mailinator.com', 'guerrillamail.com', '10minutemail.com', 'fakeinbox.com'];\n  const domain = e.split('@')[1];\n  if (disposable.includes(domain)) return '';\n  return e;\n}\n\n// ---------- package normalization (strict) ----------\nconst rawPkg = String(src.package ?? src.verifiedPackage ?? '').trim();\nconst norm   = rawPkg.toLowerCase();\nconst pkgMap = {\n  'starter':'starter','standard':'standard','premium':'premium','executive':'executive',\n  'start':'starter','basic':'starter','std':'standard','pro':'premium','plus':'premium','exec':'executive','executive+':'executive'\n};\nconst allowedTiers = new Set(['starter','standard','premium','executive']);\n\nlet packageTier  = null;\nlet packageLabel = '';\nlet packageMissing = false;\nlet packageUnknown = false;\n\nif (!rawPkg) {\n  packageMissing = true;\n} else {\n  const mapped = pkgMap[norm] || norm;\n  if (allowedTiers.has(mapped)) { packageTier = mapped; packageLabel = rawPkg; }\n  else { packageUnknown = true; packageLabel = rawPkg; }\n}\n\n// ---------- file info (robust .txt recognition) ----------\nconst cvExt  = extFromNameOrMime(bin.cv);\nconst cvSize = sizeMB(bin.cv);\n\n// ---------- email ----------\nconst emailRaw =\n  src.email || src.userEmail || src.contact || src.verifiedEmail || src.stripeEmail || '';\nconst email = normEmail(emailRaw);\nconst emailValid = Boolean(email);\n\n// ---------- addons (normalize + flags) ----------\nconst rawAddons = src.addons ?? src.verifiedAddons ?? '';\nconst addons = parseAddons(rawAddons);\n\n// accept a few common synonyms/aliases\nconst hasExtraCoverLetter =\n  addons.includes('extracoverletter') || addons.includes('extra_cover_letter') || addons.includes('coverletter+');\n\nconst isOneDayDelivery =\n  addons.includes('oneday') || addons.includes('one-day') || addons.includes('1day') || addons.includes('priority') || addons.includes('rush');\n\nconst needsEditableWord =\n  addons.includes('editableword') || addons.includes('docx') || addons.includes('word');\n\nconst hasLinkedIn =\n  addons.includes('linkedin') || addons.includes('linkedinoptimize') || addons.includes('linkedin_optimization') || addons.includes('linkedin-optimization');\n\n// ---------- assemble output ----------\nconst allowedExts = ['pdf','doc','docx','txt'];\n\nconst out = {\n  _cfg: cfg,\n\n  // NOTE: this is a provisional id for early flow; your Insert Order returns the UUID later\n  orderId: src.orderId || src.verifiedOrderId || uuid(),\n\n  package: packageLabel,\n  packageTier,\n  packageMissing,\n  packageUnknown,\n\n  // add-ons (raw & normalized + convenience flags)\n  _ctx: { ...(inJsonRaw._ctx || {}), rawAddons },\n  addons,\n  hasExtraCoverLetter,\n  isOneDayDelivery,\n  needsEditableWord,\n  hasLinkedIn,\n  hasAnyAddons: addons.length > 0,\n  addonCount: addons.length,\n\n  candidateName: String(src.candidateName ?? src.candidate ?? '').trim(),\n  email,\n  emailValid,\n  jobDescription: String(src.jobDescription ?? src.jd ?? '').trim(),\n\n  cvExt,\n  cvSize,\n  cvOversize: cvSize > 5,                // 5 MB\n  allowedExts,\n  source: 'web',\n};\n\n// optional price\nif (cfg.prices && packageTier) {\n  const p = cfg.prices[packageTier];\n  out.price = (p !== undefined && p !== null) ? Number(p) : null;\n}\n\n// ---------- flags for routing / IF ----------\nconst hasText   = out.jobDescription.length > 0;\nconst hasCv     = !!bin.cv;\nconst cvAllowed = hasCv ? allowedExts.includes((cvExt || '').toLowerCase()) : true;\nconst cvOk      = hasCv ? (cvAllowed && !out.cvOversize) : true;\n\nout.hasText   = hasText;\nout.hasCv     = hasCv;\nout.cvAllowed = cvAllowed;\nout.cvOk      = cvOk;\n// pass if (text) or (good CV) AND valid email\nout.readyForAI = (hasText || (hasCv && cvOk)) && out.emailValid;\n\nreturn [{ json: out, binary: bin }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2848,
        384
      ],
      "id": "ab231af2-bee1-4143-92e9-003ea098a9a8",
      "name": "Normalise & Validate"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5091387b-769e-4bb9-ae7c-0def7800077b",
              "leftValue": "={{$json.readyForAI}}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2176,
        480
      ],
      "id": "bc633924-5a78-4b30-ba87-440a30f44e8f",
      "name": "If"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {
          "responseCode": 400,
          "responseKey": "={\n  \"status\": \"error\",\n  \"message\": \"No CV file uploaded. Please attach a PDF, DOCX, DOC or TXT.\"\n}\n\n"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -1952,
        480
      ],
      "id": "a9658eb0-9d8c-401d-ab3c-189a4b5805f2",
      "name": "Error Message - No CV"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.pdf.co/v1/pdf/convert/to/text",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "cv",
        "options": {
          "response": {
            "response": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        64,
        -576
      ],
      "id": "b647bbcb-6bd7-4e67-a36e-489de14ef0c8",
      "name": "PDF - Text",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 3000,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "mode": "expression",
        "numberOutputs": 5,
        "output": "={{\n  ( { pdf:0, docx:1, doc:2, txt:3 } )[\n    String(\n      $json.fileType\n      || $json.cvExt\n      || $json.extResolved\n      || $json.fileExtension\n      || ($binary.cv  && $binary.cv.fileName  ? $binary.cv.fileName.split('.').pop()  : '')\n      || ($binary.cv0 && $binary.cv0.fileName ? $binary.cv0.fileName.split('.').pop() : '')\n      || ''\n    ).trim().toLowerCase()\n  ] || 5\n}}\n\n",
        "looseTypeValidation": true
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -160,
        -288
      ],
      "id": "90accce3-5e96-4a59-b2ff-a8e05272c28e",
      "name": "File Type"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {
          "responseCode": "=400",
          "responseKey": "{   \"status\": \"error\",   \"message\": \"Unsupported File type. Please upload PDF, DOCX, DOC or TXT.\" }"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        64,
        144
      ],
      "id": "2f708526-4f36-4d31-b346-0ee002f6debe",
      "name": "Error Message"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {
          "responseCode": 413,
          "responseKey": "{ \"status\":\"error\", \"message\":\"CV exceeds 5MB. Please upload a smaller file.\" }"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -1728,
        288
      ],
      "id": "17f88ccb-9caf-44b9-bf57-d692927ac27a",
      "name": "CV too Large"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3e11310a-30e3-490c-ab16-4e50a7d9bda2",
              "leftValue": "={{$json.cvOversize}}",
              "rightValue": "false",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1952,
        288
      ],
      "id": "5bb38cbd-2e0d-43ad-9112-3a44cfcc6ac6",
      "name": "CV < 5MB"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.cloudmersive.com/virus/scan/file/advanced",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpCustomAuth",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "inputFile",
              "inputDataFieldName": "cv"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1504,
        96
      ],
      "id": "800d972c-8d38-4512-b55e-164ba8d7a783",
      "name": "Scan Upload",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "db998032-6dc3-4457-b42f-cada6c3d206f",
              "leftValue": "={{$json.CleanResult}}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1056,
        96
      ],
      "id": "3a82db74-7e60-4b76-9afb-b6abbc523498",
      "name": "IF Clean"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {
          "responseCode": 400,
          "responseKey": "{ \"status\":\"error\", \"message\":\"Uploaded CV failed a safety scan. Please upload a different file.\" }"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -832,
        96
      ],
      "id": "a897a374-441d-445f-9eaf-8e69040f6767",
      "name": "CV Infected"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "75f0a790-bcd7-456b-be21-0b921ea28fa2",
              "leftValue": "={{$json.jobDescription}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        736,
        48
      ],
      "id": "a8fa17de-ed4a-423f-845e-10b8b682c757",
      "name": "IF JD Provided"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {
          "responseCode": 400,
          "responseKey": "{ \"status\":\"error\", \"message\":\"Job description required. Paste it or upload a file.\" }"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        960,
        144
      ],
      "id": "5bfdb788-0812-43dd-8f78-4fd12003cd56",
      "name": "JD Required"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "â€œProofread and standardize the updated CV for consistency and clarity. Do not alter facts.â€"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        6720,
        144
      ],
      "id": "368682c4-7b91-45a5-9dce-dfc39eeaaaef",
      "name": "Starter - Proofread CV"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "You are an expert CV writer, resume optimization specialist, recruitment strategist, and ATS consultant. Your task is to rewrite and optimize a candidate's CV strictly using the information provided, while tailoring it to the target job description.\n\nFollow all Starter-tier rules, with the following Standard-tier enhancements:\n\nðŸ”· ENHANCED WRITING QUALITY\n\nRewrite the CV with:\n- Clearer, more professional phrasing\n- Smoother transitions between sections\n- Stronger action verbs and impact statements\n- More polished professional tone\n\nWITHOUT inventing new skills or achievements.\n\nðŸ”· STRONGER ROLE ALIGNMENT\n\nHighlight the candidate's relevance more explicitly by:\n- Emphasizing transferable strengths\n- Mirroring key concepts from the Job Description\n- Reordering bullets to prioritize most relevant experience\n- Using industry-standard terminology where applicable\n\nðŸ”· IMPROVED STRUCTURE\n\n- Better section organization and flow\n- More impactful bullet point ordering\n- Clearer career progression narrative\n- Enhanced readability and scan-ability\n\nðŸ”· FORMATTING (same as Starter, but more refined)\n\n- Bold section headers\n- One blank line between sections\n- Hyphen \"-\" bullet points\n- No tables, columns, or emojis\n- Clean ATS-friendly formatting\n- Consistent spacing and layout\n\nOUTPUT FORMAT:\nReturn ONLY the rewritten CV.\nNo commentary, explanations, or meta text."
            },
            {
              "role": "user",
              "content": "Rewrite the CV with enhanced clarity, professional polish, and stronger alignment to the Job Description.\n\nApply Standard-tier improvements:\n- More sophisticated language and phrasing\n- Better bullet point structure (Action â†’ Result/Impact)\n- Stronger keyword optimization\n- Clearer value proposition\n\nFollow the System Rules and Starter formatting style.\n\nReturn only the final rewritten CV.\n\n--- CV START ---\n{{.cvText\n  || [\"TXT Field\"].json.cvText\n  || [\"PDF - Text\"].json.cvText\n  || [\"DOCX - Text\"].json.cvText\n  || [\"DOC - Text\"].json.cvText\n  || ''}}\n--- CV END ---\n\n--- JOB DESCRIPTION START ---\n{{.jobDescription\n  || [\"Sanitize JD\"].json.jdText\n  || [\"Normalise & Validate\"].json.jobDescription\n  || ''}}\n--- JOB DESCRIPTION END ---"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        6368,
        -48
      ],
      "id": "215d697c-90b8-48a3-ac08-4a492ed8aef2",
      "name": "Rewrite CV1"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "â€œProofread and standardize the updated CV for consistency and clarity. Do not alter facts.â€"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        6368,
        336
      ],
      "id": "96b75cf5-557a-449b-b06d-854a1a3af30a",
      "name": "Standard - Proofread CV"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "messages": {
          "values": [
            {
              "content": "=Candidate name (may be blank): {{ $json.ctx?.candidateName || $json.candidateName || '' }}\n\nCV (source of truth):\n{{ $json.ctx?.rewrittenCVText || $json.cvRewriteText || '' }}\n\nJob Description:\n{{ $json.ctx?.jobDescription || $json.jobDescription || '' }}\n\nWrite the cover letter now, following all rules exactly.\n"
            },
            {
              "content": "=You are a professional career coach and expert cover letter writer.\n\nWrite a tailored, concise, compelling cover letter (180â€“250 words), professional and results-oriented, for a competitive role.\n\nSTRICT RULES (NO EXCEPTIONS)\n1) Do NOT use placeholders of any kind (e.g., [Your Name], [Company Name], [Address], [Date]).\n2) If the company name is not provided, do NOT invent it. Refer to â€œyour teamâ€ or â€œyour organisationâ€.\n3) Use ONLY facts explicitly present in the CV text provided in this chat. Do NOT add new achievements, tools, certifications, employers, titles, or metrics.\n4) Do NOT claim improved conversions, conversion funnel optimisation, revenue growth, pipeline impact, or ROI improvement unless those exact ideas are explicitly stated in the CV text provided.\n5) Do NOT mention email marketing unless it is explicitly stated in the CV text provided.\n6) Do NOT mention product collaboration unless it is explicitly stated in the CV text provided.\n7) Output must be plain text only (no JSON, no markdown, no bullet points).\n\nFORMAT REQUIREMENTS\n- Must begin with: â€œDear Hiring Manager,â€\n- Must have exactly 3 short paragraphs (no more, no less)\n- Must end with:\n  â€œKind regards,â€\n  followed by the candidateâ€™s name if provided; otherwise end with â€œKind regards,â€ only.\n- Do not include a subject line.\n- Do not include addresses, dates, or contact details.\n",
              "role": "system"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        11920,
        -400
      ],
      "id": "5aaac6d7-b4ee-4d0e-b35a-95aeb7a26d31",
      "name": "Cover Letter - Generate"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "c83980a0-8f68-4dba-8b65-224308ee64c0",
              "leftValue": "={{ $json.hasExtraCoverLetter }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        11776,
        -64
      ],
      "id": "f467a2f7-9382-4189-9a12-9451afe1acdb",
      "name": "Extra Cover Letter"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ca547e29-af02-47a5-9dfb-7c448d442bfc",
              "leftValue": "={{ $json.ctx.flags.oneDay }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        17792,
        -208
      ],
      "id": "01dcccd2-bf83-4177-94b6-271be90017b5",
      "name": "One Day Delivery"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ca547e29-af02-47a5-9dfb-7c448d442bfc",
              "leftValue": "={{ $json.ctx.flags.editableWord }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        16224,
        -208
      ],
      "id": "2ae87cc6-50d5-4e03-9216-fbd84a93edab",
      "name": "Editable Word"
    },
    {
      "parameters": {
        "jsCode": "// Use top-level $json unless body actually has keys\nconst inJsonRaw = $json ?? {};\nconst src = (inJsonRaw.body && Object.keys(inJsonRaw.body).length > 0)\n  ? inJsonRaw.body\n  : inJsonRaw;\n\nconst bin = $binary || {};\n\n// Run Once for All Items\n\n// -- Params you can tune\nconst MAX_CHARS = 10000;   // hard ceiling for JD length\nconst REMOVE_URLS = true;  // set false if you want to keep URLs\n\nconst inJson = $json ?? {};\nconst inBin  = $binary || {};\n\nlet s = String(inJson.jdText || inJson.jobDescription || '').trim();\n\n// 1) quick length guard (truncate rather than reject; flip to reject if you prefer)\nif (s.length > MAX_CHARS) {\n  inJson.jdTooLarge = true;\n  s = s.slice(0, MAX_CHARS);\n}\n\n// 2) normalize newlines + strip zero-width & control chars\ns = s.replace(/\\r\\n?/g, '\\n');\ns = s.replace(/[\\u200B-\\u200D\\uFEFF]/g, '');                  // zero-width\ns = s.replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, '');       // controls\n\n// 3) de-RTF (common when copying from Word)\nif (s.startsWith('{\\\\rtf')) {\n  s = s\n    .replace(/\\\\'[0-9a-fA-F]{2}/g, '')      // hex escapes\n    .replace(/\\\\par[d]?/g, '\\n')            // paragraph marks\n    .replace(/\\\\[a-z]+-?\\d* ?/gi, '')       // RTF control words\n    .replace(/[{}]/g, '');                  // braces\n}\n\n// 4) drop script/style + any remaining HTML tags\nconst hadHtml = /<\\s*\\/?\\s*[a-z][^>]*>/i.test(s);\ns = s.replace(/<\\s*script[^>]*>[\\s\\S]*?<\\s*\\/\\s*script\\s*>/gi, '');\ns = s.replace(/<\\s*style[^>]*>[\\s\\S]*?<\\s*\\/\\s*style\\s*>/gi, '');\ns = s.replace(/<[^>]+>/g, '');\n\n// 5) neutralize URLs (or log them). This avoids accidental clickable links later.\nconst urls = [];\nif (REMOVE_URLS) {\n  s = s.replace(/\\b((https?:\\/\\/|www\\.)[^\\s<>\"]+)/ig, (m) => { urls.push(m); return '[link removed]'; });\n} else {\n  s.replace(/\\b((https?:\\/\\/|www\\.)[^\\s<>\"]+)/ig, (m) => urls.push(m));\n}\n\n// 6) look for obviously dangerous tokens (defense-in-depth)\n// Use case-insensitive substring checks to avoid invalid regex construction.\nconst badTokens = [];\nconst lower = s.toLowerCase();\n['javascript:', 'data:text', 'onerror=', 'onload=', '<iframe', '<img', '<svg', 'eval(']\n  .forEach(tok => { if (lower.includes(tok)) badTokens.push(tok); });\n\n// 7) collapse whitespace\ns = s.replace(/\\s{3,}/g, '  ').trim();\n\n// 8) write sanitized JD + diagnostics\nconst outJson = {\n  ...inJson,\n  jobDescription: s,\n  jdText: s, // keep whatever your AI nodes expect\n  jdSanitized: {\n    hadHtml,\n    urls,\n    badTokens,\n    length: s.length,\n    truncated: Boolean(inJson.jdTooLarge),\n  },\n};\n\n// IMPORTANT: return a proper n8n item and carry the binary along\nreturn [{ json: outJson, binary: inBin }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2400,
        480
      ],
      "id": "50936928-8094-47b4-97d6-cdcf5a05953b",
      "name": "Sanitize JD"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "65ac842a-04ee-49d0-a7e4-844cc1b8ea01",
              "name": "=_cfg.bucket",
              "value": "={{ $env.AWS_BUCKET || 'careeredge-orders' }}",
              "type": "string"
            },
            {
              "id": "5bbb37e6-246c-4feb-9036-15c14b431de4",
              "name": "=_cfg.pgSchema",
              "value": "={{ $env.PG_SCHEMA || 'public' }}",
              "type": "string"
            },
            {
              "id": "0c7fa8fa-7074-4f35-8944-96d41983bd9a",
              "name": "=_cfg.region",
              "value": "={{ $env.AWS_REGION || 'eu-west-1' }}",
              "type": "string"
            },
            {
              "id": "dcec6625-7b12-40d5-9b2f-09a73b9e88f5",
              "name": "=_cfg.prices",
              "value": "={{ $env.PACKAGE_PRICES || '{\"starter\":4.99,\"standard\":7.99,\"premium\":14.99,\"executive\":24.99}' }}",
              "type": "object"
            },
            {
              "id": "a2920cc6-85f5-4107-8602-6c7b4666203e",
              "name": "=_ctx.rawAddons",
              "value": "={{ $('Webhook Intake').item.json.body.addons || '' }}",
              "type": "string"
            },
            {
              "id": "e34c2f8d-473b-4158-983c-82f244f21a1b",
              "name": "=addons",
              "value": "={{\n  (() => {\n    const a = $('Webhook Intake').item.json.body.addons;\n    if (Array.isArray(a)) return a.map(s => String(s).trim().toLowerCase()).filter(Boolean);\n    if (typeof a === 'string') {\n      const t = a.trim();\n      try { const j = JSON.parse(t); if (Array.isArray(j)) return j.map(s => String(s).trim().toLowerCase()).filter(Boolean); } catch {}\n      return t ? t.split(',').map(s => s.trim().toLowerCase()).filter(Boolean) : [];\n    }\n    return [];\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "1bdcf510-f4bc-482c-b955-388ef2306912",
              "name": "=hasExtraCoverLetter",
              "value": "={{ Array.isArray($json.addons) && $json.addons.includes('extracoverletter') }}",
              "type": "boolean"
            },
            {
              "id": "9046e736-5115-4bcf-a809-2c686ecbe102",
              "name": "=isOneDayDelivery",
              "value": "={{ Array.isArray($json.addons) && $json.addons.includes('oneday') }}",
              "type": "string"
            },
            {
              "id": "d9561c2c-b236-4e6c-8541-445aa5d02e25",
              "name": "=needsEditableWord",
              "value": "={{ Array.isArray($json.addons) && $json.addons.includes('editableword') }}",
              "type": "string"
            },
            {
              "id": "fd0d908a-7c11-44bf-9c0a-ecb80c9f4fd6",
              "name": "=hasLinkedIn",
              "value": "={{ Array.isArray($json.addons) && ($json.addons.includes('linkedin') || $json.addons.includes('linkedinoptimize')) }}",
              "type": "string"
            },
            {
              "id": "b1c1a8bb-bcf3-4d1a-8035-4711a9683bd5",
              "name": "=hasAnyAddons",
              "value": "={{ Array.isArray($json.addons) && $json.addons.length > 0 }}",
              "type": "string"
            },
            {
              "id": "df81b7ab-fb7b-41fc-8154-bd55e728ab9f",
              "name": "=addonCount",
              "value": "={{ Array.isArray($json.addons) ? $json.addons.length : 0 }}",
              "type": "number"
            },
            {
              "id": "a00ab422-a48f-4c6f-ba88-70656f134e5a",
              "name": "=sessionId",
              "value": "={{ $('Webhook Intake').item.json.body.session_id || '' }}",
              "type": "string"
            },
            {
              "id": "52b6fd19-a4b8-4672-8b5b-c6a5cf614449",
              "name": "=orderId",
              "value": "={{\n  (() => {\n    const v = ( $('Webhook Intake').item.json.body.orderId || '' ).toString().trim();\n    return /^[0-9a-f-]{36}$/i.test(v) ? v : '';\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "1f4187d4-8382-49e3-9e09-821abc5219ab",
              "name": "=candidateName",
              "value": "={{ $('Webhook Intake').item.json.body.candidateName || '' }}",
              "type": "string"
            },
            {
              "id": "fc73cf29-328b-4d79-ad95-84583722345f",
              "name": "=email",
              "value": "={{ $('Webhook Intake').item.json.body.email || '' }}",
              "type": "string"
            },
            {
              "id": "c4fbf491-cc29-435c-9679-3f25ed01bc54",
              "name": "=jobDescription",
              "value": "={{ $('Webhook Intake').item.json.body.jobDescription || '' }}",
              "type": "string"
            },
            {
              "id": "ad29deda-245d-4b48-a863-d12c8da6b374",
              "name": "=package",
              "value": "={{ $('Webhook Intake').item.json.body.package || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3968,
        384
      ],
      "id": "e95bdcfd-aa5a-402f-9d86-a090a0ceb053",
      "name": "Set - Config"
    },
    {
      "parameters": {
        "jsCode": "// n8n runs on Node 18+, so randomUUID exists\nconst id = $json.orderId || (global.crypto?.randomUUID?.() ?? require('crypto').randomUUID());\nreturn [{ json: { ...$json, orderId: id } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        -48
      ],
      "id": "58e5c01b-00be-4f99-ad08-9d4f26a11874",
      "name": "Code - Ensure orderID"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "eb01e65c-ed02-4ab1-8522-f6c8e2c7422a",
              "leftValue": "={{ $json.readyForAI }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1856,
        -336
      ],
      "id": "7c21ed85-3f53-48b8-acb8-573993db6f17",
      "name": "Have binary CV"
    },
    {
      "parameters": {
        "jsCode": "const out = { json: { ...$json } };\n\nif ($json.cvText) {\n  const data = Buffer.from($json.cvText, 'utf8').toString('base64');\n  out.binary = {\n    cv: {\n      data,\n      fileName: 'cv_original.txt',\n      mimeType: 'text/plain',\n    },\n  };\n}\n\nreturn [out];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2080,
        96
      ],
      "id": "ad3d74c4-b3e4-4ce9-affa-222be9e0b7f2",
      "name": "cvText - Binary"
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "={{$json._cfg.bucket}}",
        "fileName": "={{ 'orders/' + $json.orderId + '/cv_original.' + ($json.cvExt || 'txt') }}",
        "binaryPropertyName": "cv",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.awsS3",
      "typeVersion": 2,
      "position": [
        2304,
        -400
      ],
      "id": "34af52ac-939c-4894-817d-217de029ba02",
      "name": "Upload Original CV",
      "retryOnFail": true,
      "maxTries": 4,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fca0d575-68cf-44a0-b8c9-37e7a711669e",
              "name": "=cv_orig_key",
              "value": "={{ ($json.Key || $node[\"Upload Original CV\"].json.Key || '').trim() }}\n\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2528,
        -400
      ],
      "id": "aa033be3-a69e-4b23-bf80-f82afcd072c4",
      "name": "Remember cv_orig_key"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH p AS (\n  SELECT\n    ($1::jsonb->>'order_id')::uuid             AS order_id,\n    NULLIF($1::jsonb->>'storage_key','')::text AS storage_key,\n    /* keep to columns we know exist */\n    COALESCE(NULLIF($1::jsonb->>'package',''),'starter') AS package\n),\nins_order AS (  -- ensure parent exists; only columns we know exist\n  INSERT INTO public.orders (id, status, created_at, package)\n  SELECT p.order_id, 'processing', NOW(), p.package\n  FROM p\n  ON CONFLICT (id) DO UPDATE\n    SET package = COALESCE(public.orders.package, EXCLUDED.package)\n  RETURNING id\n),\nupd AS (  -- try to update existing document row\n  UPDATE public.documents d\n  SET storage_key = p.storage_key\n  FROM p\n  WHERE d.order_id = p.order_id\n    AND d.kind = 'cv_original'\n  RETURNING d.id, d.order_id, d.kind, d.storage_key\n),\nins AS (  -- insert if no existing document row\n  INSERT INTO public.documents (order_id, kind, storage_key)\n  SELECT p.order_id, 'cv_original', p.storage_key\n  FROM p\n  WHERE NOT EXISTS (SELECT 1 FROM upd)\n  RETURNING id, order_id, kind, storage_key\n)\nSELECT id, order_id, kind, storage_key, 'updated'  AS outcome FROM upd\nUNION ALL\nSELECT id, order_id, kind, storage_key, 'inserted' AS outcome FROM ins;",
        "options": {
          "queryReplacement": "=={{ JSON.stringify({\n  order_id:    $node[\"Update Order\"].json.order_id || $json.orderId,\n  storage_key: ($json.cv_orig_key || '').trim(),\n  package:     $json.package || 'starter'\n}) }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2752,
        -400
      ],
      "id": "9b38d6dc-4304-4ce4-8047-cc786ce597cc",
      "name": "Add Doc(cv_original)"
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "={{$json.bucket || $json._cfg.bucket}}",
        "fileName": "={{$json.linkedinKey}}",
        "binaryPropertyName": "linkedin",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.awsS3",
      "typeVersion": 2,
      "position": [
        15536,
        -400
      ],
      "id": "fa891b7c-edf0-4e58-a916-0fc38c7f1bb5",
      "name": "Upload LinkedIn"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.documents (order_id, kind, storage_key) VALUES ($1::uuid, 'linkedin_profile', $2) ON CONFLICT (order_id, kind) DO UPDATE SET storage_key = EXCLUDED.storage_key;",
        "options": {
          "queryReplacement": "={{ [ $json.orderId, $json.linkedinKey || ('orders/' + $json.orderId + '/linkedin.txt') ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        15760,
        -400
      ],
      "id": "7e140f50-75a2-4cdc-af33-66cf8c0a2361",
      "name": "Postgres - Add Doc(linkedin)"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1fjUwCV-8sf6tuqr_PHzndsB4phIUM00_AMfGIcd1oF0",
          "mode": "list",
          "cachedResultName": "CareerEdge P&L",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1fjUwCV-8sf6tuqr_PHzndsB4phIUM00_AMfGIcd1oF0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Transactions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1fjUwCV-8sf6tuqr_PHzndsB4phIUM00_AMfGIcd1oF0/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "={{ $json.sheet.timestamp }}",
            "package": "={{ $json.sheet.package }}",
            "addons": "={{ $json.sheet.addons }}",
            "price_eur": "={{ $json.sheet.price_eur }}",
            "priority": "={{ $json.sheet.priority }}",
            "cv_ext": "={{ $json.sheet.cv_ext }}",
            "source": "={{ $json.sheet.source }}",
            "email": "={{ $json.sheet.email }}",
            "cv_re_key": "={{ $json.sheet.cv_re_key }}",
            "cover_key": "={{ $json.sheet.cover_key }}",
            "li_key": "={{ $json.sheet.li_key }}",
            "status": "={{ $json.sheet.status }}",
            "exec_est": "={{ $json.sheet.exec_est }}",
            "token_cost_eur": "={{ $json.sheet.token_cost_eur }}",
            "notes": "={{ $json.sheet.notes }}",
            "orderId": "={{ $json.sheet.orderId }}",
            "docx_key": "={{ $json.sheet.docx_key }}",
            "rtf_key": "={{ $json.sheet.rtf_key }}",
            "candidateName": "={{ $json.sheet.candidateName }}"
          },
          "matchingColumns": [
            "orderId"
          ],
          "schema": [
            {
              "id": "orderId",
              "displayName": "orderId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "candidateName",
              "displayName": "candidateName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "package",
              "displayName": "package",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "addons",
              "displayName": "addons",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "price_eur",
              "displayName": "price_eur",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "priority",
              "displayName": "priority",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "exec_est",
              "displayName": "exec_est",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "cv_ext",
              "displayName": "cv_ext",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "source",
              "displayName": "source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "cv_re_key",
              "displayName": "cv_re_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "cover_key",
              "displayName": "cover_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "li_key",
              "displayName": "li_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "docx_key",
              "displayName": "docx_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "rtf_key",
              "displayName": "rtf_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "token_cost_eur",
              "displayName": "token_cost_eur",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "notes",
              "displayName": "notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        20704,
        -208
      ],
      "id": "78a66c17-5f42-4b37-aac1-bf909699e19d",
      "name": "Append or update row in sheet"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "claude-sonnet-4-20250514",
          "mode": "list",
          "cachedResultName": "claude-sonnet-4-20250514"
        },
        "messages": {
          "values": [
            {
              "content": "You are a senior-level CV strategist, professional career brand consultant, and ATS optimization expert. Your task is to rewrite the candidate's CV strictly using the provided information, while presenting the candidate in the strongest possible light for the target role.\n\nFollow all Starter and Standard rules, with the following Premium-level enhancements:\n\nðŸ”® ADVANCED JD ALIGNMENT & VALUE FRAMING\n\nTransform the CV to demonstrate:\n- Clear strategic alignment to the role's core priorities\n- Strong emphasis on business impact and value creation\n- Prioritization of most impressive and relevant achievements\n- Sophisticated understanding of the target industry/function\n\nRewrite bullets using high-impact structure:\n**Action + Strategic Context + Measurable Outcome** (when metrics available)\n\nExample transformations:\n- Basic: \"Managed team of 5 developers\"\n- Premium: \"Led cross-functional engineering team of 5, driving agile delivery of customer-facing platform features\"\n\nðŸ”® PREMIUM TONE & SOPHISTICATION\n\nUse language that is:\n- More authoritative and confident\n- More polished and executive-sounding\n- More persuasive without exaggerating\n- More aligned with senior professional standards\n\nTransform ordinary statements into compelling narratives while maintaining complete accuracy.\n\nðŸ”® STRATEGIC CAREER POSITIONING\n\nPresent the candidate as:\n- A strategic problem-solver (not just task-executor)\n- Someone who drives business outcomes (not just completes projects)\n- A leader with vision (not just a contributor)\n\nWITHOUT inventing achievementsâ€”elevate what already exists.\n\nðŸ”® PREMIUM FORMATTING CONSISTENCY\n\n- Impeccable formatting with perfect consistency\n- Sophisticated section organization\n- Professional typography (bold headers, clean spacing)\n- Executive-level presentation quality\n\nðŸ”® KEYWORD OPTIMIZATION\n\n- Natural integration of role-critical keywords\n- Industry-standard terminology and frameworks\n- Technical depth where applicable\n- Strategic business language\n\nOUTPUT RULES:\n- Return ONLY the final rewritten CV\n- No commentary, markers, or explanations\n- Professional, polished, ready-to-submit quality\n\n--- CANDIDATE NAME (SOURCE OF TRUTH) ---\n{{ .ctx?.candidateName || .candidateName || '' }}\n\n--- CANDIDATE CV (RAW TEXT) ---\n{{ .cvText || .ctx?.cvText || '' }}\n\n--- JOB DESCRIPTION ---\n{{ .jobDescription || .ctx?.jobDescription || '' }}"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        6016,
        144
      ],
      "id": "b252e6c9-369f-41cc-8fa3-6407e9c5c705",
      "name": "Premium - CV Rewrite (Claude Sonnet)"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "claude-opus-4-1-20250805",
          "mode": "list",
          "cachedResultName": "claude-opus-4-1-20250805"
        },
        "messages": {
          "values": [
            {
              "content": "You are a top-tier executive rÃ©sumÃ© writer, C-suite career brand strategist, and senior hiring advisor. Your task is to rewrite the candidate's CV to reflect executive presence, strategic leadership, and high-level business impact, strictly within the bounds of factual accuracy.\n\nFollow all Starter, Standard, and Premium rules, with the following Executive-level enhancements:\n\nðŸ‘‘ EXECUTIVE PRESENCE & LEADERSHIP NARRATIVE\n\nTransform the CV into an executive-caliber document that demonstrates:\n- **Strategic Vision:** Position the candidate as a strategic thinker who drives organizational outcomes\n- **Leadership Gravitas:** Emphasize people leadership, change management, and stakeholder influence\n- **Business Acumen:** Highlight P&L impact, revenue growth, operational efficiency, and business transformation\n- **Executive Decision-Making:** Frame responsibilities as strategic choices with organizational consequences\n\nRewrite all bullets using C-suite level structure:\n**Strategic Initiative + Leadership Action + Business Impact + Quantified Outcome** (when available)\n\nExample transformations:\n- Basic: \"Led team of 20 in software development\"\n- Executive: \"Directed 20-person engineering organization, architecting scalable product strategy that accelerated time-to-market by 40% and drove USD 2M ARR growth\"\n\nðŸ‘‘ C-SUITE LANGUAGE & SOPHISTICATION\n\nUse executive-level language:\n- Replace \"managed\" with \"directed,\" \"led,\" \"spearheaded,\" \"orchestrated\"\n- Replace \"worked on\" with \"championed,\" \"drove,\" \"delivered\"\n- Replace \"helped\" with \"enabled,\" \"catalyzed,\" \"accelerated\"\n- Replace task-level verbs with strategic action verbs\n\nFrame achievements in business outcomes:\n- Revenue impact and growth\n- Cost optimization and efficiency\n- Strategic partnerships and stakeholder management\n- Organizational transformation and change leadership\n- Market positioning and competitive advantage\n\nðŸ‘‘ EXECUTIVE POSITIONING STRATEGIES\n\nPresent the candidate as a senior leader by:\n- Opening with a powerful Executive Summary that positions them as a strategic leader\n- Emphasizing board-level skills: governance, strategic planning, stakeholder management\n- Highlighting cross-functional leadership and organizational influence\n- Demonstrating thought leadership and industry expertise\n- Showcasing executive competencies: vision, execution, talent development, innovation\n\nðŸ‘‘ PREMIUM EXECUTIVE FORMATTING\n\n- Exceptional visual hierarchy and presentation\n- Executive Summary (5â€“7 lines of powerful positioning)\n- Leadership Competencies / Core Strengths (12â€“15 executive-level skills)\n- Executive Experience (5â€“8 high-impact bullets per role, focused on strategic outcomes)\n- Board Positions / Advisory Roles (if applicable)\n- Education & Executive Credentials\n- Publications / Speaking / Industry Recognition (if present)\n\nðŸ‘‘ SOPHISTICATED METRICS FRAMING\n\nWhen metrics are available, present them with executive context:\n- \"USD 5M budget\" becomes \"Directed USD 5M operational budget across 3 business units\"\n- \"Increased sales\" becomes \"Delivered 35% YoY revenue growth through strategic market expansion\"\n- \"Reduced costs\" becomes \"Optimized operational efficiency, achieving USD 800K annual cost savings\"\n\nðŸ‘‘ STRATEGIC KEYWORD INTEGRATION\n\nIncorporate executive-level terminology:\n- Strategic planning, business transformation, P&L ownership\n- Change management, organizational development, talent acquisition\n- Stakeholder engagement, executive leadership, cross-functional collaboration\n- Digital transformation, innovation strategy, competitive positioning\n- Risk management, governance, compliance, regulatory affairs\n\nOUTPUT RULES:\n- Return ONLY the executive-caliber CV\n- No markers, commentary, or explanations\n- C-suite ready, board-presentation quality\n- Polished, authoritative, and strategically positioned\n\n--- CANDIDATE NAME (SOURCE OF TRUTH) ---\n{{ .ctx?.candidateName || .candidateName || '' }}\n\n--- CANDIDATE CV (RAW TEXT) ---\n{{ .cvText || .ctx?.cvText || '' }}\n\n--- JOB DESCRIPTION ---\n{{ .jobDescription || .ctx?.jobDescription || '' }}"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        5664,
        336
      ],
      "id": "95e5eab9-54c5-4853-b9a9-25cc20a254fb",
      "name": "Executive - CV Rewrite (Claude Opus)"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "claude-opus-4-1-20250805",
          "mode": "list",
          "cachedResultName": "claude-opus-4-1-20250805"
        },
        "messages": {
          "values": [
            {
              "content": "â€œProvide a clean 2-page layout with sections: Header, Summary, Core Skills, Experience (reverse-chron), Education, Certifications. Use consistent spacing and uppercase headings.â€"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        6720,
        336
      ],
      "id": "89d19d87-0109-441b-af2f-464dcfae28a7",
      "name": "Executive - Format CV Layout"
    },
    {
      "parameters": {
        "jsCode": "// Mode: Run Once for All Items\nconst bin = $binary || {};\nconst keys = Object.keys(bin);\nconst outBin = { ...bin };\nif (keys.length && !bin.cv) {\n  outBin.cv = bin[keys[0]];   // copy first binary to 'cv'\n}\nreturn [{ json: $json, binary: outBin }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1728,
        96
      ],
      "id": "a196cca3-a897-4147-a85c-59f9ece365f0",
      "name": "Code"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferInput1"
            }
          },
          "includeUnpaired": false
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -832,
        -96
      ],
      "id": "b1cffb1d-9302-4076-b310-14c65458e22a",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "// Run Once for All Items\nconst b = $binary?.cv;\nlet ext = ($json.cvExt ?? '').toString().trim().toLowerCase();\n\nif (!ext && b?.fileName) {\n  const i = b.fileName.lastIndexOf('.');\n  if (i >= 0) ext = b.fileName.slice(i + 1).toLowerCase();\n}\nif (!ext && b?.mimeType) {\n  const map = {\n    'text/plain': 'txt',\n    'application/pdf': 'pdf',\n    'application/msword': 'doc',\n    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',\n  };\n  ext = map[(b.mimeType || '').toLowerCase()] || '';\n}\n\nreturn [{ json: { ...$json, cvExt: ext }, binary: $binary }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        -96
      ],
      "id": "d533e288-06b6-46d3-a883-50d5f37869c9",
      "name": "cvExt"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "28624ae2-9b34-4aaa-8c63-a7a7560f77ab",
              "name": "=fileType",
              "value": "={{\n  String(\n    $json.fileType         // if you already set it\n    || $json.cvExt\n    || $json.extResolved\n    || $json.fileExtension\n    || ($binary.cv  && $binary.cv.fileName  ? $binary.cv.fileName.split('.').pop()  : '')\n    || ($binary.cv0 && $binary.cv0.fileName ? $binary.cv0.fileName.split('.').pop() : '')\n    || ''\n  ).trim().toLowerCase()\n}}\n",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -384,
        -96
      ],
      "id": "3db94b6b-885b-4ae1-acb5-e4d6daf91cea",
      "name": "fileType"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferInput1"
            }
          }
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        512,
        48
      ],
      "id": "caa66110-27a6-426d-a9b8-476e0529f99d",
      "name": "Merge10"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferLast"
            }
          }
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1632,
        -336
      ],
      "id": "4b214f07-1655-4f72-8b4e-0889b852f028",
      "name": "Merge11"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "includeUnpaired": false
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3200,
        -48
      ],
      "id": "e799e8bd-bd17-4786-8e2b-4660b555e91a",
      "name": "Merge: Ready to Upload"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "06986433-eb0c-4d1d-a79c-4915fd219db7",
              "name": "=orderId",
              "value": "={{$node[\"Update Order\"].json.orderId}}",
              "type": "string"
            },
            {
              "id": "8fa49e82-fe5d-4ffd-b6ab-f30fc0a3d9af",
              "name": "=cv_orig_key",
              "value": "={{$node[\"Remember cv_orig_key\"].json.cv_orig_key}}",
              "type": "string"
            },
            {
              "id": "97cd22bd-3376-49ed-875a-e58734e52d02",
              "name": "=ok",
              "value": "true",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2976,
        -400
      ],
      "id": "b3f63476-32a3-4a0b-b788-cec75ac4d87f",
      "name": "Ack AddDoc"
    },
    {
      "parameters": {
        "jsCode": "// Build Addon Rows (preserve binary)\n// Mode: Run Once for All Items â€¢ Language: JavaScript\nconst itemsIn = $input.all();\n\nreturn itemsIn.map(item => {\n  const prices =\n    (item.json._cfg && item.json._cfg.addonPrices) || {\n      extracoverletter: 299,\n      oneday: 399,\n      editableword: 499,\n      linkedin: 1000,\n      linkedinoptimize: 1000,\n    };\n\n  const addons = Array.isArray(item.json.addons) ? item.json.addons : [];\n  const addonRows = addons.map(code => ({\n    code,\n    price_cents: prices[code] ?? null,\n  }));\n\n  return {\n    json: { ...item.json, addonRows },\n    binary: item.binary,          // ðŸ‘ˆ keep existing binary (includes cv)\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2624,
        384
      ],
      "id": "53144cdb-8f1c-4ebc-b346-e0db08bac93d",
      "name": "Add Ons"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH params AS (\n  SELECT\n    ($1::jsonb->>'order_id')::uuid           AS order_id,\n    COALESCE(($1::jsonb->>'has_linkedin')::boolean, false)            AS has_linkedin,\n    COALESCE(($1::jsonb->>'has_extra_cover_letter')::boolean, false)  AS has_extra_cover_letter,\n    COALESCE(($1::jsonb->>'needs_editable_word')::boolean, false)      AS needs_editable_word,\n    COALESCE(($1::jsonb->>'is_one_day_delivery')::boolean, false)      AS is_one_day_delivery\n),\nupd AS (\n  UPDATE public.orders o\n  SET\n    has_linkedin           = p.has_linkedin,\n    has_extra_cover_letter = p.has_extra_cover_letter,\n    needs_editable_word    = p.needs_editable_word,\n    is_one_day_delivery    = p.is_one_day_delivery,\n    sla_due_at             = CASE WHEN p.is_one_day_delivery\n                                  THEN NOW() + interval '24 hours'\n                                  ELSE o.sla_due_at END\n  FROM params p\n  WHERE o.id = p.order_id\n  RETURNING o.id AS order_id, o.status, o.has_linkedin,\n            o.has_extra_cover_letter, o.needs_editable_word,\n            o.is_one_day_delivery, o.sla_due_at\n)\nSELECT *, 'updated' AS outcome FROM upd\nUNION ALL\nSELECT p.order_id, NULL AS status, p.has_linkedin, p.has_extra_cover_letter,\n       p.needs_editable_word, p.is_one_day_delivery, NULL::timestamptz AS sla_due_at,\n       'not_found' AS outcome\nFROM params p\nWHERE NOT EXISTS (SELECT 1 FROM upd);",
        "options": {
          "queryReplacement": "=={{ JSON.stringify({\n  order_id: $node[\"Update Order\"].json.order_id || $json.orderId,\n  has_linkedin: $json.hasLinkedIn ?? false,\n  has_extra_cover_letter: $json.hasExtraCoverLetter ?? false,\n  needs_editable_word: $json.needsEditableWord ?? false,\n  is_one_day_delivery: $json.isOneDayDelivery ?? false\n}) }}\n\n\n\n"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1408,
        -48
      ],
      "id": "c17d32e3-bd56-4e73-8741-ff3245ab8e4e",
      "name": "Upsert Order Flags"
    },
    {
      "parameters": {
        "jsCode": "return $input.all().map(item => {\n  return {\n    json: item.json,       // keep the scan result\n    binary: item.binary    // carry forward the CV\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1280,
        96
      ],
      "id": "a4495c79-3458-462f-a814-54085b8752de",
      "name": "Restore Binary"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "0b779fb2-ee9d-41a7-afca-f3c7cecc30ed",
              "leftValue": "={{ $json.ctx.flags.linkedIn }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        14528,
        -208
      ],
      "id": "f4735c80-7480-4e57-a3d0-d9fcfa40cf5b",
      "name": "LinkedIn Optimization1"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "messages": {
          "values": [
            {
              "content": "You are a professional LinkedIn profile strategist.\n\nHARD RULES:\n- Output VALID JSON ONLY (no markdown fences).\n- No placeholders like [Name], <Company>, {TBD}. Use the provided candidateName; if missing, omit.\n- Respect LinkedIn limits (Headline â‰¤ 220 chars, About â‰¤ 2000 chars, Experience entries â‰¤ 2000 chars each).\n- ATS/SEO friendly: include keywords from the job description naturally.\n- Confident, human voice. No â€œAs an AIâ€¦â€.\n",
              "role": "system"
            },
            {
              "content": "=Create a complete LinkedIn optimization based on the candidate's updated CV and the target job.\n\nInputs:\n- candidateName: \"{{$json.candidateName}}\"\n- Updated CV (final used for resume): \"{{ $json.ctx.rewrittenCVText || $json.ctx.cvText }}\"\n- Job Description: \"{{ $json.ctx.jobDescription }}\"\n\nReturn JSON exactly with this schema:\n{\n  \"headline\": \"string (<=220)\",\n  \"about\": \"string (<=2000)\",\n  \"experience\": [\n    {\n      \"title\": \"string\",\n      \"company\": \"string\",\n      \"location\": \"string (optional)\",\n      \"dateRange\": \"string (optional)\",\n      \"description\": \"string (<=2000, bullet-like lines)\"\n    }\n  ],\n  \"skills\": [\"string\", \"... up to 50\"],\n  \"keywords\": [\"string\", \"... prioritized\"],\n  \"featuredSuggestions\": [\n    {\"label\":\"string\",\"url\":\"string or empty\",\"note\":\"string optional\"}\n  ],\n  \"settingsChecklist\": [\n    \"Customize URL suggestion\",\n    \"Banner idea (visual theme + copy)\",\n    \"Profile photo notes\",\n    \"Open to Work toggles\",\n    \"Creator Mode (if relevant)\"\n  ]\n}\n"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        14752,
        -400
      ],
      "id": "5c30e2a0-6a8c-4be5-95e7-c95c20e9a0f3",
      "name": "LI Build Sections1"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Get the JSON object produced by the OpenAI node\nconst raw = $json.linkedin_profile;\nif (!raw) return { json: $json, binary: $binary };\nconst text = typeof raw === 'string' ? raw : JSON.stringify(raw, null, 2);\nconst data = Buffer.from(text, 'utf8').toString('base64');\nreturn {\n  json: $json,\n  binary: {\n    ...($binary || {}),\n    linkedin: { data, fileName: 'linkedin.json', mimeType: 'application/json' }\n  },\n};\n\nconst out = $json;\n\n// Regex to catch placeholders or AI disclaimers\nconst bad = /\\[.*?\\]|<.*?>|\\{.*?\\}|as an ai/i;\n\nfunction scrub(s) {\n  if (!s) return s;\n  return String(s).replace(/\\u200B/g, '').trim();\n}\n\n// If headline/about contains placeholder text, flag it\nif (bad.test(out.headline || '') || bad.test(out.about || '')) {\n  return [{\n    ...out,\n    liNeedsRepair: true\n  }];\n}\n\n// Enforce LinkedIn limits\nout.headline = scrub(out.headline).slice(0, 220);\nout.about = scrub(out.about).slice(0, 2000);\n\nif (Array.isArray(out.experience)) {\n  out.experience = out.experience.map(e => ({\n    ...e,\n    description: scrub(e.description || '').slice(0, 2000)\n  }));\n}\n\nif (Array.isArray(out.skills)) {\n  out.skills = out.skills.slice(0, 50);\n}\n\nreturn [{\n  ...out,\n  liNeedsRepair: false\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        15296,
        -400
      ],
      "id": "ebe03950-833e-41b2-9e86-80e82ca19aa4",
      "name": "Validate & Clean2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c013366d-a353-4530-8f5f-f3da86fa616a",
              "name": "=cvRewriteKey",
              "value": "={{ 'orders/' + $json.orderId + '/cv_rewritten.txt' }}",
              "type": "string"
            },
            {
              "id": "425fe294-ca91-4e66-9688-3ca6571a2940",
              "name": "=coverLetterKey",
              "value": "={{ 'orders/' + $json.orderId + '/cover_letter.txt' }}",
              "type": "string"
            },
            {
              "id": "8bb38c2f-ee4d-48a6-873d-34bea5b63880",
              "name": "=linkedinKey",
              "value": "={{ 'orders/' + $json.orderId + '/linkedin.json' }}",
              "type": "string"
            },
            {
              "id": "22c2be45-3e48-463e-bb0b-85caf5717639",
              "name": "=bucket",
              "value": "={{$json._cfg.bucket}}",
              "type": "string"
            },
            {
              "id": "67b8da41-c087-40a3-ab01-6122edbcfe1c",
              "name": "=schema",
              "value": "={{$json._cfg.pgSchema || 'public'}}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3424,
        -48
      ],
      "id": "f4fb7ba0-f720-4a1d-aa6c-0e14f8ef1c25",
      "name": "Build Keys"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a231b1eb-a02b-486e-ab77-03efdf9b53b6",
              "name": "=joinKey",
              "value": "={{\n(\n  $items(\"Switch\", 0)[0]?.json?.ctx?.orderId\n  || $items(\"Switch\", 0)[0]?.json?.orderId\n  || $json.joinKey\n  || $json.ctx?.orderId\n  || $json.orderId\n  || $json.order_id\n  || ''\n).toString().trim().replace(/^=/,'')\n}}",
              "type": "string"
            },
            {
              "id": "2d2982d6-5868-4193-bbc5-48f8cec183b1",
              "name": "=cvRewriteText",
              "value": "={{\n(() => {\n  const c = $json.choices?.[0]?.message?.content;\n\n  if (typeof c === 'string') return c.trim();\n  if (!c || typeof c !== 'object') return '';\n\n  const out = [];\n  const push = (title, body) => {\n    const t = String(title || '').trim();\n    const b = String(body || '').trim();\n    if (t && b) out.push(`**${t}**\\n${b}`);\n  };\n\n  push('Professional Summary', c['Professional Summary']);\n  push('Core Skills', c['Core Skills']);\n  push('Professional Experience', c['Professional Experience']);\n  push('Education', c['Education']);\n  push('Certifications', c['Certifications']);\n  push('Tools & Platforms', c['Tools & Platforms']);\n  push('Projects', c['Projects']);\n  push('Awards', c['Awards']);\n\n  return out.join('\\n\\n').trim();\n})()\n}}",
              "type": "string"
            },
            {
              "id": "0cc4e300-ae4e-45d4-b405-fd2bdf9d9f14",
              "name": "=ctx",
              "value": "={{\n(() => {\n  // Always use the pre-AI payload as the source of truth\n  const src =\n    $items(\"Switch\", 0)[0]?.json\n    || $items(\"Context (carry)\", 0)[0]?.json\n    || $json\n    || {};\n\n  const ctx0 =\n    (src.ctx && typeof src.ctx === 'object') ? src.ctx : {};\n\n  // --- Build the rewritten text (string) from the AI output ---\n  const c = $json.choices?.[0]?.message?.content;\n\n  const buildText = () => {\n    // If model returned plain text, use it\n    if (typeof c === 'string') return c.trim();\n    // If model returned an object, build a single ATS-friendly string\n    if (!c || typeof c !== 'object') return '';\n\n    const out = [];\n    const push = (title, body) => {\n      const t = String(title || '').trim();\n      const b = String(body || '').trim();\n      if (t && b) out.push(`**${t}**\\n${b}`);\n    };\n\n    push('Professional Summary', c['Professional Summary']);\n    push('Core Skills', c['Core Skills']);\n    push('Professional Experience', c['Professional Experience']);\n    push('Education', c['Education']);\n    push('Certifications', c['Certifications']);\n    push('Tools & Platforms', c['Tools & Platforms']);\n    push('Projects', c['Projects']);\n    push('Awards', c['Awards']);\n\n    return out.join('\\n\\n').trim();\n  };\n\n  const rewritten = buildText();\n\n  // Ensure addons are always an array\n  const addons =\n    Array.isArray(ctx0.addons) ? ctx0.addons\n    : Array.isArray(src.addons) ? src.addons\n    : (typeof src.addons === 'string' && src.addons.trim())\n      ? src.addons.split(',').map(x => x.trim().toLowerCase()).filter(Boolean)\n      : [];\n\n  return {\n    // Preserve everything previously captured\n    ...ctx0,\n\n    // Fill any missing ctx fields from src\n    orderId: ctx0.orderId || src.orderId || src.order_id || src.joinKey || '',\n    email: ctx0.email || src.email || '',\n    candidateName: ctx0.candidateName || src.candidateName || '',\n    package: ctx0.package || src.package || src.packageTier || '',\n    jobDescription: ctx0.jobDescription || src.jobDescription || src.jdText || '',\n\n    addons,\n    flags: (ctx0.flags && typeof ctx0.flags === 'object') ? ctx0.flags : (src.flags || {}),\n\n    // Always set rewritten output\n    rewrittenCVText: rewritten,\n  };\n})()\n}}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "ignoreConversionErrors": false
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7072,
        -240
      ],
      "id": "d34b6538-77a8-483d-9fd5-126ae149166b",
      "name": "Capture Rewrite"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "19907287-39ae-4ad5-8381-17fd42b8716a",
              "name": "=hasExtraCoverLetter",
              "value": "={{ $json.hasExtraCoverLetterBool }}",
              "type": "boolean"
            },
            {
              "id": "4fa9445d-b39e-4b42-aba6-8b2e82950ceb",
              "name": "=hasLinkedIn",
              "value": "={{ $json.hasLinkedInBool }}",
              "type": "boolean"
            },
            {
              "id": "9d84fe68-1205-4f85-a059-fa34801a7408",
              "name": "=needsEditableWord",
              "value": "={{ $json.needsEditableWordBool }}",
              "type": "boolean"
            },
            {
              "id": "55a75451-05b2-44ac-8c61-840340c6cb47",
              "name": "=pkgStarter",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'starter' }}",
              "type": "boolean"
            },
            {
              "id": "39f3d2cf-18c3-41e8-a926-3a9f17b1ef63",
              "name": "=pkgStandard",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'standard' }}",
              "type": "boolean"
            },
            {
              "id": "c65399f1-dd0a-413a-a177-e4401a1dfe85",
              "name": "=pkgPremium",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'premium' }}",
              "type": "boolean"
            },
            {
              "id": "e275f793-2850-4364-ab3a-6a3839732a3c",
              "name": "=pkgExecutive",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'executive' }}",
              "type": "boolean"
            },
            {
              "id": "b4f74133-439c-4d68-8716-e904ce013686",
              "name": "=isOneDayDelivery",
              "value": "={{ $json.isOneDayDeliveryBool }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4320,
        -48
      ],
      "id": "1e6fc543-2418-4d4f-83bf-8c4a8557a3b9",
      "name": "Flags"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "19907287-39ae-4ad5-8381-17fd42b8716a",
              "name": "=pkgStarter",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'starter' }}",
              "type": "boolean"
            },
            {
              "id": "4fa9445d-b39e-4b42-aba6-8b2e82950ceb",
              "name": "=pkgStandard",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'standard' }}",
              "type": "boolean"
            },
            {
              "id": "9d84fe68-1205-4f85-a059-fa34801a7408",
              "name": "=pkgPremium",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'premium' }}",
              "type": "boolean"
            },
            {
              "id": "c80b1412-ceed-48e4-8bf8-2501ab7fad6d",
              "name": "=pkgExecutive",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'executive' }}",
              "type": "boolean"
            },
            {
              "id": "19de60f6-7ae6-43a0-9b23-be98654e1d7c",
              "name": "=entCoverLetter",
              "value": "={{ ($json.pkgStandard || $json.pkgPremium || $json.pkgExecutive) || ($json.hasExtraCoverLetter ?? false) }}",
              "type": "boolean"
            },
            {
              "id": "833e2332-ee4a-4869-8a21-942f3dc9a23e",
              "name": "=entDocxLayout",
              "value": "={{ $json.pkgExecutive || ($json.needsEditableWord ?? false) }}",
              "type": "boolean"
            },
            {
              "id": "3db18bf2-adc9-462e-a0ed-6292e948ff88",
              "name": "=entLinkedIn",
              "value": "={{ $json.hasLinkedIn ?? false }}",
              "type": "boolean"
            },
            {
              "id": "2cf79c32-8f72-4cb5-9714-94acbc67d24b",
              "name": "=entRewrite",
              "value": "={{ true }}",
              "type": "boolean"
            },
            {
              "id": "4f9619a0-127a-47fb-b156-11bed4aa9630",
              "name": "=entPriority",
              "value": "={{ $json.pkgExecutive || ($json.isOneDayDelivery ?? false) }}",
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4544,
        -48
      ],
      "id": "9743cac1-588b-4aa1-b97c-636adbc95993",
      "name": "Entitlements"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "21de95fc-558b-4b4e-9270-a20e3f9805c8",
              "name": "=rewriteModel",
              "value": "={{ $json.pkgPremium || $json.pkgExecutive ? 'gpt-4o' : 'gpt-4o-mini' }}",
              "type": "string"
            },
            {
              "id": "5399bb9a-d8a8-4b71-9af5-4409fcc1c688",
              "name": "=rewriteTemp",
              "value": "={{ $json.pkgExecutive ? 0.6 : ($json.pkgPremium ? 0.5 : 0.4) }}",
              "type": "string"
            },
            {
              "id": "0d2e11d0-b450-4255-aa8c-ec31ad9af1d5",
              "name": "=maxTokens",
              "value": "={{ $json.pkgExecutive ? 4000 : 2500 }}",
              "type": "string"
            },
            {
              "id": "2dbc9126-4e63-41de-a2d4-81e176f21386",
              "name": "=packageTier",
              "value": "={{ $json.packageTier || $json.package || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4768,
        -48
      ],
      "id": "21f6e1e1-2aa2-45a2-afc7-73ef00f62b2f",
      "name": "Model & Prompt Params (Package - Model)"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ ($json.packageTier || $json.package || '') .toString().trim().toLowerCase() }}",
                    "rightValue": "starter",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "12afe657-01b2-4538-a382-d471d3b8a93c"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8ed0472a-4349-4d0c-b716-81b67fe29aa5",
                    "leftValue": "={{ ($json.packageTier || $json.package || '') .toString().trim().toLowerCase() }}",
                    "rightValue": "standard",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e54d25dd-c349-4650-b620-620f50ea229b",
                    "leftValue": "={{ ($json.packageTier || $json.package || '') .toString().trim().toLowerCase() }}",
                    "rightValue": "premium",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "07f6ef09-b47d-447c-8109-2c60f20e080a",
                    "leftValue": "={{ ($json.packageTier || $json.package || '') .toString().trim().toLowerCase() }}",
                    "rightValue": "executive",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9cfe8e1a-112f-4a38-bcbe-b93c899291cc",
                    "leftValue": "={{ true }}",
                    "rightValue": "true",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        5440,
        -96
      ],
      "id": "7008d67e-a85c-4c9e-a0a9-093cd57d2786",
      "name": "Switch"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9c4c618c-3224-484c-8f7c-707f7f547db8",
              "name": "=coverLetterText",
              "value": "={{\n  (\n    $json.coverLetterText\n    || $json.choices?.[0]?.message?.content\n    || $json.message?.content\n    || ''\n  ).toString().trim()\n}}",
              "type": "string"
            },
            {
              "id": "0684932c-68cf-463f-a62b-dde2359f93c3",
              "name": "=ctx",
              "value": "={{ (() => {   const src =     $json.ctx     || $items(\"Extra Cover Letter\", 0)[0]?.json?.ctx     || $items(\"Switch\", 0)[0]?.json?.ctx     || {};    const base = (src && typeof src === 'object') ? src : {};    return {     ...base,     coverLetterText:       (typeof $json.choices?.[0]?.message?.content === 'string'         ? $json.choices?.[0]?.message?.content.trim()         : (typeof $json.message?.content === 'string'             ? $json.message.content.trim()             : base.coverLetterText || ''           )       )   }; })() }}",
              "type": "object"
            },
            {
              "id": "1c168e61-4e0e-45af-8bbc-f6b295e27065",
              "name": "=joinKey",
              "value": "={{ (   $json.joinKey   || $json.ctx?.orderId   || $items(\"Extra Cover Letter\", 0)[0]?.json?.joinKey   || $items(\"Extra Cover Letter\", 0)[0]?.json?.ctx?.orderId   || $items(\"Switch\", 0)[0]?.json?.ctx?.orderId   || '' ).toString().trim().replace(/^=/,'') }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        12272,
        -400
      ],
      "id": "f583a0e9-12ef-466e-b403-aada04cda2f2",
      "name": "Capture Cover Letter"
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "={{ $json._cfg?.bucket || $json.ctx?._cfg?.bucket || 'careeredge-orders' }}",
        "fileName": "={{\n  `orders/${($json.orderId || $json.joinKey || $json.ctx?.orderId || '').toString().trim().replace(/^=/,'')}/cover_letter.pdf`\n}}",
        "binaryPropertyName": "coverLetter",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.awsS3",
      "typeVersion": 2,
      "position": [
        13584,
        -400
      ],
      "id": "a23c1368-a9e2-44fb-ab92-9c3201a0c542",
      "name": "Upload CoverLetter1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.documents (order_id, kind, storage_key)\nVALUES ($1::uuid, 'cover_letter', $2)\nON CONFLICT (order_id, kind) DO UPDATE\nSET storage_key = EXCLUDED.storage_key;",
        "options": {
          "queryReplacement": "={{ [\n  ($json.ctx?.orderId || $json.orderId || $json.joinKey),\n  ($json.coverLetterKey || $json.Key || `orders/${$json.ctx?.orderId || $json.orderId || $json.joinKey}/cover_letter.pdf`)\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        14288,
        -272
      ],
      "id": "a3af7332-dcb9-49b7-aa98-c180b74ce8e0",
      "name": "Postgres - Add Doc(cover)1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "11d9d90d-863b-487b-a601-233e2c84d8c3",
              "name": "hasLinkedIn",
              "value": "={{   (() => {     if (typeof $json.hasLinkedIn === 'boolean') return $json.hasLinkedIn;     const a = $json.addons;     const arr = Array.isArray(a)       ? a       : (typeof a === 'string' && a.trim())         ? (a.trim().startsWith('[')             ? JSON.parse(a)             : a.split(',').map(s => s.trim()))         : [];     return arr.includes('linkedinoptimize');   })() }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        15072,
        -400
      ],
      "id": "2ca4fdf0-eee7-486a-b93d-55c313bc2213",
      "name": "Capture LinkedIn"
    },
    {
      "parameters": {
        "jsCode": "const text = String($json.cvRewriteText || $json.cvText || '');\nconst esc = (s) => s\n  .replace(/&/g, '&amp;')\n  .replace(/</g, '&lt;')\n  .replace(/>/g, '&gt;');\nconst html =\n  `<html><meta charset=\"utf-8\"><body style=\"font-family:Calibri,Arial; white-space:pre-wrap;\">${esc(text)}</body></html>`;\nreturn {\n  json: {\n    ...$json,\n    cvDocHtmlBase64: Buffer.from(html, 'utf8').toString('base64'),\n  },\n  binary: $binary\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16432,
        -368
      ],
      "id": "60db25c3-c474-4281-850d-d5a666e62d74",
      "name": "Build HTML"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.cloudconvert.com/v2/jobs",
        "authentication": "genericCredentialType",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type:",
              "value": "application/jso"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "value": "={   \"tasks\": {     \"import\": {       \"operation\": \"import/base64\",       \"file\": \"{{$json.cvDocHtmlBase64}}\",       \"filename\": \"cv.html\"     },     \"convert\": {       \"operation\": \"convert\",       \"input\": \"import\",       \"input_format\": \"html\",       \"output_format\": \"docx\"     },     \"export\": {       \"operation\": \"export/url\",       \"input\": \"convert\"     }   } }"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        16672,
        -368
      ],
      "id": "ee1ef7ac-5782-46cf-bb0f-be8af251e1d6",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "url": "={{    JSON.parse($json.body || $json.response || '{}')     .data?.tasks?.find(t => t.name === 'export')?.result?.files?.[0]?.url      || $json.data?.tasks?.find(t => t.name === 'export')?.result?.files?.[0]?.url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        16880,
        -368
      ],
      "id": "5a5aa37a-b2b1-4436-8551-ba659cf0704a",
      "name": "HTTP Request2"
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "={{$json.bucket || $json._cfg.bucket}}",
        "fileName": "={{ 'orders/' + $json.orderId + '/cv_rewritten.docx' }}",
        "binaryPropertyName": "cvDocx",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.awsS3",
      "typeVersion": 2,
      "position": [
        17104,
        -368
      ],
      "id": "683753f4-7e43-4491-9ccf-5beb3a28d63d",
      "name": "Upload DOCX"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.documents (order_id, kind, storage_key) VALUES ($1::uuid, 'cv_rewrite_docx', $2) ON CONFLICT (order_id, kind) DO UPDATE SET storage_key = EXCLUDED.storage_key;",
        "options": {
          "queryReplacement": "={{ [ $json.orderId, 'orders/' + $json.orderId + '/cv_rewritten.docx' ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        17328,
        -368
      ],
      "id": "a70d454b-a9f9-457f-bc59-27a1f576bdc2",
      "name": "Postgres - Add Doc1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1c37f72a-a0cc-49a4-8f9c-fa849b64c4c1",
              "name": "sla",
              "value": "'1-day'",
              "type": "string"
            },
            {
              "id": "d1305341-7d12-4c11-9a2f-4b7cb4f69843",
              "name": "priorityFlag",
              "value": "true",
              "type": "string"
            },
            {
              "id": "bf2fc9f5-30a3-46d8-a2be-34fc17de6da5",
              "name": "dueDate",
              "value": "={{ new Date(Date.now() + 24*60*60*1000).toISOString() }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        18016,
        -352
      ],
      "id": "2e0ac0b5-44e3-483f-a297-f9f249d02e59",
      "name": "SLA MetaData"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE public.orders SET priority = true, sla = '1-day', due_date = $1::timestamptz WHERE id = $2::uuid;",
        "options": {
          "queryReplacement": "={{ [ $json.dueDate, $json.orderId ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        18224,
        -352
      ],
      "id": "238b3c67-7c7e-460c-8479-257be19c33b7",
      "name": "Postgres - Update Order Priority"
    },
    {
      "parameters": {
        "jsCode": "// Expected upstream: either an array on $json.docs or individual fields.\n// We normalise into: json.documents, json.keys, json.urls\n\nconst j = { ...$json };\n\n// Collect keys from various places\nconst docMap = {};  // kind -> storage_key\n\n// 1) from docs[]\nif (Array.isArray(j.docs)) {\n  for (const d of j.docs) {\n    if (d && d.kind && d.storage_key) docMap[d.kind] = d.storage_key;\n  }\n}\n\n// 2) from flat fields (fallbacks)\nif (j.cvRewriteKey)   docMap.cv_rewritten      = String(j.cvRewriteKey).replace(/^`+|`+$/g,'');\nif (j.coverLetterKey) docMap.cover_letter      = String(j.coverLetterKey).replace(/^`+|`+$/g,'');\nif (j.linkedinKey)    docMap.linkedin_profile  = String(j.linkedinKey).replace(/^`+|`+$/g,'');\n\n// Fix any \"orders/null/...\" mistakes\nObject.keys(docMap).forEach(k => {\n  if (/\\/null\\//.test(docMap[k])) {\n    const oid = j.orderId || j.order_id || '';\n    if (oid) docMap[k] = docMap[k].replace('/null/', `/${oid}/`);\n  }\n});\n\n// Build public URLs (public bucket)\nconst BUCKET = j._cfg?.bucket || 'careeredge-orders';\nconst projectRef = '<YOUR-PROJECT-REF>'; // OPTIONAL: you can hard-code your Supabase ref here.\nconst PUBLIC_BASE = `https://${projectRef}.supabase.co/storage/v1/object/public/${BUCKET}/`;\n\nconst urlFromKey = (key) =>\n  key ? (key.startsWith('http') ? key : (PUBLIC_BASE + key.replace(/^\\/+/, ''))) : '';\n\n// Urls with sensible fallbacks\nconst urls = {\n  cv:          urlFromKey(docMap.cv_rewritten)      || j.cvUrl          || j.cv_rewrite_url   || '',\n  coverLetter: urlFromKey(docMap.cover_letter)      || j.coverLetterUrl || j.cover_letter_url || '',\n  linkedin:    urlFromKey(docMap.linkedin_profile)  || j.linkedinUrl    || j.linkedin_url     || '',\n  docx:        urlFromKey(docMap.cv_rewrite_docx)   || j.docxUrl        || j.docx_url         || '',\n  rtf:         urlFromKey(docMap.cv_rewrite_rtf)    || j.rtfUrl         || j.rtf_url          || '',\n};\n\n// Keys object for Sheets/DB\nconst keys = {\n  cv:          docMap.cv_rewritten      || '',\n  coverLetter: docMap.cover_letter      || '',\n  linkedin:    docMap.linkedin_profile  || '',\n  docx:        docMap.cv_rewrite_docx   || '',\n  rtf:         docMap.cv_rewrite_rtf    || '',\n};\n\nreturn {\n  json: {\n    ...j,\n    documents: docMap,\n    urls,\n    keys,\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        19136,
        -192
      ],
      "id": "d9ac3603-00cd-41b3-b4d7-825489e2f3d5",
      "name": "Shape Documents Map"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT kind, storage_key FROM public.documents WHERE order_id = $1::uuid ORDER BY kind;",
        "options": {
          "queryReplacement": "={{ [ $json.orderId ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        18912,
        -336
      ],
      "id": "63bd93ed-1d7f-4e9f-ab7f-335026459fcb",
      "name": "List Documents for Order"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH p AS (\n  SELECT\n    ($1::jsonb->>'order_id')::uuid         AS order_id,\n    COALESCE(($1::jsonb->>'priority')::boolean, false) AS new_priority\n),\nupd AS (\n  UPDATE public.orders o\n  SET\n    status       = 'done',\n    completed_at = now(),\n    priority     = COALESCE(o.priority, p.new_priority)\n  FROM p\n  WHERE o.id = p.order_id\n  RETURNING o.id AS order_id, o.status, o.priority, o.completed_at\n)\nSELECT * FROM upd;",
        "options": {
          "queryReplacement": "=={{ JSON.stringify({\n  order_id:    ($json.orderId || '').trim(),\n  priority:    ($json.entPriorityBool ?? false)\n}) }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        19808,
        -208
      ],
      "id": "e02814c5-9184-4d8f-9744-37ad957d17f7",
      "name": "Mark Order Done"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4fa9445d-b39e-4b42-aba6-8b2e82950ceb",
              "name": "=jobDescription",
              "value": "={{$json.jobDescription   || $node[\"Sanitize JD\"]?.json.jdText   || $node[\"Normalise & Validate\"]?.json.jobDescription   || ''}}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3872,
        -48
      ],
      "id": "44c49b56-699f-474f-9619-7ba0b1e8f94e",
      "name": "Normalize String"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Normalize add-on flags to real booleans and avoid name clashes\nconst toArr = (v) => Array.isArray(v) ? v.map(x => String(x).toLowerCase().trim()) : [];\nconst isTrueStr = (v) => typeof v === 'string' && v.trim().toLowerCase() === 'true';\n\nconst addons = toArr($json.addons || []);\n\nconst hasExtraCoverLetterBool =\n  $json.hasExtraCoverLetter === true || isTrueStr($json.hasExtraCoverLetter) ||\n  addons.includes('extracoverletter');\n\nconst hasLinkedInBool =\n  $json.hasLinkedIn === true || isTrueStr($json.hasLinkedIn) ||\n  addons.includes('linkedin') || addons.includes('linkedinoptimize');\n\nconst needsEditableWordBool =\n  $json.needsEditableWord === true || isTrueStr($json.needsEditableWord) ||\n  addons.includes('editableword');\n\nconst isOneDayDeliveryBool =\n  $json.isOneDayDelivery === true || isTrueStr($json.isOneDayDelivery) ||\n  addons.includes('oneday');\n\nreturn {\n  json: {\n    ...$json,\n    // write NEW keys to avoid conflicts with any incoming string fields\n    hasExtraCoverLetterBool,\n    hasLinkedInBool,\n    needsEditableWordBool,\n    isOneDayDeliveryBool,\n  },\n  binary: $binary,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4096,
        -48
      ],
      "id": "2ed0d364-364a-4e5e-8b56-19500a060324",
      "name": "Normalize - Addon Flags to Boolean"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3414014b-cebc-48e5-8301-2cfce76191de",
              "leftValue": "={{ ($json.schema || '').trim() }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "df46ca21-1861-48ee-9212-a6e6b8a1af24",
              "leftValue": "={{ ($json.orderId || '').trim() }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        18688,
        -208
      ],
      "id": "10eec019-ea32-40a2-8e48-768084888ca6",
      "name": "Validate - Has Schema and OrderId"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "373e5942-251d-47fb-bf01-02318df5efc0",
              "leftValue": "={{ !!$json.orderId }}",
              "rightValue": "=",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        19360,
        -208
      ],
      "id": "f7597d01-944d-4c45-8eca-138e49000871",
      "name": "Validate - Has OrderId"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c941e5eb-da03-472b-a498-174ea211bbaf",
              "name": "schema",
              "value": "={{ $json.schema || $json._cfg?.pgSchema || 'public' }}",
              "type": "string"
            },
            {
              "id": "e3e9164b-ee20-4a33-87d3-3d99d633e0f5",
              "name": "orderId",
              "value": "={{ $json.orderId || $node[\"Code - Ensure orderID\"]?.json.orderId || '' }}",
              "type": "string"
            },
            {
              "id": "9fa2cf8f-d8ea-417a-9ff3-8a99aac3e782",
              "name": "bucket",
              "value": "={{ $json.bucket || $json._cfg?.bucket || '' }}",
              "type": "string"
            },
            {
              "id": "b72e8587-f9c5-428f-9f21-33e6f5cec77b",
              "name": "entPriorityBool",
              "value": "={{ ($json.entPriority === true) || (typeof $json.entPriority === 'string' && $json.entPriority.trim().toLowerCase() === 'true') }}",
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        19584,
        -208
      ],
      "id": "8d9afbd2-7b05-412c-9513-329e372ab3b6",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "55305d5c-5141-4752-b151-184c0acaaf98",
              "leftValue": "={{ /^[0-9a-f-]{36}$/i.test(($json.orderId || '').trim()) }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3744,
        384
      ],
      "id": "0b6c0f0d-3c00-473e-b550-2485aa7544be",
      "name": "If UUID"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c013366d-a353-4530-8f5f-f3da86fa616a",
              "name": "=cvOrigKey",
              "value": "={{ 'orders/' + $json.orderId + '/cv_original.' + ($json.cvExt || 'txt') }}",
              "type": "string"
            },
            {
              "id": "425fe294-ca91-4e66-9688-3ca6571a2940",
              "name": "=cvRewriteKey",
              "value": "={{ 'orders/' + $json.orderId + '/cv_rewritten.txt' }}",
              "type": "string"
            },
            {
              "id": "8bb38c2f-ee4d-48a6-873d-34bea5b63880",
              "name": "=coverLetterKey",
              "value": "={{ 'orders/' + $json.orderId + '/cover_letter.txt' }}",
              "type": "string"
            },
            {
              "id": "22c2be45-3e48-463e-bb0b-85caf5717639",
              "name": "=bucket",
              "value": "={{ $json.bucket || $json._cfg?.bucket }}",
              "type": "string"
            },
            {
              "id": "67b8da41-c087-40a3-ab01-6122edbcfe1c",
              "name": "=schema",
              "value": "={{ $json.schema || $json._cfg?.pgSchema || 'public' }}",
              "type": "string"
            },
            {
              "id": "5ef57e91-886f-4335-bcbc-c29d79cc2bc1",
              "name": "=linkedinKey",
              "value": "={{ 'orders/' + $json.orderId + '/linkedin.txt' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3072,
        384
      ],
      "id": "2729a61d-1e5b-4ecf-9151-aa897034b350",
      "name": "Build Keys1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "43f25895-896b-48da-a6a3-41b60dea3f75",
              "name": "=orderId",
              "value": "={{ $json.orderId || $json.rows?.[0]?.orderId || $json.id || '' }}",
              "type": "string"
            },
            {
              "id": "de75ab4c-a642-493e-8e99-efc542eeaf6f",
              "name": "=extId",
              "value": "={{ $json.extId   || $json.rows?.[0]?.extId   || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3296,
        320
      ],
      "id": "1082b06d-65ac-4f7b-b944-e430963193da",
      "name": "Capture orderId"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "insert into public.orders (ext_id, package, addons, email)\nvalues ($1, $2, $3::jsonb, $4)\non conflict (ext_id) do update\n  set package = excluded.package,\n      addons  = excluded.addons,\n      email   = coalesce(excluded.email, orders.email)\nreturning id as \"orderId\", ext_id as \"extId\";",
        "options": {
          "queryReplacement": "={{ [\n  // $1 ext_id\n  ($json.orderId ?? $json.sessionId ?? $json.extId ?? $json.verifiedOrderId ?? null),\n\n  // $2 package\n  String($json.package ?? $json.packageTier ?? '').trim() || null,\n\n  // $3 addons (jsonb)\n  JSON.stringify(Array.isArray($json.addons) ? $json.addons : []),\n\n  // $4 email\n  ($json.email ? String($json.email).trim() : null)\n] }}\n"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3520,
        320
      ],
      "id": "4ec28243-9bed-4214-a738-55b79ada2183",
      "name": "Upsert Order"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Param bundle: $1 JSON with { orderId, sessionId }\nWITH params AS (\n  SELECT\n    ($1::jsonb->>'orderId')::uuid AS order_id,\n    NULLIF($1::jsonb->>'sessionId','')::text AS session_id\n),\nupd AS (\n  UPDATE public.orders o\n  SET\n    status = 'processing',\n    stripe_session_id = COALESCE(p.session_id, o.stripe_session_id)\n  FROM params p\n  WHERE o.id = p.order_id\n  RETURNING o.id AS order_id, o.status, o.stripe_session_id\n)\n-- If UPDATE matched, return the updated row.\nSELECT order_id, status, stripe_session_id, 'updated' AS outcome\nFROM upd\nUNION ALL\n-- Otherwise emit a synthetic row so n8n always has output.\nSELECT p.order_id,\n       'processing'::text AS status,\n       p.session_id::text AS stripe_session_id,\n       'not_found' AS outcome\nFROM params p\nWHERE NOT EXISTS (SELECT 1 FROM upd);",
        "options": {
          "queryReplacement": "=={{ JSON.stringify({ orderId: $json.orderId, sessionId: $json.sessionId ?? null }) }}\n"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1184,
        -48
      ],
      "id": "d6245951-caa6-4a05-8b49-a661aca7b238",
      "name": "Update Order"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "claude-sonnet-4-20250514",
          "mode": "list",
          "cachedResultName": "claude-sonnet-4-20250514"
        },
        "messages": {
          "values": [
            {
              "content": "You are a professional career coach. Write a professionally written, concise, tailored and compelling cover letter. Use a confident tone suitable for competitive roles.\nClear 4-part structure:\n\nOpening aligned to role\n\nValue proposition\n\nRelevant achievements\n\nConfident close\n\nNo fictional achievements\n\nClean, formal tone\n\nNo placeholders"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        6720,
        -48
      ],
      "id": "35dcf546-92aa-4f97-9f3a-f1dd916c0b30",
      "name": "Cover Letter Rewrite"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "claude-sonnet-4-20250514",
          "mode": "list",
          "cachedResultName": "claude-sonnet-4-20250514"
        },
        "messages": {
          "values": [
            {
              "content": "You are a professional career coach. Write concise and compelling cover letters. Use a confident tone suitable for competitive roles.\nADVANCED COVER LETTER\n\nThe Premium-tier cover letter should feel:\n\nMore persuasive\n\nMore strategically positioned\n\nMore clearly aligned to employer business goals\n\nMore polished in tone\n\n180â€“250 words."
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        6368,
        144
      ],
      "id": "0097be4c-fe39-4b37-8071-4dffc144d90e",
      "name": "Cover Letter Rewrite1"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "claude-opus-4-1-20250805",
          "mode": "list",
          "cachedResultName": "claude-opus-4-1-20250805"
        },
        "messages": {
          "values": [
            {
              "content": "You are a professional career coach. Write concise and compelling cover letters. Use a confident tone suitable for competitive roles.\n\nWrite a leadership-level cover letter (180â€“250 words):\n\nStrong opening positioning\n\nFocus on strategic value\n\nHigh-impact accomplishments (only if real)\n\nLeadership alignment with employer needs\n\nConfident, polished close"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        6016,
        336
      ],
      "id": "6b95ce4c-fc15-46af-835a-39c82590fa5c",
      "name": "Cover Letter Rewrite2"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Guard Node\n// Make sure this runs AFTER \"Extract from File1\"\n// and AFTER your JD normalisation nodes.\n\n// 0) Clone current json so we don't mutate $json directly\nconst j = { ...$json };\n\n// ------------------------------------------\n// Helper: safely read cvText from some node\n// ------------------------------------------\nfunction safeCvFrom(nodeName) {\n  try {\n    const n = $item(0).$node[nodeName]?.json;\n    if (!n) return '';\n    const v = n.cvText ?? n.text ?? '';\n    return typeof v === 'string' ? v : String(v || '');\n  } catch (e) {\n    return '';\n  }\n}\n\n// ------------------------------------------\n// 1) Resolve cvText\n// ------------------------------------------\nlet cvText = '';\n\n// a) If this item already has cvText and it's not a template artefact, use it\nif (typeof j.cvText === 'string') {\n  const trimmed = j.cvText.trim();\n  const looksLikeTemplate = trimmed.includes('{{$');\n  const looksLikeLabel = trimmed.startsWith('cvText (String) =');\n\n  if (trimmed && !looksLikeTemplate && !looksLikeLabel) {\n    cvText = trimmed;\n  }\n}\n\n// b) Otherwise, pull it from upstream extract nodes\nif (!cvText) {\n  // MAIN: your generic extractor for TXT uploads\n  const fromExtract = safeCvFrom('Extract from File1'); // <== make sure name matches exactly\n\n  // Fallbacks: old extract nodes if they exist in your workflow\n  const fromTxt  = safeCvFrom('TXT Field');\n  const fromPdf  = safeCvFrom('PDF - Text');\n  const fromDocx = safeCvFrom('DOCX - Text');\n  const fromDoc  = safeCvFrom('DOC - Text');\n\n  const rawCv = fromExtract || fromTxt || fromPdf || fromDocx || fromDoc || '';\n\n  cvText = String(rawCv).replace(/\\r\\n/g, '\\n').trim();\n}\n\n// c) If we STILL don't have CV text, fail loudly â€“ AI rewrite without CV is pointless\nif (!cvText) {\n  throw new Error(\n    \"[Guard] Missing cvText. Make sure 'Extract from File1' (or TXT/PDF/DOCX/DOC \" +\n    \"text nodes) run before this node and output a cvText field.\"\n  );\n}\n\n// ------------------------------------------\n// 2) Resolve jobDescription (keep your behaviour)\n// ------------------------------------------\nconst jobDescription =\n  j.jobDescription ||\n  $node['Sanitize JD']?.json?.jdText ||\n  $node['Normalise & Validate']?.json?.jobDescription ||\n  '';\n\nif (!jobDescription.trim()) {\n  console.warn(\n    '[Guard] jobDescription is empty for order',\n    j.orderId || j.order_id\n  );\n}\n\n// ------------------------------------------\n// 3) Return: keep everything, just ensure cvText + jobDescription are set\n// ------------------------------------------\nreturn {\n  json: {\n    ...j,\n    cvText,\n    jobDescription,\n  },\n  // pass through any binary (CV file etc.) unchanged\n  binary: $binary,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4992,
        -48
      ],
      "id": "8a2ba877-a0f6-482b-9e22-a1cbfbcad579",
      "name": "Guard Node1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH p AS (\n  SELECT\n    ($1::jsonb->>'orderId')::uuid                AS order_id,\n    NULLIF($1::jsonb->>'recipient','')           AS recipient,\n    NULLIF($1::jsonb->>'subject','')             AS subject,\n    NULLIF($1::jsonb->>'body_html','')           AS body_html,\n    COALESCE($1::jsonb->'payload', '{}'::jsonb)  AS payload\n),\nnorm AS (\n  SELECT\n    p.order_id,\n    COALESCE(p.recipient, NULLIF(o.customer_email, '')) AS recipient,\n    p.subject,\n    p.body_html,\n    p.payload\n  FROM p\n  LEFT JOIN public.orders o ON o.id = p.order_id\n)\nINSERT INTO public.email_jobs (order_id, recipient, subject, body_html, payload)\nSELECT order_id, recipient, subject, body_html, payload\nFROM norm\nWHERE recipient IS NOT NULL             -- guard against nulls\nON CONFLICT (order_id, recipient) DO UPDATE\nSET subject    = EXCLUDED.subject,\n    body_html  = EXCLUDED.body_html,\n    payload    = EXCLUDED.payload,\n    updated_at = NOW()\nRETURNING id, status, created_at;",
        "options": {
          "queryReplacement": "={{ [\n  JSON.stringify({\n    orderId:   $json.orderId || $json.order_id || '',\n    recipient: $json.recipient || $json.email || $json.customer_email || '',\n    subject:   $json.subject || '',\n    body_html: $json.body_html || '',\n    payload:   $json.payload || {}\n  })\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        21600,
        -208
      ],
      "id": "76a688ef-9df6-475f-94e9-8b25307add80",
      "name": "Execute a SQL query"
    },
    {
      "parameters": {
        "jsCode": "// Re-attach canonical context to each tail item\n\nconst carry = $item(0).$node['Context (carry)']?.json || {};\n\nconst ctx = {\n  orderId:       carry.orderId       || '',\n  email:         carry.email         || '',\n  candidateName: carry.candidateName || '',\n  package:       carry.package       || '',\n  addons:        Array.isArray(carry.addons) ? carry.addons : [],\n  cvExt:         carry.cvExt         || '',\n  source:        carry.source        || 'web',\n  tokenCostEur:  carry.tokenCostEur  ?? null,\n  priority:      carry.priority === true\n};\n\nreturn items.map(it => ({\n  json: { ...ctx, ...it.json }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        20032,
        -208
      ],
      "id": "ce94833d-ba4f-426c-ac7e-681ff6b2125d",
      "name": "Reattach Context"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7918e434-92ec-486c-abd4-7a0d461cfb3f",
              "name": "=orderId",
              "value": "={{ $json.orderId || $json.order_id || '' }}",
              "type": "string"
            },
            {
              "id": "6d2c63a4-ccc0-420d-a679-bc60a5304f42",
              "name": "=email",
              "value": "={{ $json.email || $json.customer_email || '' }}",
              "type": "string"
            },
            {
              "id": "1a8bfa4c-22fc-4a3a-8adc-27a981a8ae1d",
              "name": "=candidateName",
              "value": "={{ \n  $json.candidateName \n  || $json.full_name \n  || $node[\"Webhook Intake\"].json.candidateName \n  || '' \n}}",
              "type": "string"
            },
            {
              "id": "985f7347-0b22-4cfa-be5f-261b970d14d6",
              "name": "=package",
              "value": "={{ ($json.package || $json.packageTier || '').toString().trim().toLowerCase() }}",
              "type": "string"
            },
            {
              "id": "1f012398-aa60-41d6-80bc-8a764a4ea712",
              "name": "=addons",
              "value": "={{ Array.isArray($json.addons) ? $json.addons : ($json._ctx?.rawAddons || []) }}",
              "type": "array"
            },
            {
              "id": "a58e8215-d7ad-4721-ad69-84ae136c1227",
              "name": "=cvExt",
              "value": "={{ $json.cvExt || '' }}",
              "type": "string"
            },
            {
              "id": "29406af4-058f-4801-a3aa-014839009819",
              "name": "=source",
              "value": "={{ $json.source || 'web' }}",
              "type": "string"
            },
            {
              "id": "e6254410-7fb7-4d1a-b2f5-79a133402681",
              "name": "=tokenCostEur",
              "value": "={{ $json.tokenCostEur ?? $json.cost_eur ?? null }}",
              "type": "number"
            },
            {
              "id": "d68204a5-b06b-4621-b17b-a25bb4f9b1f5",
              "name": "=priority",
              "value": "={{ $json.priority === true || $json.entPriority === true || $json.entPriorityBool === true }}",
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5216,
        -48
      ],
      "id": "59ec0cef-ab5c-43b9-9a0c-4a458198da05",
      "name": "Context (carry)"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "with p as (\n  select\n    ($1::jsonb->>'orderId')::uuid                  as order_id,\n    nullif($1::jsonb->>'email','')                 as email,\n    nullif($1::jsonb->>'candidateName','')         as full_name,\n    nullif($1::jsonb->>'currentPosition','')       as current_position,\n    nullif($1::jsonb->>'targetPosition','')        as target_position\n)\ninsert into public.customer_data (order_id, email, full_name, current_position, target_position)\nselect order_id, email, full_name, current_position, target_position\nfrom p\non conflict (order_id) do update\nset email            = coalesce(excluded.email,            customer_data.email),\n    full_name        = coalesce(excluded.full_name,        customer_data.full_name),\n    current_position = coalesce(excluded.current_position, customer_data.current_position),\n    target_position  = coalesce(excluded.target_position,  customer_data.target_position),\n    updated_at       = now()\nreturning *;",
        "options": {
          "queryReplacement": "={{ [   JSON.stringify({     orderId:         $json.orderId || $json.order_id || '',     email:           $json.email   || $json.customer_email || '',     candidateName:   $json.candidateName || '',     currentPosition: $json.currentPosition || '',     targetPosition:  $json.targetPosition  || $json.jobTitle || ''   }) ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        20928,
        -208
      ],
      "id": "a8e46c93-0dd3-4008-880b-6b81c4ed7ad5",
      "name": "Execute a SQL query1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "/careeredge/submit",
        "responseMode": "responseNode",
        "options": {
          "binaryPropertyName": "cv"
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -6432,
        480
      ],
      "id": "20f3d368-ca52-415f-b376-4e0c349fe62f",
      "name": "Webhook Intake",
      "webhookId": "5582e62f-8942-4d06-b5d9-d1f40faf9096"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Consolidate everything needed for the P&L row from authoritative nodes\n\n// 1) Canonical context (orderId, email, package, addons, etc.)\nconst carry = $item(0).$node['Context (carry)']?.json || {};\nconst ctx   = $json; // current item after Reattach Context, Mark Order Done, etc.\n\n// Prefer Reattach values, fallback to raw Context if needed\nconst orderId = ctx.orderId || ctx.order_id || carry.orderId || carry.order_id || '';\nconst email   = ctx.email   || carry.email || '';\nconst candidateName = ctx.candidateName || carry.candidateName || '';\n\n// Package & addons\nconst pkgRaw  = (ctx.package || carry.package || '').toString().trim().toLowerCase();\nconst addons  = Array.isArray(ctx.addons)\n  ? ctx.addons\n  : (Array.isArray(carry.addons) ? carry.addons : []);\n\n// 2) Document keys from Shape Documents Map\nconst docsNode = $item(0).$node['Shape Documents Map']?.json || {};\nconst keys = docsNode.keys || {};\n\n// 3) Pricing and execution estimate\nconst priceMap = {\n  starter:   4.99,\n  standard:  7.99,\n  premium:   14.99,\n  executive: 24.99,\n};\n\nconst priority =\n  ctx.priority === true ||\n  ctx.entPriority === true ||\n  ctx.entPriorityBool === true ||\n  carry.priority === true;\n\nlet execEst;\nif (priority) {\n  execEst = 24;\n} else if (pkgRaw === 'starter') {\n  execEst = 72;\n} else if (pkgRaw === 'standard') {\n  execEst = 96;\n} else if (pkgRaw === 'premium') {\n  execEst = 120;\n} else if (pkgRaw === 'executive') {\n  execEst = 168;\n} else {\n  execEst = 96;\n}\n\nconst priceEur = Number(priceMap[pkgRaw] ?? 0);\n\n// 4) Build the \"sheet\" object that your Google Sheets node will use\nconst sheet = {\n  orderId:        orderId,\n  timestamp:      new Date().toISOString(),\n  email:          email,\n  candidateName:  candidateName,\n  package:        pkgRaw,\n  addons:         JSON.stringify(addons),\n  price_eur:      priceEur,\n  priority:       priority,\n  exec_est:       execEst,\n  cv_ext:         ctx.cvExt || carry.cvExt || '',\n  source:         ctx.source || carry.source || 'web',\n\n  cv_re_key:      keys.cv          || '',\n  cover_key:      keys.coverLetter || '',\n  li_key:         keys.linkedin    || '',\n  docx_key:       keys.docx        || '',\n  rtf_key:        keys.rtf         || '',\n\n  status:         'done',\n  token_cost_eur: ctx.tokenCostEur ?? carry.tokenCostEur ?? null,\n  notes:          ctx.notes || ''\n};\n\nreturn {\n  json: {\n    ...ctx,   // keep everything else for debugging if needed\n    sheet\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        20480,
        -208
      ],
      "id": "26c357ce-2790-4904-87fc-cb662eae06ba",
      "name": "Prepare Row for Sheets"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c36c808a-07c4-42a1-886c-dbf2efd4ea8b",
              "name": "orderId ",
              "value": "={{ $json.orderId || $json.order_id || '' }}",
              "type": "string"
            },
            {
              "id": "c01566e2-c08d-4e3f-ad4a-410e844d2bb6",
              "name": "package",
              "value": "={{ $json.package || '' }}",
              "type": "string"
            },
            {
              "id": "5820e4f1-e5cf-45c2-a162-dde74e676308",
              "name": "priority",
              "value": "={{ !!($json.priority ?? $json.entPriority ?? $json.entPriorityBool ?? false) }}",
              "type": "boolean"
            },
            {
              "id": "e5c3e352-addd-42c0-b6fd-ebc7daa215c5",
              "name": "dueDate",
              "value": "={{ $json.dueDate || '' }}",
              "type": "string"
            },
            {
              "id": "f5c492e7-fd53-43c6-b474-7c7ad51c5ed4",
              "name": "keys",
              "value": "={{ $json.keys || {\n  cv:          $json.documents?.cv_rewritten      || '',\n  coverLetter: $json.documents?.cover_letter      || '',\n  linkedin:    $json.documents?.linkedin_profile  || '',\n  docx:        $json.documents?.cv_rewrite_docx   || '',\n  rtf:         $json.documents?.cv_rewrite_rtf    || '',\n} }}",
              "type": "object"
            },
            {
              "id": "dddfd295-52ac-474f-9899-425db6faa221",
              "name": "urls",
              "value": "={{ $json.urls || {\n  cv:          $json.cvUrl           || $json.cv_rewrite_url   || '',\n  coverLetter: $json.coverLetterUrl  || $json.cover_letter_url || '',\n  linkedin:    $json.linkedinUrl     || $json.linkedin_url     || '',\n  docx:        $json.docxUrl         || $json.docx_url         || '',\n  rtf:         $json.rtfUrl          || $json.rtf_url          || '',\n} }}",
              "type": "object"
            },
            {
              "id": "2c69d80b-754e-48a2-a0c4-30725fbaab55",
              "name": "email",
              "value": "={{ $json.email || $json.recipient || $json.customer_email || '' }}",
              "type": "string"
            },
            {
              "id": "b80601c6-557a-4e65-a808-68ba1e11ae76",
              "name": "candidateName",
              "value": "={{ $json.candidateName || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        21152,
        -208
      ],
      "id": "ec2d04f3-7907-423e-9c28-3a384320c7df",
      "name": "Assemble Response"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Compute total token cost (EUR) for this order.\n *\n * Place this node AFTER all AI nodes and AFTER \"Reattach Context\".\n * Place BEFORE Google Sheets or database writes.\n */\n\n// -------------------------------------------------------------\n// 1) USD â†’ EUR conversion\n// -------------------------------------------------------------\nconst EUR_PER_USD = 0.92;        // adjust if needed\n\n// -------------------------------------------------------------\n// 2) Real API Prices (converted to EUR per TOKEN)\n// -------------------------------------------------------------\n//\n// All values use official API pricing PER MILLION tokens in USD:\n//   GPT-4o ............... $5 input / $15 output\n//   GPT-4 ................ $2 input / $8 output\n//   GPT-4o-mini .......... $0.15 input / $0.60 output\n//   Claude Sonnet 4 ...... $3 input / $15 output\n//   Claude Opus 4.1 ...... $15 input / $75 output\n//   Claude Haiku 3.5 ..... $0.80 input / $4 output\n//\n// Then converted to EUR/token.\n//\n\nconst PRICING = {\n  gpt_4o: {\n    input:  (5  * EUR_PER_USD) / 1_000_000,\n    output: (15 * EUR_PER_USD) / 1_000_000,\n  },\n  gpt_4: {\n    input:  (2  * EUR_PER_USD) / 1_000_000,\n    output: (8  * EUR_PER_USD) / 1_000_000,\n  },\n  gpt_4o_mini: {\n    input:  (0.15 * EUR_PER_USD) / 1_000_000,\n    output: (0.60 * EUR_PER_USD) / 1_000_000,\n  },\n  claude_sonnet_4: {\n    input:  (3  * EUR_PER_USD) / 1_000_000,\n    output: (15 * EUR_PER_USD) / 1_000_000,\n  },\n  claude_opus_4_1: {\n    input:  (15 * EUR_PER_USD) / 1_000_000,\n    output: (75 * EUR_PER_USD) / 1_000_000,\n  },\n  claude_haiku_3_5: {\n    input:  (0.8 * EUR_PER_USD) / 1_000_000,\n    output: (4   * EUR_PER_USD) / 1_000_000,\n  }\n};\n\n// -------------------------------------------------------------\n// 3) Map: Which AI node uses which model?\n//    (Names must match EXACTLY your n8n node names)\n// -------------------------------------------------------------\nconst STEPS = [\n  // Starter / Standard â†’ GPT-4o-mini\n  { name: 'cv_rewrite',       node: 'Rewrite CV',           model: 'gpt_4o_mini' },\n  { name: 'cv_rewrite_v1',    node: 'Rewrite CV1',          model: 'gpt_4o_mini' },\n  { name: 'cv_rewrite_v2',    node: 'Rewrite CV2',          model: 'gpt_4o_mini' },\n  { name: 'cv_rewrite_v3',    node: 'Rewrite CV3',          model: 'gpt_4o_mini' },\n  { name: 'cover_letter',     node: 'Cover Letter Rewrite', model: 'gpt_4o_mini' },\n\n  // Premium â†’ Claude Sonnet 4\n  { name: 'premium_cv',       node: 'Message a model3',     model: 'claude_sonnet_4' },\n\n  // Executive â†’ Claude Opus 4.1\n  { name: 'executive_cv',     node: 'Message a model11',    model: 'claude_opus_4_1' },\n];\n\n// -------------------------------------------------------------\n// 4) Extract token usage from a node's JSON\n// -------------------------------------------------------------\nfunction extractTokens(nodeJson = {}) {\n  const usage = nodeJson.usage || nodeJson.metrics || {};\n\n  const promptTokens =\n    usage.prompt_tokens ??\n    usage.input_tokens ??\n    0;\n\n  const completionTokens =\n    usage.completion_tokens ??\n    usage.output_tokens ??\n    0;\n\n  const totalTokens =\n    usage.total_tokens ??\n    (promptTokens + completionTokens);\n\n  return { promptTokens, completionTokens, totalTokens };\n}\n\n// -------------------------------------------------------------\n// 5) Compute cost for one step\n// -------------------------------------------------------------\nfunction costForStep(tokens, modelKey) {\n  const pricing = PRICING[modelKey];\n  if (!pricing) return 0;\n\n  const inputCost  = tokens.promptTokens     * pricing.input;\n  const outputCost = tokens.completionTokens * pricing.output;\n\n  return inputCost + outputCost;\n}\n\n// -------------------------------------------------------------\n// 6) Compute total + breakdown (using item 0)\n// -------------------------------------------------------------\nlet totalCost = 0;\nconst breakdown = {};\n\nfor (const step of STEPS) {\n  let nodeData;\n\n  try {\n    nodeData = $item(0).$node[step.node].json;\n  } catch (e) {\n    continue; // node didn't run in this branch\n  }\n\n  if (!nodeData) continue;\n\n  const tokens = extractTokens(nodeData);\n  const stepCost = costForStep(tokens, step.model);\n\n  breakdown[step.name] = {\n    model: step.model,\n    tokens,\n    cost_eur: stepCost,\n  };\n\n  totalCost += stepCost;\n}\n\n// -------------------------------------------------------------\n// 7) Attach cost to ALL items\n// -------------------------------------------------------------\nreturn items.map(it => ({\n  json: {\n    ...it.json,\n    tokenCostEur: totalCost,\n    tokenCostBreakdown: breakdown,\n  },\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        20256,
        -208
      ],
      "id": "3436dbb1-1307-49a3-a646-aa80866ca912",
      "name": "Compute Token Cost"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Extract CV text from the current item only.\n// Works for your TXT uploads (binary.cv or binary.cv0).\n\nconst j = { ...$json };\n\nlet cvText = '';\n\n// 1) If cvText already exists and is NOT a template artifact, keep it.\nif (typeof j.cvText === 'string') {\n  const trimmed = j.cvText.trim();\n  const looksLikeTemplate = trimmed.includes('{{$');\n  const looksLikeLabel = trimmed.startsWith('cvText (String) =');\n\n  if (trimmed && !looksLikeTemplate && !looksLikeLabel) {\n    cvText = trimmed;\n  }\n}\n\n// 2) Otherwise, decode from binary (TXT path)\nif (!cvText) {\n  const bin = $binary.cv || $binary.cv0 || null;\n  if (bin && bin.data) {\n    try {\n      cvText = Buffer.from(bin.data, 'base64').toString('utf8');\n    } catch (e) {\n      // leave empty if decoding fails\n    }\n  }\n}\n\n// 3) Normalise line endings & trim\nj.cvText = (cvText || '').replace(/\\r\\n/g, '\\n').trim();\n\n// Debug â€“ you should see a non-zero length if the CV was decoded\nconsole.log('[Extract CV Text] length:', j.cvText.length);\n\nreturn {\n  json: j,\n  binary: $binary,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3648,
        -48
      ],
      "id": "3d7f3fc6-5baf-4467-9b43-341e46f9a558",
      "name": "Extract CV Text"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "fd1a66d0-8f0b-4f44-b867-a2d93bac9c7b",
              "leftValue": "={{$json.cvExt}}",
              "rightValue": "\"doc\"",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5088,
        384
      ],
      "id": "1b9064d0-30e6-4ae1-a31f-76285d55e5a0",
      "name": "File Type Routing"
    },
    {
      "parameters": {
        "authentication": "apiKey",
        "outputFormat": "txt",
        "inputBinaryPropertyName": "cv"
      },
      "type": "@cloudconvert/n8n-nodes-cloudconvert.cloudConvert",
      "typeVersion": 1,
      "position": [
        -4864,
        288
      ],
      "id": "38388318-ada5-4ec2-a92a-5b680499df88",
      "name": "CloudConvert"
    },
    {
      "parameters": {
        "operation": "fromJson",
        "binaryPropertyName": "cv0",
        "destinationKey": "cvText",
        "options": {
          "keepSource": "binary"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -4640,
        288
      ],
      "id": "4a898d4c-f609-4c87-9dc1-2a3473153a51",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "operation": "text",
        "binaryPropertyName": "cv0",
        "destinationKey": "cvText",
        "options": {
          "keepSource": "binary"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -4640,
        480
      ],
      "id": "2d26e6da-84e3-465b-963b-bfb90d020c12",
      "name": "Extract from File1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://applysmart.app.n8n.cloud/webhook/email-dispatch",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "orderId",
              "value": "={{ \n  $json.orderId \n  || $json.order_id \n  || $item(0).$node[\"Mark Order Done\"].json.orderId \n  || $item(0).$node[\"Mark Order Done\"].json.order_id \n}}"
            },
            {
              "name": "email",
              "value": "={{$json.email}}"
            },
            {
              "name": "candidateName",
              "value": "={{$json.candidateName}}"
            },
            {
              "name": "package",
              "value": "={{$json.package}}"
            },
            {
              "name": "addons",
              "value": "={{$json.addons}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        21824,
        -208
      ],
      "id": "d66c9828-ae52-4e64-8487-c9289193e8e4",
      "name": "Trigger Email Workflow",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Code node: \"Make Rewritten CV File\"\n\nconst j = { ...$json };\n\nconst text = String(j.cvRewriteText || '').trim();\n\nif (!text) {\n  // If for some reason we have no rewrite, just pass through\n  return { json: j, binary: $binary };\n}\n\n// Create a binary file called rewrittenCV\nconst data = Buffer.from(text, 'utf8').toString('base64');\n\nreturn {\n  json: j,\n  binary: {\n    ...( $binary || {} ),\n    rewrittenCV: {\n      data,\n      fileName: 'cv_rewritten.txt',\n      mimeType: 'text/plain',\n    },\n  },\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7520,
        -144
      ],
      "id": "92fa1d9d-0fdb-4c55-a2a6-fc9b59aba376",
      "name": "cvRewriteText"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://' + ($json._cfg?.supabaseUrl || 'REPLACE_WITH_SUPABASE_PROJECT_REF.supabase.co') + '/storage/v1/object/cvstore/orders/' + ($json.ctx?.orderId || $json.orderId || $json.joinKey || '') + '/cv_rewritten.pdf' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ 'Bearer ' + ($json._cfg?.supabaseKey || 'REPLACE_WITH_SUPABASE_SERVICE_ROLE_KEY') }}"
            },
            {
              "name": "Content-Type",
              "value": "application/pdf"
            },
            {
              "name": "x-upsert",
              "value": "true"
            },
            {
              "name": "apikey",
              "value": "={{ $json._cfg?.supabaseKey || 'REPLACE_WITH_SUPABASE_SERVICE_ROLE_KEY' }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "data",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        9664,
        32
      ],
      "id": "9125fbdf-2654-44b4-809e-8c55671d080b",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.documents (order_id, kind, storage_key)\nVALUES ($1::uuid, 'cv_rewritten', $2)\nON CONFLICT (order_id, kind) DO UPDATE\nSET storage_key = EXCLUDED.storage_key;",
        "options": {
          "queryReplacement": "={{ [\n  ($json.ctx?.orderId || $json.orderId || $json.joinKey),\n  ($json.Key || $json.storage_key || `cvstore/orders/${$json.ctx?.orderId || $json.orderId || $json.joinKey}/cv_rewritten.pdf`)\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        10880,
        -64
      ],
      "id": "26a72893-f942-47d3-8bf0-a9bfc3b36175",
      "name": "Execute a SQL query2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3fd9a3db-6b48-46e6-bbc9-3a3252f6324b",
              "name": "=docRow",
              "value": "={{\n  (() => {\n    const oid = $json.ctx?.orderId || $json.orderId || $json.body?.orderId || $json.joinKey || '';\n    return {\n      orderId: oid,\n      storage_key: `orders/${oid}/cv_rewritten.pdf`,\n      key: $json.Key || '',\n      id: $json.Id || '',\n      documentId: $json.documentId || $json.ctx?.documentId || ''\n    };\n  })()\n}}",
              "type": "object"
            },
            {
              "id": "9c43b73d-ad93-4723-a567-4aa7b290448f",
              "name": "=orderId",
              "value": "={{ $json.docRow?.orderId || $json.ctx?.orderId || $json.orderId || $json.body?.orderId || $json.joinKey || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        10656,
        -208
      ],
      "id": "1bebd778-d4d6-4dea-b0c5-909ae5b21a0b",
      "name": "Prepare Document Row"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{$json.documentId || $json.id}}",
          "mode": "id"
        },
        "options": {
          "googleFileConversion": {
            "conversion": {
              "docsToFormat": "application/pdf"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        8864,
        -208
      ],
      "id": "835b408c-ff8a-4cd6-9d19-0321413376dd",
      "name": "Download file"
    },
    {
      "parameters": {
        "driveId": "=Ai-Vitae CVs",
        "folderId": "=1vpKP_zlqScqx8Ms9fWhGWqCs0f7jxS4H",
        "title": "=Rewritten CV - {{\n  $json.ctx?.candidateName\n  || $json.candidateName\n  || 'Candidate'\n}} - {{\n  $json.ctx?.orderId\n  || $json.orderId\n  || $json.joinKey\n  || ''\n}}"
      },
      "type": "n8n-nodes-base.googleDocs",
      "typeVersion": 2,
      "position": [
        7968,
        80
      ],
      "id": "1b68a3ff-7ef6-4429-8293-5553fb7c8265",
      "name": "Google Docs"
    },
    {
      "parameters": {
        "operation": "update",
        "documentURL": "={{ $json.documentId || $json.id }}",
        "actionsUi": {
          "actionFields": [
            {
              "action": "insert",
              "text": "={{\n  (() => {\n    const t = (\n      $json.cvRewriteText\n      || $json.ctx?.rewrittenCVText\n      || $json.rewrittenCVText\n      || ''\n    ).toString().trim();\n\n    return t.length ? t : 'CV rewrite was empty (upstream error).';\n  })()\n}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.googleDocs",
      "typeVersion": 2,
      "position": [
        8640,
        -208
      ],
      "id": "00de3b3d-d8ca-483f-8df3-312c7f0fdaa4",
      "name": "Google Docs - Write Content"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.pdf.co/v1/file/convert/to/text",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "cv",
        "options": {
          "response": {
            "response": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        64,
        -384
      ],
      "id": "cf480f7e-aa7c-43ca-9beb-63803ed022c5",
      "name": "DOCX - Text"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.pdf.co/v1/file/convert/to/text",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "cv",
        "options": {
          "response": {
            "response": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        64,
        -192
      ],
      "id": "78073647-bdaf-4608-b253-6f73065b1c35",
      "name": "DOC - Text"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "de93fa8d-5fb6-420c-8dda-8e12351b3af0",
              "name": "=ctx.cvText",
              "value": "={{ $json.extractedText || $json.text || $json.body || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        288,
        0
      ],
      "id": "0a46ed3f-eb16-4441-ae37-c6fcfec17fae",
      "name": "TXT Field"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6cc2d607-c626-4a4a-8753-01aeb5a64d3c",
              "name": "=ctx",
              "value": "={{\n  (() => {\n    const body = $json.body || {};\n\n    const raw = body.addons;\n\n    const addons =\n      Array.isArray(raw)\n        ? raw.map(s => String(s).trim().toLowerCase()).filter(Boolean)\n        : typeof raw === 'string'\n          ? (() => {\n              const t = raw.trim();\n              try {\n                const j = JSON.parse(t);\n                if (Array.isArray(j)) return j.map(s => String(s).trim().toLowerCase()).filter(Boolean);\n              } catch {}\n              return t ? t.split(',').map(s => s.trim().toLowerCase()).filter(Boolean) : [];\n            })()\n          : [];\n\n    const addonSet = addons.reduce((acc, a) => (acc[a] = true, acc), {});\n\n    const flags = {\n      extraCoverLetter: !!addonSet.extracoverletter,\n      oneDay: !!addonSet.oneday,\n      editableWord: !!addonSet.editableword,\n      linkedIn: !!(addonSet.linkedin || addonSet.linkedinoptimize || addonSet.linkedinoptimization),\n    };\n\n    return {\n      ...body,\n      addons,\n      addonSet,\n      flags,\n    };\n  })()\n}}",
              "type": "object"
            },
            {
              "id": "a2436079-2417-4f35-a7d1-89af4035cff3",
              "name": "=cvBinaryKey",
              "value": "={{ Object.keys($binary || {})[0] || '' }}",
              "type": "string"
            },
            {
              "id": "b00055fa-145a-4bc4-82e9-d8bcd4368d57",
              "name": "=orderId",
              "value": "={{ $json.body?.orderId || $json.joinKey || '' }}",
              "type": "string"
            },
            {
              "id": "7b641c12-4bc8-4936-8843-d04d78cb3f80",
              "name": "=joinKey",
              "value": "={{ $json.joinKey || $json.body?.orderId || '' }}",
              "type": "string"
            },
            {
              "id": "541b640a-f251-4dee-abd5-37e2724dc0d3",
              "name": "=ack",
              "value": "={{ true }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5312,
        384
      ],
      "id": "e13f9881-19b0-48f2-95b7-e423b51c9190",
      "name": "Stash Metadata"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d19c5879-6afc-4f19-bcb8-2ddaff6e8e80",
              "name": "=cvText",
              "value": "={{ $json.cvText || $json.text || $json.body || '' }}",
              "type": "string"
            },
            {
              "id": "90cacf60-7abe-43c3-a38d-9182482d6bc9",
              "name": "=addons",
              "value": "{{ $json.meta?.body?.addons || $json.body?.addons || '' }}",
              "type": "string"
            },
            {
              "id": "473a30fe-2547-4a82-8d14-2a03520c190d",
              "name": "=package",
              "value": "{{ $json.meta?.body?.package || $json.body?.package || '' }}",
              "type": "string"
            },
            {
              "id": "1d064bef-15e6-4b2c-8b45-e05631f698f7",
              "name": "=orderId",
              "value": "{{ $json.meta?.body?.orderId || $json.body?.orderId || '' }}",
              "type": "string"
            },
            {
              "id": "2d263fbe-cdb3-48c9-9830-2b30ac54eec4",
              "name": "=email",
              "value": "{{ $json.meta?.body?.email || $json.body?.email || '' }}",
              "type": "string"
            },
            {
              "id": "9e8128ab-aece-4d75-b5e7-27447b465e51",
              "name": "=candidateName",
              "value": "{{ $json.meta?.body?.candidateName || $json.body?.candidateName || '' }}",
              "type": "string"
            },
            {
              "id": "2be6482b-ec64-45d3-a23c-b3980e574952",
              "name": "=jobDescription",
              "value": "{{ $json.meta?.body?.jobDescription || $json.body?.jobDescription || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4192,
        384
      ],
      "id": "bbc6549c-2002-43df-bfa2-e4190d9ed772",
      "name": "Normalize Input"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        11104,
        -208
      ],
      "id": "b3db0851-1ef2-4355-8e34-1d14955afdd4",
      "name": "Merge SQL + Payload"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// The \"main\" item is the one that contains ctx/docRow\nconst main = items.find(i => i.json.ctx || i.json.docRow) ?? items[0];\n\n// The SQL result is the one that contains \"success\" or rows and does NOT have ctx/docRow\nconst sql = items.find(i => (i.json.success !== undefined || i.json.length !== undefined) && !i.json.ctx && !i.json.docRow) ?? {};\n\nmain.json.sql = sql.json;\n\nreturn [main];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        11328,
        -208
      ],
      "id": "a86fa839-5d98-487d-9761-d5c648d4bbe1",
      "name": "Reattach Context1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6af4c17e-ff05-41a7-99b6-cf9a27216bff",
              "name": "=addons",
              "value": "={{\n  (() => {\n    const raw = $json.ctx?.addons ?? $json.addons ?? [];\n    if (Array.isArray(raw)) return raw.map(a => String(a).trim().toLowerCase()).filter(Boolean);\n    if (typeof raw === 'string') {\n      const t = raw.trim();\n      // allow JSON array string\n      try { const j = JSON.parse(t); if (Array.isArray(j)) return j.map(x => String(x).trim().toLowerCase()).filter(Boolean); } catch {}\n      // allow csv\n      return t ? t.split(',').map(x => x.trim().toLowerCase()).filter(Boolean) : [];\n    }\n    return [];\n  })()\n}}",
              "type": "array"
            },
            {
              "id": "3f180a36-1623-4072-b816-6e2545530b40",
              "name": "=hasExtraCoverLetter",
              "value": "={{\n  (() => {\n    const raw = $json.ctx?.addons ?? $json.addons ?? [];\n    const arr = Array.isArray(raw)\n      ? raw\n      : typeof raw === 'string'\n        ? raw.split(',')   // ok as fallback\n        : [];\n    return arr.map(a => String(a).trim().toLowerCase()).includes('extracoverletter');\n  })()\n}}",
              "type": "boolean"
            },
            {
              "id": "3530a70a-2544-4b12-a655-cb788d25ce2e",
              "name": "=jobDescription",
              "value": "={{ $json.ctx?.jobDescription ?? $json.jobDescription ?? '' }}",
              "type": "string"
            },
            {
              "id": "9300b829-90db-4659-a65c-4755033634dc",
              "name": "=rewrittenCVText",
              "value": "={{ $json.ctx?.rewrittenCVText ?? $json.ctx?.cvRewriteText ?? $json.rewrittenCVText ?? $json.cvRewriteText ?? '' }}",
              "type": "string"
            },
            {
              "id": "4533467c-ce0d-4bba-a9e1-1c10f26092f2",
              "name": "=cvText",
              "value": "={{ $json.ctx?.cvText ?? $json.cvText ?? '' }}",
              "type": "string"
            },
            {
              "id": "ea1e0a91-3ac7-44c8-80fb-377d3df5d1d0",
              "name": "=candidateName",
              "value": "={{ $json.ctx?.candidateName ?? $json.candidateName ?? '' }}",
              "type": "string"
            },
            {
              "id": "50afd495-4f16-4b1e-a21a-426dc1b5257c",
              "name": "=email",
              "value": "={{ $json.ctx?.email ?? $json.email ?? '' }}",
              "type": "string"
            },
            {
              "id": "b9669d53-fab3-48ee-866e-2d0815dc1c0c",
              "name": "=orderId",
              "value": "={{ $json.ctx?.orderId ?? $json.orderId ?? $json.docRow?.orderId ?? '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        11552,
        -64
      ],
      "id": "4d7acf6d-559e-4da2-821e-f3c778cadd65",
      "name": "Normalize Payload"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "=joinKey",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        10208,
        -208
      ],
      "id": "9d7d4543-651e-4e10-bbf8-a42b201c75f7",
      "name": "Merge Upload Result + Context"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nconst upload = items.find(i => i.json.Key && i.json.Id) ?? {};\nconst ctxItem = items.find(i => i.json.ctx) ?? {};\n\nreturn [{\n  json: {\n    ...upload.json,\n    ...ctxItem.json,\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        10432,
        -208
      ],
      "id": "76346691-13d4-4133-ab25-d89e96a8a003",
      "name": "Collapse To One"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b5bf1ae8-1bbb-4ece-a77b-375bd05560dc",
              "name": "=joinKey",
              "value": "={{\n  (\n    $json.joinKey\n    || $json.ctx?.orderId\n    || $json.orderId\n    || $if($(\"Reattach Context1\").isExecuted, $(\"Reattach Context1\").item.json.joinKey, \"\")\n    || $if($(\"Reattach Context1\").isExecuted, $(\"Reattach Context1\").item.json.ctx?.orderId, \"\")\n    || $if($(\"Stash Context\").isExecuted, $(\"Stash Context\").item.json.joinKey, \"\")\n    || $if($(\"Stash Context\").isExecuted, $(\"Stash Context\").item.json.ctx?.orderId, \"\")\n    || ''\n  ).toString().trim().replace(/^=/,'')\n}}",
              "type": "string"
            },
            {
              "id": "3dd19ff6-6899-4bd4-a401-0c0f051c1b6a",
              "name": "documentId",
              "value": "={{\n  ($json.documentId || $json.id || '').toString().trim()\n}}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        9136,
        -96
      ],
      "id": "3e218657-bc54-4c77-91db-917829b5d5b0",
      "name": "Add joinKey to DocResult"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4dc8c9b6-0323-46dc-a220-dc6162015a87",
              "name": "=joinKey",
              "value": "={{\n  (\n    $json.joinKey\n    || $json.ctx?.orderId\n    || $json.orderId\n    || $json.order_id\n    || $items(\"Switch\", 0)[0]?.json?.ctx?.orderId\n    || $items(\"Switch\", 0)[0]?.json?.orderId\n    || ''\n  ).toString().trim().replace(/^=/,'')\n}}",
              "type": "string"
            },
            {
              "id": "4b987d95-dd5a-4080-87a5-5e645e16de07",
              "name": "=ctx",
              "value": "={{\n(() => {\n  // Source of truth = pre-AI payload (Switch), fallback to current JSON\n  const src =\n    $items(\"Switch\", 0)[0]?.json\n    || $json\n    || {};\n\n  const base =\n    (src.ctx && typeof src.ctx === 'object') ? src.ctx : {};\n\n  const clean = (v) =>\n    v === undefined || v === null ? '' : v.toString().trim();\n\n  const orderId = clean(\n    base.orderId || src.orderId || src.order_id || src.joinKey\n  ).replace(/^=/, '');\n\n  const candidateName = clean(\n    src.candidateName || base.candidateName\n  );\n\n  const email = clean(\n    src.email || base.email\n  );\n\n  const pkg = clean(\n    src.package || base.package || src.packageTier\n  );\n\n  const jobDescription =\n    (src.jobDescription || base.jobDescription || '').toString();\n\n  // Normalize addons into array\n  let addons = base.addons || src.addons || [];\n  if (typeof addons === 'string') {\n    addons = addons\n      .split(',')\n      .map(a => a.trim())\n      .filter(Boolean);\n  }\n  if (!Array.isArray(addons)) addons = [];\n\n  const flags = base.flags || src.flags || {};\n\n  // ðŸ”‘ Canonical rewritten CV text (ALWAYS STRING)\n  const rewrittenCVText =\n    (\n      $json.message?.content\n      || $json.choices?.[0]?.message?.content\n      || base.rewrittenCVText\n      || ''\n    ).toString().trim();\n\n  return {\n    orderId,\n    candidateName,\n    email,\n    package: pkg,\n    jobDescription,\n    addons,\n    flags,\n    rewrittenCVText,\n  };\n})()\n}}",
              "type": "object"
            },
            {
              "id": "e3074ca8-49ec-45c5-bc07-ee4b0820160a",
              "name": "=cvRewriteText",
              "value": "={{\n(\n  $json.message?.content\n  || $json.choices?.[0]?.message?.content\n  || $json.ctx?.rewrittenCVText\n  || ''\n).toString().trim()\n}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7744,
        -144
      ],
      "id": "305a913a-4fa7-48a8-a252-33bfde39b618",
      "name": "Stash Context"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "joinKey",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        9392,
        -208
      ],
      "id": "9a1b8e2d-616b-4831-9689-ccf9b737cb4e",
      "name": "Merge Back"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// 1) Find the item that has ctx (this is your â€œmainâ€ payload)\nconst ctxItem = items.find(i => i.json?.ctx) || items[0];\n\n// 2) Find the item that has the PDF binary (binary field is \"data\")\nconst binItem = items.find(i => i.binary?.data) || ctxItem;\n\n// 3) Resolve documentId safely (prefer non-null, non-empty)\nconst docId =\n  items.map(i => i.json?.documentId).find(v => v !== null && v !== undefined && String(v).trim() !== '') ||\n  ctxItem.json?.ctx?.documentId ||\n  null;\n\n// 4) Create one final JSON object (prefer ctxItem as base)\nconst outJson = {\n  ...(ctxItem.json || {}),\n  // force documentId to the best value we found (won't be overwritten by null)\n  documentId: docId,\n};\n\n// 5) Ensure ctx exists and has orderId (since downstream relies on ctx.orderId)\noutJson.ctx = outJson.ctx || {};\noutJson.ctx.orderId = outJson.ctx.orderId || outJson.orderId || outJson.joinKey || \"\";\n\n// 6) Output ONE item that includes BOTH json + binary\nreturn [{\n  json: outJson,\n  binary: binItem.binary,\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9616,
        -208
      ],
      "id": "dee3eb63-e663-4768-8f88-fc05d7e25606",
      "name": "Collapse To One1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0cd8513a-472a-4a12-be0d-d6821e4d53bf",
              "name": "=joinKey",
              "value": "={{ ($json.body?.orderId || $json.orderId || $json.order_id || $json.body?.order_id || '').toString().trim() }}",
              "type": "string"
            },
            {
              "id": "d5a74961-e196-4881-8a3b-0a4da8f25e28",
              "name": "=ctx",
              "value": "={{\n  (() => {\n    const body = $json.body ?? {};\n    const root = $json ?? {};\n\n    const get = (...paths) => {\n      for (const p of paths) {\n        const v =\n          p.startsWith('body.')\n            ? body[p.slice(5)]\n            : root[p];\n\n        if (v !== undefined && v !== null && String(v).trim() !== '') return v;\n      }\n      return '';\n    };\n\n    // Addons normalization (string | array | json-string | csv | addons[0] style)\n    const rawAddons =\n      body.addons ?? root.addons ??\n      (() => {\n        const src = body && Object.keys(body).length ? body : root;\n        const collected = Object.keys(src || {})\n          .filter(k => /^addons\\[\\d+\\]$/.test(k))\n          .sort()\n          .map(k => src[k]);\n        return collected.length ? collected : '';\n      })();\n\n    const normalizeAddons = (raw) => {\n      if (!raw) return [];\n      if (Array.isArray(raw)) return raw.map(x => String(x).trim().toLowerCase()).filter(Boolean);\n\n      if (typeof raw === 'string') {\n        const t = raw.trim();\n        // stringified JSON array?\n        try {\n          const j = JSON.parse(t);\n          if (Array.isArray(j)) return j.map(x => String(x).trim().toLowerCase()).filter(Boolean);\n        } catch {}\n        // csv\n        return t ? t.split(',').map(x => x.trim().toLowerCase()).filter(Boolean) : [];\n      }\n      return [];\n    };\n\n    const addons = normalizeAddons(rawAddons);\n\n    const flags = {\n      extraCoverLetter: addons.includes('extracoverletter'),\n      oneDayDelivery: addons.includes('onedaydelivery') || addons.includes('oneday'),\n      editableWord: addons.includes('editableword') || addons.includes('word') || addons.includes('docx'),\n      linkedin: addons.includes('linkedin') || addons.includes('linkedinoptimization'),\n    };\n\n    const cvBinaryKey = Object.keys($binary || {})[0] || '';\n\n    // try to infer extension\n    const cvExt = cvBinaryKey\n      ? String($binary?.[cvBinaryKey]?.fileExtension || $binary?.[cvBinaryKey]?.fileName || '')\n          .split('.')\n          .pop()\n          .toLowerCase()\n      : '';\n\n    return {\n      orderId: String(get('body.orderId', 'body.order_id', 'orderId', 'order_id')).trim(),\n      package: String(get('body.package', 'body.packageTier', 'package', 'packageTier')).trim(),\n      email: String(get('body.email', 'email')).trim(),\n      candidateName: String(get('body.candidateName', 'body.candidate_name', 'candidateName', 'candidate_name', 'name', 'fullName')).trim(),\n      jobDescription: String(get('body.jobDescription', 'body.jdText', 'body.job_description', 'jobDescription', 'jdText', 'job_description')).trim(),\n      source: String(get('body.source', 'source')).trim(),\n      addons,\n      addonSet: addons.reduce((acc, a) => (acc[a] = true, acc), {}),\n      flags,\n      cvBinaryKey,\n      cvExt,\n    };\n  })()\n}}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6208,
        480
      ],
      "id": "a46f3a9c-24b2-4978-b2ce-b2cb824d69aa",
      "name": "Build ctx"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "4861a890-93ed-4946-92e1-8374e85f6501",
              "leftValue": "={{ ($json.ctx?.orderId || '').trim().length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "a760cb6d-6088-4b5f-a466-9f6988c8e41b",
              "leftValue": "={{ ($json.ctx?.email || '').trim().length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "348d8365-498f-4dd1-a1cf-87399b825387",
              "leftValue": "={{ ($json.ctx?.cvBinaryKey || '').trim().length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "ab4a6391-607d-4089-8772-433aea9c4b8c",
              "leftValue": "={{ ($json.ctx?.jobDescription || '').trim().length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -5984,
        480
      ],
      "id": "1439e463-ff82-48bb-9f0b-ff95120e4e5b",
      "name": "Validate Intake"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"error\",\n  \"message\": \"Missing required fields (orderId/email/CV file).\"\n}",
        "options": {
          "responseCode": "={{ 400 }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -5760,
        576
      ],
      "id": "2e7193fc-06cc-4f1b-802c-910c21133cb5",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"accepted\",\n  \"orderId\": \"={{ String($json.ctx?.orderId || $json.body?.orderId || $json.joinKey || '').replace(/^=/,'') }}\",\n  \"joinKey\": \"={{ String($json.joinKey || $json.ctx?.orderId || $json.body?.orderId || '').replace(/^=/,'') }}\",\n  \"message\": \"Processing started. You will receive results by email shortly.\"\n}",
        "options": {
          "responseCode": 202
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -5536,
        384
      ],
      "id": "5ad0bd22-23e8-4280-8f0d-0ec86b66e289",
      "name": "Respond 202"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "365d2124-621d-4ba9-9d93-666b2072d3a5",
              "name": "=joinKey",
              "value": "={{\n(\n  $json.ctx?.orderId\n  || $json.body?.orderId\n  || $json.orderId\n  || $json.order_id\n  || $json.joinKey\n  || ''\n).toString().trim().replace(/^=/,'')\n}}",
              "type": "string"
            },
            {
              "id": "453333f8-b3fe-47f9-add4-eca7308abd45",
              "name": "=ctx",
              "value": "={{\n(() => {\n  const body =\n    ($json.body && typeof $json.body === 'object')\n      ? $json.body\n      : {};\n\n  const ctx0 =\n    ($json.ctx && typeof $json.ctx === 'object')\n      ? $json.ctx\n      : {};\n\n  const orderId =\n    String(\n      ctx0.orderId ||\n      body.orderId ||\n      $json.orderId ||\n      $json.joinKey ||\n      ''\n    ).trim().replace(/^=/, '');\n\n  const candidateName =\n    String(\n      body.candidateName ||\n      ctx0.candidateName ||\n      $json.candidateName ||\n      ''\n    ).trim();\n\n  const email =\n    String(\n      body.email ||\n      ctx0.email ||\n      $json.email ||\n      ''\n    ).trim();\n\n  const pkg =\n    String(\n      body.package ||\n      ctx0.package ||\n      $json.package ||\n      $json.packageTier ||\n      ''\n    ).trim();\n\n  const jobDescription =\n    String(\n      body.jobDescription ||\n      ctx0.jobDescription ||\n      $json.jobDescription ||\n      ''\n    );\n\n  let addonsRaw =\n    body.addons ||\n    ctx0.addons ||\n    $json.addons ||\n    [];\n\n  let addons = [];\n  if (Array.isArray(addonsRaw)) {\n    addons = addonsRaw.map(a => String(a).trim()).filter(Boolean);\n  } else if (typeof addonsRaw === 'string') {\n    addons = addonsRaw.split(',').map(s => s.trim()).filter(Boolean);\n  }\n\n  const flags =\n    (ctx0.flags && typeof ctx0.flags === 'object')\n      ? ctx0.flags\n      : (body.flags || {});\n\n  return {\n    ...ctx0,\n    orderId,\n    candidateName,\n    email,\n    package: pkg,\n    jobDescription,\n    addons,\n    flags,\n  };\n})()\n}}",
              "type": "string"
            },
            {
              "id": "e5cf5e4a-3508-431c-8496-a3eb6c29ef56",
              "name": "=candidateName",
              "value": "={{ $json.ctx?.candidateName || $json.body?.candidateName || $json.candidateName || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4416,
        384
      ],
      "id": "52417364-284f-41aa-9325-500890ca1a0f",
      "name": "joinKey1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a231b1eb-a02b-486e-ab77-03efdf9b53b6",
              "name": "=joinKey",
              "value": "={{ $json.ctx?.orderId || $json.orderId || $json.order_id || $json.joinKey || '' }}\n",
              "type": "string"
            },
            {
              "id": "2d2982d6-5868-4193-bbc5-48f8cec183b1",
              "name": "=cvRewriteText",
              "value": "={{ \n  $json.cvRewriteText\n  || $json.choices?.[0]?.message?.content\n  || $json.message?.content\n  || $json.data?.choices?.[0]?.message?.content\n  || $json.output_text\n  || ''\n}}",
              "type": "string"
            },
            {
              "id": "0cc4e300-ae4e-45d4-b405-fd2bdf9d9f14",
              "name": "=ctx",
              "value": "={{ $json.ctx || {\n  orderId: $json.orderId || $json.order_id || '',\n  email: $json.email || '',\n  candidateName: $json.candidateName || '',\n  package: $json.package || $json.packageTier || '',\n  addons: $json.addons || [],\n  jobDescription: $json.jobDescription || '',\n  cvText: $json.cvText || '',\n  rewrittenCVText: $json.rewrittenCVText || ''\n} }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7072,
        -48
      ],
      "id": "790a0ea8-b6ae-4c0a-9cd1-7980cd35a873",
      "name": "Capture Rewrite1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a231b1eb-a02b-486e-ab77-03efdf9b53b6",
              "name": "=joinKey",
              "value": "={{ $json.ctx?.orderId || $json.orderId || $json.order_id || $json.joinKey || '' }}\n",
              "type": "string"
            },
            {
              "id": "2d2982d6-5868-4193-bbc5-48f8cec183b1",
              "name": "=cvRewriteText",
              "value": "={{ \n  $json.cvRewriteText\n  || $json.choices?.[0]?.message?.content\n  || $json.message?.content\n  || $json.data?.choices?.[0]?.message?.content\n  || $json.output_text\n  || ''\n}}",
              "type": "string"
            },
            {
              "id": "0cc4e300-ae4e-45d4-b405-fd2bdf9d9f14",
              "name": "=ctx",
              "value": "={{ $json.ctx || {\n  orderId: $json.orderId || $json.order_id || '',\n  email: $json.email || '',\n  candidateName: $json.candidateName || '',\n  package: $json.package || $json.packageTier || '',\n  addons: $json.addons || [],\n  jobDescription: $json.jobDescription || '',\n  cvText: $json.cvText || '',\n  rewrittenCVText: $json.rewrittenCVText || ''\n} }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7072,
        144
      ],
      "id": "69850365-d4ff-4d2c-96fc-610138ad0991",
      "name": "Capture Rewrite2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a231b1eb-a02b-486e-ab77-03efdf9b53b6",
              "name": "=joinKey",
              "value": "={{ $json.ctx?.orderId || $json.orderId || $json.order_id || $json.joinKey || '' }}\n",
              "type": "string"
            },
            {
              "id": "2d2982d6-5868-4193-bbc5-48f8cec183b1",
              "name": "=cvRewriteText",
              "value": "={{ \n  $json.cvRewriteText\n  || $json.choices?.[0]?.message?.content\n  || $json.message?.content\n  || $json.data?.choices?.[0]?.message?.content\n  || $json.output_text\n  || ''\n}}",
              "type": "string"
            },
            {
              "id": "0cc4e300-ae4e-45d4-b405-fd2bdf9d9f14",
              "name": "=ctx",
              "value": "={{ $json.ctx || {\n  orderId: $json.orderId || $json.order_id || '',\n  email: $json.email || '',\n  candidateName: $json.candidateName || '',\n  package: $json.package || $json.packageTier || '',\n  addons: $json.addons || [],\n  jobDescription: $json.jobDescription || '',\n  cvText: $json.cvText || '',\n  rewrittenCVText: $json.rewrittenCVText || ''\n} }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7072,
        336
      ],
      "id": "0d4b3fab-18a7-4f7a-8a8b-afeade4184e1",
      "name": "Capture Rewrite3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "eb1dc396-33fe-4a4b-b41e-71a3252da346",
              "name": "rewrittenCVText",
              "value": "=={{   $json.cvRewriteText   || $json.cvRewriteText_1  || $json.cvRewriteText_2  || $json.cvRewriteText_3  || ''}}",
              "type": "string"
            },
            {
              "id": "96cae4bc-66f3-4c6d-89c9-735def4883c0",
              "name": "",
              "value": "",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7296,
        -144
      ],
      "id": "075ded3c-88bd-4ec4-9cb8-25fe53e29329",
      "name": "cvRewriteText (final)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b91e1f9b-18e3-473f-b2dc-ff7147481fab",
              "name": "=status",
              "value": "accepted",
              "type": "string"
            },
            {
              "id": "a1b3ffb1-5503-4019-8be2-9aa4e944b54c",
              "name": "orderId",
              "value": "={{ $json.ctx?.orderId || $json.body?.orderId || $json.orderId || '' }}",
              "type": "string"
            },
            {
              "id": "ca0aaad9-a005-41d1-a3fa-0b0e8eb093ce",
              "name": "=message",
              "value": "Processing started. You will receive results by email shortly.",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5760,
        384
      ],
      "id": "ac8f8e12-33b5-4429-844c-f9e21e81d93b",
      "name": "Ack Payload"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "joinKey",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        8416,
        -208
      ],
      "id": "87de5fbe-1125-4f00-95c4-b2b6eb5c6fd0",
      "name": "Merge1"
    },
    {
      "parameters": {
        "driveId": "=Ai-Vitae CVs",
        "folderId": "=1vpKP_zlqScqx8Ms9fWhGWqCs0f7jxS4H",
        "title": "={{\n  `Cover Letter - ${$json.ctx?.candidateName || $json.candidateName || 'Candidate'} - ${$json.joinKey || $json.ctx?.orderId || $json.orderId || ''}`\n}}\n"
      },
      "type": "n8n-nodes-base.googleDocs",
      "typeVersion": 2,
      "position": [
        12496,
        -400
      ],
      "id": "32e0d2d4-fbcc-4100-8650-5e1c76f83230",
      "name": "Create Cover Letter Doc"
    },
    {
      "parameters": {
        "operation": "update",
        "documentURL": "={{ $json.documentId || $json.id }}",
        "actionsUi": {
          "actionFields": [
            {
              "action": "insert",
              "text": "={{\n  (\n    $items(\"Capture Cover Letter\", 0)[0]?.json?.coverLetterText\n    || $items(\"Message a model\", 0)[0]?.json?.coverLetterText\n    || $items(\"Message a model\", 0)[0]?.json?.choices?.[0]?.message?.content\n    || $items(\"Message a model\", 0)[0]?.json?.message?.content\n    || ''\n  ).toString().trim()\n}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.googleDocs",
      "typeVersion": 2,
      "position": [
        12720,
        -400
      ],
      "id": "9f87ea0b-036b-4d34-a4c8-7a9cf2741e8f",
      "name": "Write Cover Letter Content"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{$json.documentId || $json.id}}",
          "mode": "id"
        },
        "options": {
          "googleFileConversion": {
            "conversion": {
              "docsToFormat": "application/pdf"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        12944,
        -400
      ],
      "id": "13eb3c57-8045-4bfa-9343-c9524bd6f49f",
      "name": "Download Cover Letter PDF"
    },
    {
      "parameters": {
        "jsCode": "// Rename Google Drive's default binary field \"data\" -> \"coverLetter\"\nconst item = items[0];\n\nif (!item.binary?.data) {\n  throw new Error('Expected binary field \"data\" from Download node, but none found.');\n}\n\nitem.binary.coverLetter = item.binary.data;\ndelete item.binary.data;\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13392,
        -400
      ],
      "id": "30e00bec-50f5-4e42-9fac-431ce60555af",
      "name": "Move Binary Data"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "05a91e2e-f4bf-4551-bea9-09bc5d9934e4",
              "name": "=pgCoverInserted",
              "value": "=true",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        14080,
        -272
      ],
      "id": "46fc0d01-d7b1-4444-bed8-bad9d42307ca",
      "name": "Set joinKey"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "joinKey",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        13888,
        -272
      ],
      "id": "7548afa5-6d7f-413d-aedb-3c67f43bc815",
      "name": "Merge by Key"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "05a91e2e-f4bf-4551-bea9-09bc5d9934e4",
              "name": "=joinKey",
              "value": "={{\n  $json.joinKey\n  || $json.orderId\n  || $json.ctx?.orderId\n  || $items(\"Reattach Context1\", 0)[0]?.json?.joinKey\n  || $items(\"Reattach Context1\", 0)[0]?.json?.ctx?.orderId\n  || ''\n}}",
              "type": "string"
            },
            {
              "id": "3045ee38-e2c8-4e39-b55f-6a49f8958f60",
              "name": "=orderId",
              "value": "={{\n  $json.orderId\n  || $json.ctx?.orderId\n  || $items(\"Reattach Context1\", 0)[0]?.json?.ctx?.orderId\n  || $items(\"Reattach Context1\", 0)[0]?.json?.joinKey\n  || ''\n}}",
              "type": "string"
            },
            {
              "id": "695e5c64-ce58-465d-a3b9-4dbf32b76c88",
              "name": "=ctx",
              "value": "={{ $json.ctx || {} }}",
              "type": "object"
            },
            {
              "id": "a67e2074-a029-4eb5-a6da-2edbbd9c6603",
              "name": "=coverLetterKey",
              "value": "={{ $json.coverLetterKey || $json.Key || '' }}",
              "type": "string"
            },
            {
              "id": "f5d91ef0-2e6f-4a80-a170-435ed4bc7266",
              "name": "=coverLetterUrl",
              "value": "={{ $json.coverLetterUrl || $json.Location || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        13760,
        -400
      ],
      "id": "cdda2829-7c2e-4823-858f-63ff674531ac",
      "name": "Reattach Context2"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        9840,
        -80
      ],
      "id": "56002d83-2259-4bb5-896c-2a43926d17db",
      "name": "Merge2"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        14352,
        -80
      ],
      "id": "a0587ec5-6f7d-4cde-984d-16816738aaa6",
      "name": "Merge3"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [
        -6432,
        720
      ],
      "id": "5380e04f-8a2b-4233-b339-505d5f069936",
      "name": "Error Handler"
    },
    {
      "parameters": {
        "jsCode": "// Rate Limiting Node\n// Place after Webhook Intake\n\nconst ip = $json.headers?.['x-forwarded-for'] || $json.headers?.['x-real-ip'] || 'unknown';\nconst email = String($json.body?.email || '').toLowerCase();\n\n// Use n8n static data for rate tracking\nconst staticData = $getWorkflowStaticData('global');\nconst now = Date.now();\nconst windowMs = 60000; // 1 minute window\nconst maxRequests = 10; // max 10 requests per minute per IP\n\n// Initialize or clean old entries\nif (!staticData.rateLimits) staticData.rateLimits = {};\nconst limits = staticData.rateLimits;\n\n// Clean entries older than window\nObject.keys(limits).forEach(key => {\n  limits[key] = limits[key].filter(ts => now - ts < windowMs);\n  if (limits[key].length === 0) delete limits[key];\n});\n\n// Check rate limit\nconst ipRequests = limits[ip] || [];\nif (ipRequests.length >= maxRequests) {\n  throw new Error(`Rate limit exceeded for IP ${ip}. Max ${maxRequests} requests per minute.`);\n}\n\n// Record this request\nlimits[ip] = [...ipRequests, now];\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6176,
        288
      ],
      "id": "d27b6117-57ac-4533-9636-edd98b138f78",
      "name": "Rate Limiter"
    },
    {
      "parameters": {
        "jsCode": "// Idempotency Check\n// Prevents duplicate order processing\n\nconst orderId = $json.orderId || $json.body?.orderId || '';\nif (!orderId) {\n  // No orderId yet, pass through\n  return $input.all();\n}\n\nconst staticData = $getWorkflowStaticData('global');\n\nif (!staticData.processedOrders) staticData.processedOrders = {};\n\n// Check if already processed (within last 24 hours)\nconst now = Date.now();\nconst processed = staticData.processedOrders[orderId];\nif (processed && (now - processed.timestamp) < 86400000) {\n  // Already processed within 24 hours - skip processing\n  return [{\n    json: {\n      ...$json,\n      isDuplicate: true,\n      originalProcessedAt: new Date(processed.timestamp).toISOString(),\n      message: 'Order already processed'\n    }\n  }];\n}\n\n// Mark as processing\nstaticData.processedOrders[orderId] = { timestamp: now, status: 'processing' };\n\n// Clean old entries (older than 24 hours)\nObject.keys(staticData.processedOrders).forEach(key => {\n  if (now - staticData.processedOrders[key].timestamp > 86400000) {\n    delete staticData.processedOrders[key];\n  }\n});\n\nreturn [{\n  json: {\n    ...$json,\n    isDuplicate: false\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5952,
        256
      ],
      "id": "318f24d3-5dbe-4d8d-8213-8c0968445b42",
      "name": "Idempotency Check"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { status: 'error', code: 'INVALID_PACKAGE', message: 'Invalid package tier: ' + ($json.packageTier || $json.package || 'unknown') + '. Valid options: starter, standard, premium, executive.' } }}",
        "options": {
          "responseCode": 400
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        5728,
        720
      ],
      "id": "c0b88a47-6016-48d3-aabb-70b9c00f1f6e",
      "name": "Error - Unknown Package Tier"
    }
  ],
  "connections": {
    "Rewrite CV": {
      "main": [
        [
          {
            "node": "Capture Rewrite",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalise & Validate": {
      "main": [
        [
          {
            "node": "Add Ons",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "CV < 5MB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Message - No CV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDF - Text": {
      "main": [
        [
          {
            "node": "Merge10",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "File Type": {
      "main": [
        [
          {
            "node": "PDF - Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "DOCX - Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "DOC - Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "TXT Field",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CV < 5MB": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "CV too Large",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scan Upload": {
      "main": [
        [
          {
            "node": "Restore Binary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Clean": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "CV Infected",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF JD Provided": {
      "main": [
        [
          {
            "node": "Code - Ensure orderID",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "JD Required",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rewrite CV1": {
      "main": [
        [
          {
            "node": "Capture Rewrite1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Standard - Proofread CV": {
      "main": [
        [
          {
            "node": "Executive - Format CV Layout",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Starter - Proofread CV": {
      "main": [
        [
          {
            "node": "Capture Rewrite2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extra Cover Letter": {
      "main": [
        [
          {
            "node": "Cover Letter - Generate",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "LinkedIn Optimization1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Editable Word": {
      "main": [
        [
          {
            "node": "Build HTML",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "One Day Delivery",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "One Day Delivery": {
      "main": [
        [
          {
            "node": "SLA MetaData",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validate - Has Schema and OrderId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cover Letter - Generate": {
      "main": [
        [
          {
            "node": "Capture Cover Letter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sanitize JD": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Config": {
      "main": [
        [
          {
            "node": "If UUID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Ensure orderID": {
      "main": [
        [
          {
            "node": "Update Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Have binary CV": {
      "main": [
        [
          {
            "node": "Upload Original CV",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge: Ready to Upload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "cvText - Binary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload Original CV": {
      "main": [
        [
          {
            "node": "Remember cv_orig_key",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Remember cv_orig_key": {
      "main": [
        [
          {
            "node": "Add Doc(cv_original)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Doc(cv_original)": {
      "main": [
        [
          {
            "node": "Ack AddDoc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cvText - Binary": {
      "main": [
        [
          {
            "node": "Merge: Ready to Upload",
            "type": "main",
            "index": 0
          },
          {
            "node": "Upload Original CV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload LinkedIn": {
      "main": [
        [
          {
            "node": "Postgres - Add Doc(linkedin)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres - Add Doc(linkedin)": {
      "main": [
        [
          {
            "node": "Editable Word",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet": {
      "main": [
        [
          {
            "node": "Execute a SQL query1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Premium - CV Rewrite (Claude Sonnet)": {
      "main": [
        [
          {
            "node": "Capture Rewrite2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Executive - CV Rewrite (Claude Opus)": {
      "main": [
        [
          {
            "node": "Capture Rewrite3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Executive - Format CV Layout": {
      "main": [
        [
          {
            "node": "Capture Rewrite3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Scan Upload",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "cvExt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cvExt": {
      "main": [
        [
          {
            "node": "fileType",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fileType": {
      "main": [
        [
          {
            "node": "File Type",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge10": {
      "main": [
        [
          {
            "node": "IF JD Provided",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge11": {
      "main": [
        [
          {
            "node": "Have binary CV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge: Ready to Upload": {
      "main": [
        [
          {
            "node": "Build Keys",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ack AddDoc": {
      "main": [
        [
          {
            "node": "Merge: Ready to Upload",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Add Ons": {
      "main": [
        [
          {
            "node": "Sanitize JD",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Order Flags": {
      "main": [
        [
          {
            "node": "Merge11",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Restore Binary": {
      "main": [
        [
          {
            "node": "IF Clean",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LinkedIn Optimization1": {
      "main": [
        [
          {
            "node": "LI Build Sections1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Editable Word",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LI Build Sections1": {
      "main": [
        [
          {
            "node": "Capture LinkedIn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate & Clean2": {
      "main": [
        [
          {
            "node": "Upload LinkedIn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Keys": {
      "main": [
        [
          {
            "node": "Extract CV Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture Rewrite": {
      "main": [
        [
          {
            "node": "cvRewriteText (final)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Flags": {
      "main": [
        [
          {
            "node": "Entitlements",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Entitlements": {
      "main": [
        [
          {
            "node": "Model & Prompt Params (Package - Model)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Model & Prompt Params (Package - Model)": {
      "main": [
        [
          {
            "node": "Guard Node1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture Cover Letter": {
      "main": [
        [
          {
            "node": "Create Cover Letter Doc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload CoverLetter1": {
      "main": [
        [
          {
            "node": "Reattach Context2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres - Add Doc(cover)1": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Rewrite CV",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Rewrite CV1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Premium - CV Rewrite (Claude Sonnet)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Executive - CV Rewrite (Claude Opus)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error - Unknown Package Tier",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture LinkedIn": {
      "main": [
        [
          {
            "node": "Validate & Clean2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build HTML": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2": {
      "main": [
        [
          {
            "node": "Upload DOCX",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload DOCX": {
      "main": [
        [
          {
            "node": "Postgres - Add Doc1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres - Add Doc1": {
      "main": [
        [
          {
            "node": "One Day Delivery",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SLA MetaData": {
      "main": [
        [
          {
            "node": "Postgres - Update Order Priority",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres - Update Order Priority": {
      "main": [
        [
          {
            "node": "Validate - Has Schema and OrderId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "List Documents for Order": {
      "main": [
        [
          {
            "node": "Shape Documents Map",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Shape Documents Map": {
      "main": [
        [
          {
            "node": "Validate - Has OrderId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark Order Done": {
      "main": [
        [
          {
            "node": "Reattach Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize String": {
      "main": [
        [
          {
            "node": "Normalize - Addon Flags to Boolean",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize - Addon Flags to Boolean": {
      "main": [
        [
          {
            "node": "Flags",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate - Has Schema and OrderId": {
      "main": [
        [
          {
            "node": "List Documents for Order",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Shape Documents Map",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate - Has OrderId": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Mark Order Done",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If UUID": {
      "main": [
        [
          {
            "node": "Build Keys1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Upsert Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture orderId": {
      "main": [
        [
          {
            "node": "Build Keys1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Keys1": {
      "main": [
        [
          {
            "node": "Normalise & Validate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Order": {
      "main": [
        [
          {
            "node": "Capture orderId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Order": {
      "main": [
        [
          {
            "node": "Upsert Order Flags",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cover Letter Rewrite": {
      "main": [
        [
          {
            "node": "Capture Rewrite1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cover Letter Rewrite1": {
      "main": [
        [
          {
            "node": "Starter - Proofread CV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cover Letter Rewrite2": {
      "main": [
        [
          {
            "node": "Standard - Proofread CV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guard Node1": {
      "main": [
        [
          {
            "node": "Context (carry)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Trigger Email Workflow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reattach Context": {
      "main": [
        [
          {
            "node": "Compute Token Cost",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Context (carry)": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query1": {
      "main": [
        [
          {
            "node": "Assemble Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Intake": {
      "main": [
        [
          {
            "node": "Rate Limiter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Row for Sheets": {
      "main": [
        [
          {
            "node": "Append or update row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Assemble Response": {
      "main": [
        [
          {
            "node": "Execute a SQL query1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compute Token Cost": {
      "main": [
        [
          {
            "node": "Prepare Row for Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract CV Text": {
      "main": [
        [
          {
            "node": "Normalize String",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "File Type Routing": {
      "main": [
        [
          {
            "node": "CloudConvert",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract from File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CloudConvert": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "joinKey1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File1": {
      "main": [
        [
          {
            "node": "joinKey1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cvRewriteText": {
      "main": [
        [
          {
            "node": "Stash Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Execute a SQL query2": {
      "main": [
        [
          {
            "node": "Merge SQL + Payload",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Prepare Document Row": {
      "main": [
        [
          {
            "node": "Execute a SQL query2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge SQL + Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download file": {
      "main": [
        [
          {
            "node": "Add joinKey to DocResult",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Docs": {
      "main": [
        [
          {
            "node": "Google Docs - Write Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Docs - Write Content": {
      "main": [
        [
          {
            "node": "Download file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DOCX - Text": {
      "main": [
        [
          {
            "node": "Merge10",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "DOC - Text": {
      "main": [
        [
          {
            "node": "Merge10",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "TXT Field": {
      "main": [
        [
          {
            "node": "Merge10",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Stash Metadata": {
      "main": [
        [
          {
            "node": "File Type Routing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Input": {
      "main": [
        [
          {
            "node": "Set - Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge SQL + Payload": {
      "main": [
        [
          {
            "node": "Reattach Context1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reattach Context1": {
      "main": [
        [
          {
            "node": "Normalize Payload",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge by Key",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Payload": {
      "main": [
        [
          {
            "node": "Extra Cover Letter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Upload Result + Context": {
      "main": [
        [
          {
            "node": "Collapse To One",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Collapse To One": {
      "main": [
        [
          {
            "node": "Prepare Document Row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add joinKey to DocResult": {
      "main": [
        [
          {
            "node": "Merge Back",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Stash Context": {
      "main": [
        [
          {
            "node": "Google Docs",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Back",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Back": {
      "main": [
        [
          {
            "node": "Collapse To One1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Collapse To One1": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build ctx": {
      "main": [
        [
          {
            "node": "Validate Intake",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Intake": {
      "main": [
        [
          {
            "node": "Ack Payload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond 202": {
      "main": [
        [
          {
            "node": "Stash Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "joinKey1": {
      "main": [
        [
          {
            "node": "Normalize Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture Rewrite1": {
      "main": [
        [
          {
            "node": "cvRewriteText (final)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture Rewrite2": {
      "main": [
        [
          {
            "node": "cvRewriteText (final)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture Rewrite3": {
      "main": [
        [
          {
            "node": "cvRewriteText (final)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cvRewriteText (final)": {
      "main": [
        [
          {
            "node": "cvRewriteText",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ack Payload": {
      "main": [
        [
          {
            "node": "Respond 202",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Google Docs - Write Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Cover Letter Doc": {
      "main": [
        [
          {
            "node": "Write Cover Letter Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write Cover Letter Content": {
      "main": [
        [
          {
            "node": "Download Cover Letter PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Cover Letter PDF": {
      "main": [
        [
          {
            "node": "Move Binary Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Move Binary Data": {
      "main": [
        [
          {
            "node": "Upload CoverLetter1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set joinKey": {
      "main": [
        [
          {
            "node": "Postgres - Add Doc(cover)1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge3",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge by Key": {
      "main": [
        [
          {
            "node": "Set joinKey",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reattach Context2": {
      "main": [
        [
          {
            "node": "Merge by Key",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Edit Fields4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge3": {
      "main": [
        [
          {
            "node": "LinkedIn Optimization1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Handler": {
      "main": [
        [
          {
            "node": "Trigger Email Workflow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rate Limiter": {
      "main": [
        [
          {
            "node": "Idempotency Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Idempotency Check": {
      "main": [
        [
          {
            "node": "Validate Intake",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error - Unknown Package Tier": {
      "main": [
        [
          {
            "node": "Report a failed Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": true
  },
  "versionId": "9ded9dda-4b04-4060-899a-d67f07b058ea",
  "meta": {},
  "id": "6CE5jhRjCdkmLVvR-EQlK",
  "tags": []
}
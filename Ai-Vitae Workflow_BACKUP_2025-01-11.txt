{
  "name": "Ai-Vitae Workflow",
  "nodes": [
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "id"
        },
        "messages": {
          "values": [
            {
              "content": "=You are an expert CV writer, resume optimization specialist, and ATS consultant.\n\nYou must rewrite and optimize CVs using ONLY the information provided.\nYou must never invent, guess, or fabricate any details.\n\nNON-NEGOTIABLE RULES:\n- Do NOT invent roles, responsibilities, employers, dates, tools, certifications, or metrics.\n- Use metrics ONLY if explicitly present or clearly implied; never fabricate numbers.\n- If information is missing, OMIT it entirely (no placeholders).\n- Preserve factual accuracy at all times.\n\nCANONICAL IDENTITY (MANDATORY):\n- The official candidate name provided is the source of truth.\n- If the CV contains a different name, DO NOT use it anywhere.\n- If a name header is included, it must use ONLY the official candidate name.\n- Do not invent or infer contact details; omit them if missing.\n\nATS & FORMAT RULES:\n- No tables, columns, emojis, or special characters.\n- Clean single-column text only.\n- Use clear section headings.\n- Bullet points must start with a hyphen (â€œ-â€).\n- Current role = present tense; past roles = past tense.\n\nOUTPUT RULES:\n- Return ONLY the final rewritten CV.\n- No commentary, explanations, or meta text.\n- Do NOT include markers such as â€œCV STARTâ€ or â€œCV ENDâ€.",
              "role": "system"
            },
            {
              "content": "=Rewrite the candidateâ€™s CV to strongly align with the target Job Description.\nImprove clarity, structure, and impact while preserving complete factual accuracy.\n\nPRIORITIES:\n- Emphasize skills and responsibilities most relevant to the Job Description.\n- Naturally mirror role-relevant keywords (no keyword stuffing).\n- Rewrite bullets using strong action verbs and outcome-focused language.\n- Maintain appropriate seniority based on the candidateâ€™s actual experience.\n\nREQUIRED OUTPUT STRUCTURE:\n- Professional Summary (3â€“5 lines, no first-person)\n- Core Skills (10â€“12 skills present in candidate history)\n- Professional Experience (reverse chronological, 4â€“7 bullets per role)\n- Education\n- Certifications (only if present)\n- Tools & Platforms (only if present)\n\nOFFICIAL CANDIDATE NAME (SOURCE OF TRUTH):\n{{ $json.ctx?.candidateName || $json.candidateName || '' }}\n\nCANDIDATE CV (RAW TEXT):\n{{ $json.cvText || '' }}\n\nJOB DESCRIPTION:\n{{ $json.jobDescription || '' }}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        9904,
        240
      ],
      "id": "6cfa13c2-1e88-428d-a85e-bf0ec27ef3e6",
      "name": "Rewrite CV",
      "alwaysOutputData": false,
      "credentials": {
        "openAiApi": {
          "id": "yJxo3UoYqsd6bATu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// --- Normalise & Validate ---\n// Mode: Run Once for All Items   â€¢   Language: JavaScript\n\nconst inItems = items || [];\n\n// find config + data items\nconst cfgItem = inItems.find(it => it?.json && it.json._cfg);\nconst dataItem = inItems.find(it =>\n  it?.json && (\n    (it.json.body && Object.keys(it.json.body).length > 0) ||\n    it.json.package !== undefined ||\n    it.json.verifiedPackage !== undefined ||\n    it.json.headers !== undefined ||\n    (it.binary && Object.keys(it.binary || {}).length)\n  )\n) || inItems[0] || { json: {}, binary: {} };\n\n// Pull json/binary\nconst inJsonRaw = dataItem.json || {};\nconst hasBody = inJsonRaw.body && Object.keys(inJsonRaw.body).length > 0;\nconst src = hasBody ? inJsonRaw.body : inJsonRaw;\n\n// --- alias any binary key to `cv` (handles cv0, cv1, etc.) ---\nconst binRaw = dataItem.binary || {};\nconst bin = { ...binRaw };\nconst binKeys = Object.keys(binRaw);\nif (!bin.cv && binKeys.length) {\n  const pick = binKeys.find(k => k.startsWith('cv')) || binKeys[0];\n  bin.cv = binRaw[pick];\n}\n\n// ---- config ----\nconst rawCfg = (cfgItem?.json?._cfg) || (inJsonRaw._cfg) || {};\nlet cfg = { ...rawCfg };\nif (typeof cfg.prices === 'string') {\n  try { cfg.prices = JSON.parse(cfg.prices); } catch { cfg.prices = {}; }\n}\n\n// ---------- helpers ----------\nfunction sizeMB(b) {\n  try {\n    if (!b || !b.data) return 0;\n    const bytes = Buffer.from(b.data, 'base64').length;\n    return Math.round((bytes / (1024 * 1024)) * 100) / 100;\n  } catch { return 0; }\n}\nfunction extFromNameOrMime(b) {\n  try {\n    if (!b) return null;\n    if (b.fileName) {\n      const i = b.fileName.lastIndexOf('.');\n      if (i >= 0) return b.fileName.slice(i + 1).toLowerCase();\n    }\n    const m = (b.mimeType || '').toLowerCase();\n    const map = {\n      'text/plain': 'txt',\n      'application/pdf': 'pdf',\n      'application/msword': 'doc',\n      'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',\n    };\n    return map[m] || null;\n  } catch { return null; }\n}\nfunction parseAddons(v) {\n  if (Array.isArray(v)) return v.map(a => String(a).trim().toLowerCase()).filter(Boolean);\n  if (typeof v === 'string') {\n    const t = v.trim();\n    if (!t) return [];\n    try { const p = JSON.parse(t); if (Array.isArray(p)) return p.map(a => String(a).trim().toLowerCase()).filter(Boolean); } catch {}\n    return t.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);\n  }\n  return [];\n}\nfunction uuid() {\n  return (global.crypto && global.crypto.randomUUID\n    ? global.crypto.randomUUID()\n    : require('crypto').randomUUID());\n}\nfunction normEmail(v) {\n  const e = String(v || '').trim().toLowerCase();\n  // Enhanced email validation regex\n  const emailRegex = /^[a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;\n  if (!emailRegex.test(e)) return '';\n  // Block common disposable email domains\n  const disposable = ['tempmail.com', 'throwaway.com', 'mailinator.com', 'guerrillamail.com', '10minutemail.com', 'fakeinbox.com'];\n  const domain = e.split('@')[1];\n  if (disposable.includes(domain)) return '';\n  return e;\n}\n\n// ---------- package normalization (strict) ----------\nconst rawPkg = String(src.package ?? src.verifiedPackage ?? '').trim();\nconst norm   = rawPkg.toLowerCase();\nconst pkgMap = {\n  'starter':'starter','standard':'standard','premium':'premium','executive':'executive',\n  'start':'starter','basic':'starter','std':'standard','pro':'premium','plus':'premium','exec':'executive','executive+':'executive'\n};\nconst allowedTiers = new Set(['starter','standard','premium','executive']);\n\nlet packageTier  = null;\nlet packageLabel = '';\nlet packageMissing = false;\nlet packageUnknown = false;\n\nif (!rawPkg) {\n  packageMissing = true;\n} else {\n  const mapped = pkgMap[norm] || norm;\n  if (allowedTiers.has(mapped)) { packageTier = mapped; packageLabel = rawPkg; }\n  else { packageUnknown = true; packageLabel = rawPkg; }\n}\n\n// ---------- file info (robust .txt recognition) ----------\nconst cvExt  = extFromNameOrMime(bin.cv);\nconst cvSize = sizeMB(bin.cv);\n\n// ---------- email ----------\nconst emailRaw =\n  src.email || src.userEmail || src.contact || src.verifiedEmail || src.stripeEmail || '';\nconst email = normEmail(emailRaw);\nconst emailValid = Boolean(email);\n\n// ---------- addons (normalize + flags) ----------\nconst rawAddons = src.addons ?? src.verifiedAddons ?? '';\nconst addons = parseAddons(rawAddons);\n\n// accept a few common synonyms/aliases\nconst hasExtraCoverLetter =\n  addons.includes('extracoverletter') || addons.includes('extra_cover_letter') || addons.includes('coverletter+');\n\nconst isOneDayDelivery =\n  addons.includes('oneday') || addons.includes('one-day') || addons.includes('1day') || addons.includes('priority') || addons.includes('rush');\n\nconst needsEditableWord =\n  addons.includes('editableword') || addons.includes('docx') || addons.includes('word');\n\nconst hasLinkedIn =\n  addons.includes('linkedin') || addons.includes('linkedinoptimize') || addons.includes('linkedin_optimization') || addons.includes('linkedin-optimization');\n\n// ---------- assemble output ----------\nconst allowedExts = ['pdf','doc','docx','txt'];\n\nconst out = {\n  _cfg: cfg,\n\n  // NOTE: this is a provisional id for early flow; your Insert Order returns the UUID later\n  orderId: src.orderId || src.verifiedOrderId || uuid(),\n\n  package: packageLabel,\n  packageTier,\n  packageMissing,\n  packageUnknown,\n\n  // add-ons (raw & normalized + convenience flags)\n  _ctx: { ...(inJsonRaw._ctx || {}), rawAddons },\n  addons,\n  hasExtraCoverLetter,\n  isOneDayDelivery,\n  needsEditableWord,\n  hasLinkedIn,\n  hasAnyAddons: addons.length > 0,\n  addonCount: addons.length,\n\n  candidateName: String(src.candidateName ?? src.candidate ?? '').trim(),\n  email,\n  emailValid,\n  jobDescription: String(src.jobDescription ?? src.jd ?? '').trim(),\n\n  cvExt,\n  cvSize,\n  cvOversize: cvSize > 5,                // 5 MB\n  allowedExts,\n  source: 'web',\n};\n\n// optional price\nif (cfg.prices && packageTier) {\n  const p = cfg.prices[packageTier];\n  out.price = (p !== undefined && p !== null) ? Number(p) : null;\n}\n\n// ---------- flags for routing / IF ----------\nconst hasText   = out.jobDescription.length > 0;\nconst hasCv     = !!bin.cv;\nconst cvAllowed = hasCv ? allowedExts.includes((cvExt || '').toLowerCase()) : true;\nconst cvOk      = hasCv ? (cvAllowed && !out.cvOversize) : true;\n\nout.hasText   = hasText;\nout.hasCv     = hasCv;\nout.cvAllowed = cvAllowed;\nout.cvOk      = cvOk;\n// pass if (text) or (good CV) AND valid email\nout.readyForAI = (hasText || (hasCv && cvOk)) && out.emailValid;\n\nreturn [{ json: out, binary: bin }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        864
      ],
      "id": "4fa5b45e-354d-4548-82ff-53a74e196fc6",
      "name": "Normalise & Validate"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5091387b-769e-4bb9-ae7c-0def7800077b",
              "leftValue": "={{$json.readyForAI}}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1008,
        960
      ],
      "id": "2631a43a-bcfb-44d6-a5f8-1b55b905e76e",
      "name": "If"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {
          "responseCode": 400,
          "responseKey": "={\n  \"status\": \"error\",\n  \"message\": \"No CV file uploaded. Please attach a PDF, DOCX, DOC or TXT.\"\n}\n\n"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1232,
        960
      ],
      "id": "8a51ddb9-587f-4c2c-9ffe-bde7ae55e538",
      "name": "Error Message - No CV"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.pdf.co/v1/pdf/convert/to/text",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "cv",
        "options": {
          "response": {
            "response": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3248,
        -96
      ],
      "id": "084a00c6-c5a5-4920-8a66-84a0510e7e3f",
      "name": "PDF - Text",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 3000,
      "onError": "continueErrorOutput",
      "credentials": {
        "httpHeaderAuth": {
          "id": "3XvhbUxK8iU6x7Hw",
          "name": "Header Auth account 2"
        }
      }
    },
    {
      "parameters": {
        "mode": "expression",
        "numberOutputs": 5,
        "output": "={{\n  ( { pdf:0, docx:1, doc:2, txt:3 } )[\n    String(\n      $json.fileType\n      || $json.cvExt\n      || $json.extResolved\n      || $json.fileExtension\n      || ($binary.cv  && $binary.cv.fileName  ? $binary.cv.fileName.split('.').pop()  : '')\n      || ($binary.cv0 && $binary.cv0.fileName ? $binary.cv0.fileName.split('.').pop() : '')\n      || ''\n    ).trim().toLowerCase()\n  ] || 5\n}}\n\n",
        "looseTypeValidation": true
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3024,
        192
      ],
      "id": "ee8e411d-3989-478c-bf5f-0dbb64a78108",
      "name": "File Type"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "840f0da9-4f91-4158-a548-6113b1a75965",
              "name": "=ctx.cvText",
              "value": "={{ $json.extractedText || $json.text || $json.body || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3472,
        -96
      ],
      "id": "8f75980b-0a50-48b5-b9e6-4edd4e3be39e",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "de93fa8d-5fb6-420c-8dda-8e12351b3af0",
              "name": "=ctx.cvText",
              "value": "={{ $json.extractedText || $json.text || $json.body || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3472,
        288
      ],
      "id": "c9581293-f0bc-456c-a90f-c1c20ffc8303",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {
          "responseCode": "=400",
          "responseKey": "{   \"status\": \"error\",   \"message\": \"Unsupported File type. Please upload PDF, DOCX, DOC or TXT.\" }"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        3248,
        624
      ],
      "id": "190e8799-217d-4d17-8abe-e9380f8c6822",
      "name": "Error Message"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {
          "responseCode": 413,
          "responseKey": "{ \"status\":\"error\", \"message\":\"CV exceeds 5MB. Please upload a smaller file.\" }"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1456,
        768
      ],
      "id": "60c7cec9-b805-4d92-8a5f-174cbe42d943",
      "name": "CV too Large"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3e11310a-30e3-490c-ab16-4e50a7d9bda2",
              "leftValue": "={{$json.cvOversize}}",
              "rightValue": "false",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1232,
        768
      ],
      "id": "a0d72904-cbe5-40b3-bcfc-ea131d76b03e",
      "name": "CV < 5MB"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.cloudmersive.com/virus/scan/file/advanced",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpCustomAuth",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "inputFile",
              "inputDataFieldName": "cv"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1680,
        576
      ],
      "id": "1720e638-5634-4a6b-b35c-3d20d498eeca",
      "name": "Scan Upload",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "onError": "continueErrorOutput",
      "credentials": {
        "httpHeaderAuth": {
          "id": "ZG4WmdwVammszEXN",
          "name": "Header Auth account 3"
        },
        "httpCustomAuth": {
          "id": "Ktnspfbon2w9egQ7",
          "name": "Custom Auth account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "db998032-6dc3-4457-b42f-cada6c3d206f",
              "leftValue": "={{$json.CleanResult}}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2128,
        576
      ],
      "id": "aa290854-c44f-425b-9de8-6516772dc4f2",
      "name": "IF Clean"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {
          "responseCode": 400,
          "responseKey": "{ \"status\":\"error\", \"message\":\"Uploaded CV failed a safety scan. Please upload a different file.\" }"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        2352,
        576
      ],
      "id": "0bc3ebeb-6153-4c62-8cbc-aa9da550efd2",
      "name": "CV Infected"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "75f0a790-bcd7-456b-be21-0b921ea28fa2",
              "leftValue": "={{$json.jobDescription}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3920,
        528
      ],
      "id": "b6a82cbb-066d-4d10-a2ad-40276132240b",
      "name": "IF JD Provided"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {
          "responseCode": 400,
          "responseKey": "{ \"status\":\"error\", \"message\":\"Job description required. Paste it or upload a file.\" }"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        4144,
        624
      ],
      "id": "6e19bc81-358c-4f1d-a86b-dcad15845e99",
      "name": "JD Required"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "â€œProofread and standardize the updated CV for consistency and clarity. Do not alter facts.â€"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        9904,
        624
      ],
      "id": "ac12ebb2-9da1-4b69-bbf8-83b4f287c444",
      "name": "Starter - Proofread CV",
      "credentials": {
        "openAiApi": {
          "id": "yJxo3UoYqsd6bATu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=STANDARD â€” SYSTEM PROMPT (FULL)\n\nYou are an expert CV writer, resume optimization specialist, recruitment strategist, and ATS consultant. Your task is to rewrite and optimize a candidateâ€™s CV strictly using the information provided, while tailoring it to the target job description.\n\nFollow all Starter-tier rules, with the following Standard-tier enhancements:\n\nðŸ”· ENHANCED WRITING QUALITY\n\nRewrite the CV with clearer phrasing, smoother transitions, and stronger professional tone while maintaining factual accuracy.\n\nImprove:\n\nFlow\n\nReadability\n\nSentence structure\n\nProfessional polish\n\nWITHOUT inventing new skills or achievements.\n\nðŸ”· STRONGER ROLE ALIGNMENT\n\nHighlight the candidateâ€™s relevance more explicitly by:\n\nEmphasizing transferable strengths\n\nMirroring key concepts from the Job Description\n\nReordering bullets for clearer relevance\n\nðŸ”· FORMATTING (same as Starter, but refined)\n\nBold headers\n\nOne blank line between sections\n\nHyphen â€œ-â€ bullet points\n\nNo tables, columns, or emojis\n\nClean ATS-friendly formatting\n\nMaintain consistent spacing, clarity, and layout.\nNEW: COVER LETTER (180â€“250 words)\n\nAfter rewriting the CV, generate a professionally written, tailored, concise cover letter:\n\nClear 4-part structure:\n\nOpening aligned to role\n\nValue proposition\n\nRelevant achievements\n\nConfident close\n\nNo fictional achievements\n\nClean, formal tone\n\nNo placeholders\n\nðŸ”· OUTPUT FORMAT\n\nReturn:\n\nRewritten CV (formatted exactly like Starter)\n\nTailored Cover Letter\n\nNo commentary. No explanations. Only the final outputs.",
              "role": "system"
            },
            {
              "content": "=Rewrite the CV with improved clarity, polish, readability, and alignment to the Job Description.\n\nFollow the System Rules and Starter formatting style.\n\nReturn only:\n\nRewritten CV\n\n--- CV START ---\n{{$json.cvText\n  || $node[\"TXT Field\"].json.cvText\n  || $node[\"PDF - Text\"].json.cvText\n  || $node[\"Upload to PDFco\"].json.cvText\n  || $node[\"DOC - Text\"].json.cvText\n  || ''}}\n--- CV END ---\n\n--- JOB DESCRIPTION START ---\n{{$json.jobDescription\n  || $node[\"Sanitize JD\"].json.jdText\n  || $node[\"Normalise & Validate\"].json.jobDescription\n  || ''}}\n--- JOB DESCRIPTION END ---"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        9552,
        432
      ],
      "id": "a983cdae-0dc6-45c8-8575-6bb88fd0ca4d",
      "name": "Rewrite CV1",
      "credentials": {
        "openAiApi": {
          "id": "yJxo3UoYqsd6bATu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "â€œProofread and standardize the updated CV for consistency and clarity. Do not alter facts.â€"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        9552,
        816
      ],
      "id": "83d172d8-3184-4e7a-b429-b8a1e2e69bca",
      "name": "Standard - Proofread CV",
      "credentials": {
        "openAiApi": {
          "id": "yJxo3UoYqsd6bATu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "messages": {
          "values": [
            {
              "content": "=Candidate name (may be blank): {{ $json.ctx?.candidateName || $json.candidateName || '' }}\n\nCV (source of truth):\n{{ $json.ctx?.rewrittenCVText || $json.cvRewriteText || '' }}\n\nJob Description:\n{{ $json.ctx?.jobDescription || $json.jobDescription || '' }}\n\nWrite the cover letter now, following all rules exactly.\n"
            },
            {
              "content": "=You are a professional career coach and expert cover letter writer.\n\nWrite a tailored, concise, compelling cover letter (180â€“250 words), professional and results-oriented, for a competitive role.\n\nSTRICT RULES (NO EXCEPTIONS)\n1) Do NOT use placeholders of any kind (e.g., [Your Name], [Company Name], [Address], [Date]).\n2) If the company name is not provided, do NOT invent it. Refer to â€œyour teamâ€ or â€œyour organisationâ€.\n3) Use ONLY facts explicitly present in the CV text provided in this chat. Do NOT add new achievements, tools, certifications, employers, titles, or metrics.\n4) Do NOT claim improved conversions, conversion funnel optimisation, revenue growth, pipeline impact, or ROI improvement unless those exact ideas are explicitly stated in the CV text provided.\n5) Do NOT mention email marketing unless it is explicitly stated in the CV text provided.\n6) Do NOT mention product collaboration unless it is explicitly stated in the CV text provided.\n7) Output must be plain text only (no JSON, no markdown, no bullet points).\n\nFORMAT REQUIREMENTS\n- Must begin with: â€œDear Hiring Manager,â€\n- Must have exactly 3 short paragraphs (no more, no less)\n- Must end with:\n  â€œKind regards,â€\n  followed by the candidateâ€™s name if provided; otherwise end with â€œKind regards,â€ only.\n- Do not include a subject line.\n- Do not include addresses, dates, or contact details.\n",
              "role": "system"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        15104,
        80
      ],
      "id": "9de8bd80-09d2-4687-b5a5-57a754efdebe",
      "name": "Cover Letter - Generate",
      "credentials": {
        "openAiApi": {
          "id": "yJxo3UoYqsd6bATu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "c83980a0-8f68-4dba-8b65-224308ee64c0",
              "leftValue": "={{ $json.hasExtraCoverLetter }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        14960,
        416
      ],
      "id": "ee6d2b64-e43e-48ee-928e-3ef637edd637",
      "name": "Extra Cover Letter"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ca547e29-af02-47a5-9dfb-7c448d442bfc",
              "leftValue": "={{ $json.ctx.flags.oneDay }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        20976,
        272
      ],
      "id": "0cf8a956-f9d1-4e6f-8b07-018cd3b037c4",
      "name": "One Day Delivery"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ca547e29-af02-47a5-9dfb-7c448d442bfc",
              "leftValue": "={{ $json.ctx.flags.editableWord }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        19408,
        272
      ],
      "id": "9f750ba2-27f9-458e-bb6e-cbf3eecac01a",
      "name": "Editable Word"
    },
    {
      "parameters": {
        "jsCode": "// Use top-level $json unless body actually has keys\nconst inJsonRaw = $json ?? {};\nconst src = (inJsonRaw.body && Object.keys(inJsonRaw.body).length > 0)\n  ? inJsonRaw.body\n  : inJsonRaw;\n\nconst bin = $binary || {};\n\n// Run Once for All Items\n\n// -- Params you can tune\nconst MAX_CHARS = 10000;   // hard ceiling for JD length\nconst REMOVE_URLS = true;  // set false if you want to keep URLs\n\nconst inJson = $json ?? {};\nconst inBin  = $binary || {};\n\nlet s = String(inJson.jdText || inJson.jobDescription || '').trim();\n\n// 1) quick length guard (truncate rather than reject; flip to reject if you prefer)\nif (s.length > MAX_CHARS) {\n  inJson.jdTooLarge = true;\n  s = s.slice(0, MAX_CHARS);\n}\n\n// 2) normalize newlines + strip zero-width & control chars\ns = s.replace(/\\r\\n?/g, '\\n');\ns = s.replace(/[\\u200B-\\u200D\\uFEFF]/g, '');                  // zero-width\ns = s.replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, '');       // controls\n\n// 3) de-RTF (common when copying from Word)\nif (s.startsWith('{\\\\rtf')) {\n  s = s\n    .replace(/\\\\'[0-9a-fA-F]{2}/g, '')      // hex escapes\n    .replace(/\\\\par[d]?/g, '\\n')            // paragraph marks\n    .replace(/\\\\[a-z]+-?\\d* ?/gi, '')       // RTF control words\n    .replace(/[{}]/g, '');                  // braces\n}\n\n// 4) drop script/style + any remaining HTML tags\nconst hadHtml = /<\\s*\\/?\\s*[a-z][^>]*>/i.test(s);\ns = s.replace(/<\\s*script[^>]*>[\\s\\S]*?<\\s*\\/\\s*script\\s*>/gi, '');\ns = s.replace(/<\\s*style[^>]*>[\\s\\S]*?<\\s*\\/\\s*style\\s*>/gi, '');\ns = s.replace(/<[^>]+>/g, '');\n\n// 5) neutralize URLs (or log them). This avoids accidental clickable links later.\nconst urls = [];\nif (REMOVE_URLS) {\n  s = s.replace(/\\b((https?:\\/\\/|www\\.)[^\\s<>\"]+)/ig, (m) => { urls.push(m); return '[link removed]'; });\n} else {\n  s.replace(/\\b((https?:\\/\\/|www\\.)[^\\s<>\"]+)/ig, (m) => urls.push(m));\n}\n\n// 6) look for obviously dangerous tokens (defense-in-depth)\n// Use case-insensitive substring checks to avoid invalid regex construction.\nconst badTokens = [];\nconst lower = s.toLowerCase();\n['javascript:', 'data:text', 'onerror=', 'onload=', '<iframe', '<img', '<svg', 'eval(']\n  .forEach(tok => { if (lower.includes(tok)) badTokens.push(tok); });\n\n// 7) collapse whitespace\ns = s.replace(/\\s{3,}/g, '  ').trim();\n\n// 8) write sanitized JD + diagnostics\nconst outJson = {\n  ...inJson,\n  jobDescription: s,\n  jdText: s, // keep whatever your AI nodes expect\n  jdSanitized: {\n    hadHtml,\n    urls,\n    badTokens,\n    length: s.length,\n    truncated: Boolean(inJson.jdTooLarge),\n  },\n};\n\n// IMPORTANT: return a proper n8n item and carry the binary along\nreturn [{ json: outJson, binary: inBin }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        784,
        960
      ],
      "id": "b2f226e4-4b1b-4ec8-a467-2e4387627988",
      "name": "Sanitize JD"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "65ac842a-04ee-49d0-a7e4-844cc1b8ea01",
              "name": "=_cfg.bucket",
              "value": "={{ $env.AWS_BUCKET || 'careeredge-orders' }}",
              "type": "string"
            },
            {
              "id": "5bbb37e6-246c-4feb-9036-15c14b431de4",
              "name": "=_cfg.pgSchema",
              "value": "={{ $env.PG_SCHEMA || 'public' }}",
              "type": "string"
            },
            {
              "id": "0c7fa8fa-7074-4f35-8944-96d41983bd9a",
              "name": "=_cfg.region",
              "value": "={{ $env.AWS_REGION || 'eu-west-1' }}",
              "type": "string"
            },
            {
              "id": "dcec6625-7b12-40d5-9b2f-09a73b9e88f5",
              "name": "=_cfg.prices",
              "value": "={{ $env.PACKAGE_PRICES || '{\"starter\":4.99,\"standard\":7.99,\"premium\":14.99,\"executive\":24.99}' }}",
              "type": "object"
            },
            {
              "id": "a2920cc6-85f5-4107-8602-6c7b4666203e",
              "name": "=_ctx.rawAddons",
              "value": "={{ $('Webhook Intake').item.json.body.addons || '' }}",
              "type": "string"
            },
            {
              "id": "e34c2f8d-473b-4158-983c-82f244f21a1b",
              "name": "=addons",
              "value": "={{\n  (() => {\n    const a = $('Webhook Intake').item.json.body.addons;\n    if (Array.isArray(a)) return a.map(s => String(s).trim().toLowerCase()).filter(Boolean);\n    if (typeof a === 'string') {\n      const t = a.trim();\n      try { const j = JSON.parse(t); if (Array.isArray(j)) return j.map(s => String(s).trim().toLowerCase()).filter(Boolean); } catch {}\n      return t ? t.split(',').map(s => s.trim().toLowerCase()).filter(Boolean) : [];\n    }\n    return [];\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "1bdcf510-f4bc-482c-b955-388ef2306912",
              "name": "=hasExtraCoverLetter",
              "value": "={{ Array.isArray($json.addons) && $json.addons.includes('extracoverletter') }}",
              "type": "boolean"
            },
            {
              "id": "9046e736-5115-4bcf-a809-2c686ecbe102",
              "name": "=isOneDayDelivery",
              "value": "={{ Array.isArray($json.addons) && $json.addons.includes('oneday') }}",
              "type": "string"
            },
            {
              "id": "d9561c2c-b236-4e6c-8541-445aa5d02e25",
              "name": "=needsEditableWord",
              "value": "={{ Array.isArray($json.addons) && $json.addons.includes('editableword') }}",
              "type": "string"
            },
            {
              "id": "fd0d908a-7c11-44bf-9c0a-ecb80c9f4fd6",
              "name": "=hasLinkedIn",
              "value": "={{ Array.isArray($json.addons) && ($json.addons.includes('linkedin') || $json.addons.includes('linkedinoptimize')) }}",
              "type": "string"
            },
            {
              "id": "b1c1a8bb-bcf3-4d1a-8035-4711a9683bd5",
              "name": "=hasAnyAddons",
              "value": "={{ Array.isArray($json.addons) && $json.addons.length > 0 }}",
              "type": "string"
            },
            {
              "id": "df81b7ab-fb7b-41fc-8154-bd55e728ab9f",
              "name": "=addonCount",
              "value": "={{ Array.isArray($json.addons) ? $json.addons.length : 0 }}",
              "type": "number"
            },
            {
              "id": "a00ab422-a48f-4c6f-ba88-70656f134e5a",
              "name": "=sessionId",
              "value": "={{ $('Webhook Intake').item.json.body.session_id || '' }}",
              "type": "string"
            },
            {
              "id": "52b6fd19-a4b8-4672-8b5b-c6a5cf614449",
              "name": "=orderId",
              "value": "={{\n  (() => {\n    const v = ( $('Webhook Intake').item.json.body.orderId || '' ).toString().trim();\n    return /^[0-9a-f-]{36}$/i.test(v) ? v : '';\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "1f4187d4-8382-49e3-9e09-821abc5219ab",
              "name": "=candidateName",
              "value": "={{ $('Webhook Intake').item.json.body.candidateName || '' }}",
              "type": "string"
            },
            {
              "id": "fc73cf29-328b-4d79-ad95-84583722345f",
              "name": "=email",
              "value": "={{ $('Webhook Intake').item.json.body.email || '' }}",
              "type": "string"
            },
            {
              "id": "c4fbf491-cc29-435c-9679-3f25ed01bc54",
              "name": "=jobDescription",
              "value": "={{ $('Webhook Intake').item.json.body.jobDescription || '' }}",
              "type": "string"
            },
            {
              "id": "ad29deda-245d-4b48-a863-d12c8da6b374",
              "name": "=package",
              "value": "={{ $('Webhook Intake').item.json.body.package || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -784,
        864
      ],
      "id": "939641a8-6e60-49a4-99f2-c32e70ceb087",
      "name": "Set - Config"
    },
    {
      "parameters": {
        "jsCode": "// n8n runs on Node 18+, so randomUUID exists\nconst id = $json.orderId || (global.crypto?.randomUUID?.() ?? require('crypto').randomUUID());\nreturn [{ json: { ...$json, orderId: id } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4144,
        432
      ],
      "id": "216bbe8b-13fa-47d0-8a7c-a7b7a74a9f8f",
      "name": "Code - Ensure orderID"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "eb01e65c-ed02-4ab1-8522-f6c8e2c7422a",
              "leftValue": "={{ $json.readyForAI }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5040,
        144
      ],
      "id": "4e24894e-7e57-4bdf-8316-bc5c59d3c23b",
      "name": "Have binary CV"
    },
    {
      "parameters": {
        "jsCode": "const out = { json: { ...$json } };\n\nif ($json.cvText) {\n  const data = Buffer.from($json.cvText, 'utf8').toString('base64');\n  out.binary = {\n    cv: {\n      data,\n      fileName: 'cv_original.txt',\n      mimeType: 'text/plain',\n    },\n  };\n}\n\nreturn [out];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5264,
        576
      ],
      "id": "2c26a270-3345-46fa-b13a-243353ac07a8",
      "name": "cvText - Binary"
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "={{$json._cfg.bucket}}",
        "fileName": "={{ 'orders/' + $json.orderId + '/cv_original.' + ($json.cvExt || 'txt') }}",
        "binaryPropertyName": "cv",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.awsS3",
      "typeVersion": 2,
      "position": [
        5488,
        80
      ],
      "id": "1d577414-979e-4c6b-8770-23b2d10349b9",
      "name": "Upload Original CV",
      "retryOnFail": true,
      "maxTries": 4,
      "waitBetweenTries": 2000,
      "credentials": {
        "aws": {
          "id": "n5UgIcWbhOcd3PE6",
          "name": "AWS account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fca0d575-68cf-44a0-b8c9-37e7a711669e",
              "name": "=cv_orig_key",
              "value": "={{ ($json.Key || $node[\"Upload Original CV\"].json.Key || '').trim() }}\n\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5712,
        80
      ],
      "id": "8f47563e-b09f-4985-aecb-bf38c32f0aff",
      "name": "Remember cv_orig_key"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH p AS (\n  SELECT\n    ($1::jsonb->>'order_id')::uuid             AS order_id,\n    NULLIF($1::jsonb->>'storage_key','')::text AS storage_key,\n    /* keep to columns we know exist */\n    COALESCE(NULLIF($1::jsonb->>'package',''),'starter') AS package\n),\nins_order AS (  -- ensure parent exists; only columns we know exist\n  INSERT INTO public.orders (id, status, created_at, package)\n  SELECT p.order_id, 'processing', NOW(), p.package\n  FROM p\n  ON CONFLICT (id) DO UPDATE\n    SET package = COALESCE(public.orders.package, EXCLUDED.package)\n  RETURNING id\n),\nupd AS (  -- try to update existing document row\n  UPDATE public.documents d\n  SET storage_key = p.storage_key\n  FROM p\n  WHERE d.order_id = p.order_id\n    AND d.kind = 'cv_original'\n  RETURNING d.id, d.order_id, d.kind, d.storage_key\n),\nins AS (  -- insert if no existing document row\n  INSERT INTO public.documents (order_id, kind, storage_key)\n  SELECT p.order_id, 'cv_original', p.storage_key\n  FROM p\n  WHERE NOT EXISTS (SELECT 1 FROM upd)\n  RETURNING id, order_id, kind, storage_key\n)\nSELECT id, order_id, kind, storage_key, 'updated'  AS outcome FROM upd\nUNION ALL\nSELECT id, order_id, kind, storage_key, 'inserted' AS outcome FROM ins;",
        "options": {
          "queryReplacement": "=={{ JSON.stringify({\n  order_id:    $node[\"Update Order\"].json.order_id || $json.orderId,\n  storage_key: ($json.cv_orig_key || '').trim(),\n  package:     $json.package || 'starter'\n}) }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        5936,
        80
      ],
      "id": "f20ef3c2-8205-4339-8845-852ff91616e1",
      "name": "Add Doc(cv_original)",
      "credentials": {
        "postgres": {
          "id": "9OVCjeTvYAa1i2Cv",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "={{$json.bucket || $json._cfg.bucket}}",
        "fileName": "={{$json.linkedinKey}}",
        "binaryPropertyName": "linkedin",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.awsS3",
      "typeVersion": 2,
      "position": [
        18720,
        80
      ],
      "id": "96f63ee1-2edd-4943-bca9-34e84f7a5659",
      "name": "Upload LinkedIn",
      "credentials": {
        "aws": {
          "id": "n5UgIcWbhOcd3PE6",
          "name": "AWS account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.documents (order_id, kind, storage_key) VALUES ($1::uuid, 'linkedin_profile', $2) ON CONFLICT (order_id, kind) DO UPDATE SET storage_key = EXCLUDED.storage_key;",
        "options": {
          "queryReplacement": "={{ [ $json.orderId, $json.linkedinKey || ('orders/' + $json.orderId + '/linkedin.txt') ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        18944,
        80
      ],
      "id": "6c54e9e0-2b75-4c19-9d49-bd7c6d713fdf",
      "name": "Postgres - Add Doc(linkedin)",
      "credentials": {
        "postgres": {
          "id": "9OVCjeTvYAa1i2Cv",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1fjUwCV-8sf6tuqr_PHzndsB4phIUM00_AMfGIcd1oF0",
          "mode": "list",
          "cachedResultName": "CareerEdge P&L",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1fjUwCV-8sf6tuqr_PHzndsB4phIUM00_AMfGIcd1oF0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Transactions",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1fjUwCV-8sf6tuqr_PHzndsB4phIUM00_AMfGIcd1oF0/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "={{ $json.sheet.timestamp }}",
            "package": "={{ $json.sheet.package }}",
            "addons": "={{ $json.sheet.addons }}",
            "price_eur": "={{ $json.sheet.price_eur }}",
            "priority": "={{ $json.sheet.priority }}",
            "cv_ext": "={{ $json.sheet.cv_ext }}",
            "source": "={{ $json.sheet.source }}",
            "email": "={{ $json.sheet.email }}",
            "cv_re_key": "={{ $json.sheet.cv_re_key }}",
            "cover_key": "={{ $json.sheet.cover_key }}",
            "li_key": "={{ $json.sheet.li_key }}",
            "status": "={{ $json.sheet.status }}",
            "exec_est": "={{ $json.sheet.exec_est }}",
            "token_cost_eur": "={{ $json.sheet.token_cost_eur }}",
            "notes": "={{ $json.sheet.notes }}",
            "orderId": "={{ $json.sheet.orderId }}",
            "docx_key": "={{ $json.sheet.docx_key }}",
            "rtf_key": "={{ $json.sheet.rtf_key }}",
            "candidateName": "={{ $json.sheet.candidateName }}"
          },
          "matchingColumns": [
            "orderId"
          ],
          "schema": [
            {
              "id": "orderId",
              "displayName": "orderId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "candidateName",
              "displayName": "candidateName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "package",
              "displayName": "package",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "addons",
              "displayName": "addons",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "price_eur",
              "displayName": "price_eur",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "priority",
              "displayName": "priority",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "exec_est",
              "displayName": "exec_est",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "cv_ext",
              "displayName": "cv_ext",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "source",
              "displayName": "source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "cv_re_key",
              "displayName": "cv_re_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "cover_key",
              "displayName": "cover_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "li_key",
              "displayName": "li_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "docx_key",
              "displayName": "docx_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "rtf_key",
              "displayName": "rtf_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "token_cost_eur",
              "displayName": "token_cost_eur",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "notes",
              "displayName": "notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        23888,
        272
      ],
      "id": "68db70e0-f9ec-4aa3-90cd-4d56d0ade7bc",
      "name": "Append or update row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "VA667DdgiyhlhQM5",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "claude-sonnet-4-20250514",
          "mode": "list",
          "cachedResultName": "claude-sonnet-4-20250514"
        },
        "messages": {
          "values": [
            {
              "content": "You are a senior-level CV strategist, professional career brand consultant, and ATS optimization expert. Your task is to rewrite the candidateâ€™s CV and cover letter strictly using the provided information, while presenting the candidate in the strongest possible light for the target role.\n\nFollow all Starter and Standard rules, with the following Premium-level enhancements:\n\nðŸ”® ADVANCED JD ALIGNMENT & VALUE FRAMING\n\nTransform the CV so it demonstrates:\n\nClear alignment to the roleâ€™s strategic priorities\n\nStronger emphasis on impact and value\n\nPrioritization of most impressive and relevant achievements\n\nRewrite bullets using a high-impact structure:\n\nAction + Skill + Business Context + Outcome/Value\n(using outcomes only if present/implied)\n\nðŸ”® PREMIUM TONE & SOPHISTICATION\n\nUse wording that is:\n\nMore authoritative\n\nMore polished\n\nMore executive-sounding\n\nMore persuasive without exaggerating\n\nAvoid exaggeration; elevate what already exists.\n\nðŸ”® PREMIUM FORMATTING CONSISTENCY\n\nThe visual layout stays the same as Starter/Standard, but with stricter quality control:\n\nImpeccable spacing\n\nZero redundancy\n\nClear hierarchy of information\n\nBullet ordering optimized for maximum effect\n\nðŸ”® ATS KEYWORD OPTIMIZATION\n\nIncrease keyword alignment by:\n\nIncorporating critical JD terms where truthful\n\nEmphasizing relevant tools/skills\n\nImproving clarity of domain expertise\n\nNever keyword-stuff.\n\nUSER PROMPT\n\nRewrite the CV and cover letter using a more persuasive, polished, strategically aligned tone.\nElevate clarity, impact, and keyword alignment while remaining fully factual.\n\nReturn only:\n\nPremium CV\n\n\n--- CV START ---\n{{$json.cvText\n  || $node[\"TXT Field\"].json.cvText\n  || $node[\"PDF - Text\"].json.cvText\n  || $node[\"DOCX - Text\"].json.cvText\n  || $node[\"DOC - Text\"].json.cvText\n  || ''}}\n--- CV END ---\n\n--- JOB DESCRIPTION START ---\n{{$json.jobDescription\n  || $node[\"Sanitize JD\"].json.jdText\n  || $node[\"Normalise & Validate\"].json.jobDescription\n  || ''}}\n--- JOB DESCRIPTION END ---"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        9200,
        624
      ],
      "id": "71858747-5c1d-4cdb-a1ec-0e003bf21121",
      "name": "Premium - CV Rewrite (Claude Sonnet)",
      "credentials": {
        "anthropicApi": {
          "id": "QtCeYDpyX4nPfGg5",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "claude-opus-4-1-20250805",
          "mode": "list",
          "cachedResultName": "claude-opus-4-1-20250805"
        },
        "messages": {
          "values": [
            {
              "content": "You are a top-tier executive rÃ©sumÃ© writer, leadership brand strategist, and senior hiring advisor.\nYour task is to rewrite the candidateâ€™s CV and cover letter so they reflect executive presence, strategic leadership, and high-level business impact, strictly within the bounds of factual accuracy.\n\nFollow all Starter, Standard, and Premium rules, PLUS these Executive enhancements:\n\nðŸ‘‘ EXECUTIVE PRESENCE\n\nUse language that reflects:\n\nStrategic thinking\n\nLeadership influence\n\nOwnership of outcomes\n\nHigh-level accountability\n\nCross-functional impact\n\nBusiness decision-making\n\nWithout inventing any untrue achievements.\n\nðŸ‘‘ LEADERSHIP-LEVEL BULLET ARCHITECTURE\n\nRewrite bullets to emphasize:\n\nScope\n\nResponsibility breadth\n\nLong-term impact\n\nStrategic contribution\n\nTeam leadership or stakeholder influence (only if present in CV)\n\nOrder all bullets to highlight the most impressive achievements first.\n\nðŸ‘‘ EXECUTIVE TONE\n\nTone must be:\n\nConfident\n\nSuccinct\n\nLeadership-oriented\n\nImpact-driven\n\nFree of junior-level phrasing\n\nðŸ‘‘ FORMAT (unchanged visually, but refined)\n\nMaintain Starter formatting:\n\nBold headers\n\nHyphen bullets\n\nSection spacing\n\nATS-safe structure\n\nBut enforce:\n\nAbsolute clarity\n\nHighest possible readability\n\nZero fluff\n\nSenior-level cohesion\n\nUSER PROMPT\n\nRewrite the CV and cover letter with an executive-level tone that emphasizes strategic leadership, decision-making, business impact, and senior stakeholder influence.\n\nReturn only:\n\nExecutive CV\n\n--- CV START ---\n{{$json.cvText\n  || $node[\"TXT Field\"].json.cvText\n  || $node[\"PDF - Text\"].json.cvText\n  || $node[\"DOCX - Text\"].json.cvText\n  || $node[\"DOC - Text\"].json.cvText\n  || ''}}\n--- CV END ---\n\n--- JOB DESCRIPTION START ---\n{{$json.jobDescription\n  || $node[\"Sanitize JD\"].json.jdText\n  || $node[\"Normalise & Validate\"].json.jobDescription\n  || ''}}\n--- JOB DESCRIPTION END ---"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        8848,
        816
      ],
      "id": "f2a506d0-39ca-4540-b039-6d9d24c2486c",
      "name": "Executive - CV Rewrite (Claude Opus)",
      "credentials": {
        "anthropicApi": {
          "id": "QtCeYDpyX4nPfGg5",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "claude-opus-4-1-20250805",
          "mode": "list",
          "cachedResultName": "claude-opus-4-1-20250805"
        },
        "messages": {
          "values": [
            {
              "content": "â€œProvide a clean 2-page layout with sections: Header, Summary, Core Skills, Experience (reverse-chron), Education, Certifications. Use consistent spacing and uppercase headings.â€"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        9904,
        816
      ],
      "id": "f229bb21-49f8-45c3-b561-e557cdd4522f",
      "name": "Executive - Format CV Layout",
      "credentials": {
        "anthropicApi": {
          "id": "QtCeYDpyX4nPfGg5",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Mode: Run Once for All Items\nconst bin = $binary || {};\nconst keys = Object.keys(bin);\nconst outBin = { ...bin };\nif (keys.length && !bin.cv) {\n  outBin.cv = bin[keys[0]];   // copy first binary to 'cv'\n}\nreturn [{ json: $json, binary: outBin }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1456,
        576
      ],
      "id": "aa246ffa-405a-49a8-ba7a-124be30516af",
      "name": "Code"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferInput1"
            }
          },
          "includeUnpaired": false
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2352,
        384
      ],
      "id": "3a2f35ed-487e-4e75-9f08-3c17ab6a0f64",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "// Run Once for All Items\nconst b = $binary?.cv;\nlet ext = ($json.cvExt ?? '').toString().trim().toLowerCase();\n\nif (!ext && b?.fileName) {\n  const i = b.fileName.lastIndexOf('.');\n  if (i >= 0) ext = b.fileName.slice(i + 1).toLowerCase();\n}\nif (!ext && b?.mimeType) {\n  const map = {\n    'text/plain': 'txt',\n    'application/pdf': 'pdf',\n    'application/msword': 'doc',\n    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',\n  };\n  ext = map[(b.mimeType || '').toLowerCase()] || '';\n}\n\nreturn [{ json: { ...$json, cvExt: ext }, binary: $binary }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2576,
        384
      ],
      "id": "0e01f170-8316-4725-887d-a1f941376c2c",
      "name": "cvExt"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "28624ae2-9b34-4aaa-8c63-a7a7560f77ab",
              "name": "=fileType",
              "value": "={{\n  String(\n    $json.fileType         // if you already set it\n    || $json.cvExt\n    || $json.extResolved\n    || $json.fileExtension\n    || ($binary.cv  && $binary.cv.fileName  ? $binary.cv.fileName.split('.').pop()  : '')\n    || ($binary.cv0 && $binary.cv0.fileName ? $binary.cv0.fileName.split('.').pop() : '')\n    || ''\n  ).trim().toLowerCase()\n}}\n",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2800,
        384
      ],
      "id": "3eca26ab-6713-4839-b8c3-2dc8ac94bae1",
      "name": "fileType"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferInput1"
            }
          }
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3696,
        528
      ],
      "id": "50ed67ff-e17b-4bc5-b1c4-708d7577b804",
      "name": "Merge10"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferLast"
            }
          }
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        4816,
        144
      ],
      "id": "615aa1c5-e04c-4812-a464-5af53b8ab470",
      "name": "Merge11"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "includeUnpaired": false
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        6384,
        432
      ],
      "id": "3b5f5ee5-c14a-49c7-ac19-283e35d45942",
      "name": "Merge: Ready to Upload"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "06986433-eb0c-4d1d-a79c-4915fd219db7",
              "name": "=orderId",
              "value": "={{$node[\"Update Order\"].json.orderId}}",
              "type": "string"
            },
            {
              "id": "8fa49e82-fe5d-4ffd-b6ab-f30fc0a3d9af",
              "name": "=cv_orig_key",
              "value": "={{$node[\"Remember cv_orig_key\"].json.cv_orig_key}}",
              "type": "string"
            },
            {
              "id": "97cd22bd-3376-49ed-875a-e58734e52d02",
              "name": "=ok",
              "value": "true",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6160,
        80
      ],
      "id": "014b6c3a-9926-46e1-a446-3cf82bd5a1e4",
      "name": "Ack AddDoc"
    },
    {
      "parameters": {
        "jsCode": "// Build Addon Rows (preserve binary)\n// Mode: Run Once for All Items â€¢ Language: JavaScript\nconst itemsIn = $input.all();\n\nreturn itemsIn.map(item => {\n  const prices =\n    (item.json._cfg && item.json._cfg.addonPrices) || {\n      extracoverletter: 299,\n      oneday: 399,\n      editableword: 499,\n      linkedin: 1000,\n      linkedinoptimize: 1000,\n    };\n\n  const addons = Array.isArray(item.json.addons) ? item.json.addons : [];\n  const addonRows = addons.map(code => ({\n    code,\n    price_cents: prices[code] ?? null,\n  }));\n\n  return {\n    json: { ...item.json, addonRows },\n    binary: item.binary,          // ðŸ‘ˆ keep existing binary (includes cv)\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        560,
        864
      ],
      "id": "9e13c794-07f4-4da9-bc13-9ff425190dac",
      "name": "Add Ons"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH params AS (\n  SELECT\n    ($1::jsonb->>'order_id')::uuid           AS order_id,\n    COALESCE(($1::jsonb->>'has_linkedin')::boolean, false)            AS has_linkedin,\n    COALESCE(($1::jsonb->>'has_extra_cover_letter')::boolean, false)  AS has_extra_cover_letter,\n    COALESCE(($1::jsonb->>'needs_editable_word')::boolean, false)      AS needs_editable_word,\n    COALESCE(($1::jsonb->>'is_one_day_delivery')::boolean, false)      AS is_one_day_delivery\n),\nupd AS (\n  UPDATE public.orders o\n  SET\n    has_linkedin           = p.has_linkedin,\n    has_extra_cover_letter = p.has_extra_cover_letter,\n    needs_editable_word    = p.needs_editable_word,\n    is_one_day_delivery    = p.is_one_day_delivery,\n    sla_due_at             = CASE WHEN p.is_one_day_delivery\n                                  THEN NOW() + interval '24 hours'\n                                  ELSE o.sla_due_at END\n  FROM params p\n  WHERE o.id = p.order_id\n  RETURNING o.id AS order_id, o.status, o.has_linkedin,\n            o.has_extra_cover_letter, o.needs_editable_word,\n            o.is_one_day_delivery, o.sla_due_at\n)\nSELECT *, 'updated' AS outcome FROM upd\nUNION ALL\nSELECT p.order_id, NULL AS status, p.has_linkedin, p.has_extra_cover_letter,\n       p.needs_editable_word, p.is_one_day_delivery, NULL::timestamptz AS sla_due_at,\n       'not_found' AS outcome\nFROM params p\nWHERE NOT EXISTS (SELECT 1 FROM upd);",
        "options": {
          "queryReplacement": "=={{ JSON.stringify({\n  order_id: $node[\"Update Order\"].json.order_id || $json.orderId,\n  has_linkedin: $json.hasLinkedIn ?? false,\n  has_extra_cover_letter: $json.hasExtraCoverLetter ?? false,\n  needs_editable_word: $json.needsEditableWord ?? false,\n  is_one_day_delivery: $json.isOneDayDelivery ?? false\n}) }}\n\n\n\n"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4592,
        432
      ],
      "id": "870de239-4554-4b4a-8643-26ba5206ead3",
      "name": "Upsert Order Flags",
      "credentials": {
        "postgres": {
          "id": "9OVCjeTvYAa1i2Cv",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return $input.all().map(item => {\n  return {\n    json: item.json,       // keep the scan result\n    binary: item.binary    // carry forward the CV\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1904,
        576
      ],
      "id": "b31bd10f-fa08-4c72-9b04-8c255c45876f",
      "name": "Restore Binary"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "0b779fb2-ee9d-41a7-afca-f3c7cecc30ed",
              "leftValue": "={{ $json.ctx.flags.linkedIn }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        17712,
        272
      ],
      "id": "69708d71-3392-4b73-bb48-c091cbcb98f9",
      "name": "LinkedIn Optimization1"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "messages": {
          "values": [
            {
              "content": "You are a professional LinkedIn profile strategist.\n\nHARD RULES:\n- Output VALID JSON ONLY (no markdown fences).\n- No placeholders like [Name], <Company>, {TBD}. Use the provided candidateName; if missing, omit.\n- Respect LinkedIn limits (Headline â‰¤ 220 chars, About â‰¤ 2000 chars, Experience entries â‰¤ 2000 chars each).\n- ATS/SEO friendly: include keywords from the job description naturally.\n- Confident, human voice. No â€œAs an AIâ€¦â€.\n",
              "role": "system"
            },
            {
              "content": "=Create a complete LinkedIn optimization based on the candidate's updated CV and the target job.\n\nInputs:\n- candidateName: \"{{$json.candidateName}}\"\n- Updated CV (final used for resume): \"{{ $json.ctx.rewrittenCVText || $json.ctx.cvText }}\"\n- Job Description: \"{{ $json.ctx.jobDescription }}\"\n\nReturn JSON exactly with this schema:\n{\n  \"headline\": \"string (<=220)\",\n  \"about\": \"string (<=2000)\",\n  \"experience\": [\n    {\n      \"title\": \"string\",\n      \"company\": \"string\",\n      \"location\": \"string (optional)\",\n      \"dateRange\": \"string (optional)\",\n      \"description\": \"string (<=2000, bullet-like lines)\"\n    }\n  ],\n  \"skills\": [\"string\", \"... up to 50\"],\n  \"keywords\": [\"string\", \"... prioritized\"],\n  \"featuredSuggestions\": [\n    {\"label\":\"string\",\"url\":\"string or empty\",\"note\":\"string optional\"}\n  ],\n  \"settingsChecklist\": [\n    \"Customize URL suggestion\",\n    \"Banner idea (visual theme + copy)\",\n    \"Profile photo notes\",\n    \"Open to Work toggles\",\n    \"Creator Mode (if relevant)\"\n  ]\n}\n"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        17936,
        80
      ],
      "id": "bfc54484-e19c-4b8e-91af-66ca5a58b575",
      "name": "LI Build Sections1",
      "credentials": {
        "openAiApi": {
          "id": "yJxo3UoYqsd6bATu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Get the JSON object produced by the OpenAI node\nconst raw = $json.linkedin_profile;\nif (!raw) return { json: $json, binary: $binary };\nconst text = typeof raw === 'string' ? raw : JSON.stringify(raw, null, 2);\nconst data = Buffer.from(text, 'utf8').toString('base64');\nreturn {\n  json: $json,\n  binary: {\n    ...($binary || {}),\n    linkedin: { data, fileName: 'linkedin.json', mimeType: 'application/json' }\n  },\n};\n\nconst out = $json;\n\n// Regex to catch placeholders or AI disclaimers\nconst bad = /\\[.*?\\]|<.*?>|\\{.*?\\}|as an ai/i;\n\nfunction scrub(s) {\n  if (!s) return s;\n  return String(s).replace(/\\u200B/g, '').trim();\n}\n\n// If headline/about contains placeholder text, flag it\nif (bad.test(out.headline || '') || bad.test(out.about || '')) {\n  return [{\n    ...out,\n    liNeedsRepair: true\n  }];\n}\n\n// Enforce LinkedIn limits\nout.headline = scrub(out.headline).slice(0, 220);\nout.about = scrub(out.about).slice(0, 2000);\n\nif (Array.isArray(out.experience)) {\n  out.experience = out.experience.map(e => ({\n    ...e,\n    description: scrub(e.description || '').slice(0, 2000)\n  }));\n}\n\nif (Array.isArray(out.skills)) {\n  out.skills = out.skills.slice(0, 50);\n}\n\nreturn [{\n  ...out,\n  liNeedsRepair: false\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        18480,
        80
      ],
      "id": "9ae7eb3c-a2b8-41d2-96ec-3b2fb67a8764",
      "name": "Validate & Clean2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c013366d-a353-4530-8f5f-f3da86fa616a",
              "name": "=cvRewriteKey",
              "value": "={{ 'orders/' + $json.orderId + '/cv_rewritten.txt' }}",
              "type": "string"
            },
            {
              "id": "425fe294-ca91-4e66-9688-3ca6571a2940",
              "name": "=coverLetterKey",
              "value": "={{ 'orders/' + $json.orderId + '/cover_letter.txt' }}",
              "type": "string"
            },
            {
              "id": "8bb38c2f-ee4d-48a6-873d-34bea5b63880",
              "name": "=linkedinKey",
              "value": "={{ 'orders/' + $json.orderId + '/linkedin.json' }}",
              "type": "string"
            },
            {
              "id": "22c2be45-3e48-463e-bb0b-85caf5717639",
              "name": "=bucket",
              "value": "={{$json._cfg.bucket}}",
              "type": "string"
            },
            {
              "id": "67b8da41-c087-40a3-ab01-6122edbcfe1c",
              "name": "=schema",
              "value": "={{$json._cfg.pgSchema || 'public'}}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6608,
        432
      ],
      "id": "6f95dea9-4f69-4975-b99e-2d53eb38c1f4",
      "name": "Build Keys"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a231b1eb-a02b-486e-ab77-03efdf9b53b6",
              "name": "=joinKey",
              "value": "={{\n(\n  $items(\"Switch\", 0)[0]?.json?.ctx?.orderId\n  || $items(\"Switch\", 0)[0]?.json?.orderId\n  || $json.joinKey\n  || $json.ctx?.orderId\n  || $json.orderId\n  || $json.order_id\n  || ''\n).toString().trim().replace(/^=/,'')\n}}",
              "type": "string"
            },
            {
              "id": "2d2982d6-5868-4193-bbc5-48f8cec183b1",
              "name": "=cvRewriteText",
              "value": "={{\n(() => {\n  const c = $json.choices?.[0]?.message?.content;\n\n  if (typeof c === 'string') return c.trim();\n  if (!c || typeof c !== 'object') return '';\n\n  const out = [];\n  const push = (title, body) => {\n    const t = String(title || '').trim();\n    const b = String(body || '').trim();\n    if (t && b) out.push(`**${t}**\\n${b}`);\n  };\n\n  push('Professional Summary', c['Professional Summary']);\n  push('Core Skills', c['Core Skills']);\n  push('Professional Experience', c['Professional Experience']);\n  push('Education', c['Education']);\n  push('Certifications', c['Certifications']);\n  push('Tools & Platforms', c['Tools & Platforms']);\n  push('Projects', c['Projects']);\n  push('Awards', c['Awards']);\n\n  return out.join('\\n\\n').trim();\n})()\n}}",
              "type": "string"
            },
            {
              "id": "0cc4e300-ae4e-45d4-b405-fd2bdf9d9f14",
              "name": "=ctx",
              "value": "={{\n(() => {\n  // Always use the pre-AI payload as the source of truth\n  const src =\n    $items(\"Switch\", 0)[0]?.json\n    || $items(\"Context (carry)\", 0)[0]?.json\n    || $json\n    || {};\n\n  const ctx0 =\n    (src.ctx && typeof src.ctx === 'object') ? src.ctx : {};\n\n  // --- Build the rewritten text (string) from the AI output ---\n  const c = $json.choices?.[0]?.message?.content;\n\n  const buildText = () => {\n    // If model returned plain text, use it\n    if (typeof c === 'string') return c.trim();\n    // If model returned an object, build a single ATS-friendly string\n    if (!c || typeof c !== 'object') return '';\n\n    const out = [];\n    const push = (title, body) => {\n      const t = String(title || '').trim();\n      const b = String(body || '').trim();\n      if (t && b) out.push(`**${t}**\\n${b}`);\n    };\n\n    push('Professional Summary', c['Professional Summary']);\n    push('Core Skills', c['Core Skills']);\n    push('Professional Experience', c['Professional Experience']);\n    push('Education', c['Education']);\n    push('Certifications', c['Certifications']);\n    push('Tools & Platforms', c['Tools & Platforms']);\n    push('Projects', c['Projects']);\n    push('Awards', c['Awards']);\n\n    return out.join('\\n\\n').trim();\n  };\n\n  const rewritten = buildText();\n\n  // Ensure addons are always an array\n  const addons =\n    Array.isArray(ctx0.addons) ? ctx0.addons\n    : Array.isArray(src.addons) ? src.addons\n    : (typeof src.addons === 'string' && src.addons.trim())\n      ? src.addons.split(',').map(x => x.trim().toLowerCase()).filter(Boolean)\n      : [];\n\n  return {\n    // Preserve everything previously captured\n    ...ctx0,\n\n    // Fill any missing ctx fields from src\n    orderId: ctx0.orderId || src.orderId || src.order_id || src.joinKey || '',\n    email: ctx0.email || src.email || '',\n    candidateName: ctx0.candidateName || src.candidateName || '',\n    package: ctx0.package || src.package || src.packageTier || '',\n    jobDescription: ctx0.jobDescription || src.jobDescription || src.jdText || '',\n\n    addons,\n    flags: (ctx0.flags && typeof ctx0.flags === 'object') ? ctx0.flags : (src.flags || {}),\n\n    // Always set rewritten output\n    rewrittenCVText: rewritten,\n  };\n})()\n}}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "ignoreConversionErrors": false
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        10256,
        240
      ],
      "id": "c5486f8d-bef6-4121-a187-33e8cd98e78a",
      "name": "Capture Rewrite"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "19907287-39ae-4ad5-8381-17fd42b8716a",
              "name": "=hasExtraCoverLetter",
              "value": "={{ $json.hasExtraCoverLetterBool }}",
              "type": "boolean"
            },
            {
              "id": "4fa9445d-b39e-4b42-aba6-8b2e82950ceb",
              "name": "=hasLinkedIn",
              "value": "={{ $json.hasLinkedInBool }}",
              "type": "boolean"
            },
            {
              "id": "9d84fe68-1205-4f85-a059-fa34801a7408",
              "name": "=needsEditableWord",
              "value": "={{ $json.needsEditableWordBool }}",
              "type": "boolean"
            },
            {
              "id": "55a75451-05b2-44ac-8c61-840340c6cb47",
              "name": "=pkgStarter",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'starter' }}",
              "type": "boolean"
            },
            {
              "id": "39f3d2cf-18c3-41e8-a926-3a9f17b1ef63",
              "name": "=pkgStandard",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'standard' }}",
              "type": "boolean"
            },
            {
              "id": "c65399f1-dd0a-413a-a177-e4401a1dfe85",
              "name": "=pkgPremium",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'premium' }}",
              "type": "boolean"
            },
            {
              "id": "e275f793-2850-4364-ab3a-6a3839732a3c",
              "name": "=pkgExecutive",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'executive' }}",
              "type": "boolean"
            },
            {
              "id": "b4f74133-439c-4d68-8716-e904ce013686",
              "name": "=isOneDayDelivery",
              "value": "={{ $json.isOneDayDeliveryBool }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7504,
        432
      ],
      "id": "af2d3e8e-3003-4781-acc4-1e18ed7264bc",
      "name": "Flags"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "19907287-39ae-4ad5-8381-17fd42b8716a",
              "name": "=pkgStarter",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'starter' }}",
              "type": "boolean"
            },
            {
              "id": "4fa9445d-b39e-4b42-aba6-8b2e82950ceb",
              "name": "=pkgStandard",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'standard' }}",
              "type": "boolean"
            },
            {
              "id": "9d84fe68-1205-4f85-a059-fa34801a7408",
              "name": "=pkgPremium",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'premium' }}",
              "type": "boolean"
            },
            {
              "id": "c80b1412-ceed-48e4-8bf8-2501ab7fad6d",
              "name": "=pkgExecutive",
              "value": "={{ ($json.packageTier || '').toLowerCase() === 'executive' }}",
              "type": "boolean"
            },
            {
              "id": "19de60f6-7ae6-43a0-9b23-be98654e1d7c",
              "name": "=entCoverLetter",
              "value": "={{ ($json.pkgStandard || $json.pkgPremium || $json.pkgExecutive) || ($json.hasExtraCoverLetter ?? false) }}",
              "type": "boolean"
            },
            {
              "id": "833e2332-ee4a-4869-8a21-942f3dc9a23e",
              "name": "=entDocxLayout",
              "value": "={{ $json.pkgExecutive || ($json.needsEditableWord ?? false) }}",
              "type": "boolean"
            },
            {
              "id": "3db18bf2-adc9-462e-a0ed-6292e948ff88",
              "name": "=entLinkedIn",
              "value": "={{ $json.hasLinkedIn ?? false }}",
              "type": "boolean"
            },
            {
              "id": "2cf79c32-8f72-4cb5-9714-94acbc67d24b",
              "name": "=entRewrite",
              "value": "={{ true }}",
              "type": "boolean"
            },
            {
              "id": "4f9619a0-127a-47fb-b156-11bed4aa9630",
              "name": "=entPriority",
              "value": "={{ $json.pkgExecutive || ($json.isOneDayDelivery ?? false) }}",
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7728,
        432
      ],
      "id": "384f4df9-57c7-44c9-b102-3c044f369b66",
      "name": "Entitlements"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "21de95fc-558b-4b4e-9270-a20e3f9805c8",
              "name": "=rewriteModel",
              "value": "={{ $json.pkgPremium || $json.pkgExecutive ? 'gpt-4o' : 'gpt-4o-mini' }}",
              "type": "string"
            },
            {
              "id": "5399bb9a-d8a8-4b71-9af5-4409fcc1c688",
              "name": "=rewriteTemp",
              "value": "={{ $json.pkgExecutive ? 0.6 : ($json.pkgPremium ? 0.5 : 0.4) }}",
              "type": "string"
            },
            {
              "id": "0d2e11d0-b450-4255-aa8c-ec31ad9af1d5",
              "name": "=maxTokens",
              "value": "={{ $json.pkgExecutive ? 4000 : 2500 }}",
              "type": "string"
            },
            {
              "id": "2dbc9126-4e63-41de-a2d4-81e176f21386",
              "name": "=packageTier",
              "value": "={{ $json.packageTier || $json.package || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7952,
        432
      ],
      "id": "d9a44833-faa0-4ee7-ae4d-4dd866a13351",
      "name": "Model & Prompt Params (Package - Model)"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ ($json.packageTier || $json.package || '') .toString().trim().toLowerCase() }}",
                    "rightValue": "starter",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "12afe657-01b2-4538-a382-d471d3b8a93c"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8ed0472a-4349-4d0c-b716-81b67fe29aa5",
                    "leftValue": "={{ ($json.packageTier || $json.package || '') .toString().trim().toLowerCase() }}",
                    "rightValue": "standard",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e54d25dd-c349-4650-b620-620f50ea229b",
                    "leftValue": "={{ ($json.packageTier || $json.package || '') .toString().trim().toLowerCase() }}",
                    "rightValue": "premium",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "07f6ef09-b47d-447c-8109-2c60f20e080a",
                    "leftValue": "={{ ($json.packageTier || $json.package || '') .toString().trim().toLowerCase() }}",
                    "rightValue": "executive",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9cfe8e1a-112f-4a38-bcbe-b93c899291cc",
                    "leftValue": "={{ true }}",
                    "rightValue": "true",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        8624,
        384
      ],
      "id": "71b646d4-1e19-420d-88b2-ac58e2a82e12",
      "name": "Switch"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9c4c618c-3224-484c-8f7c-707f7f547db8",
              "name": "=coverLetterText",
              "value": "={{\n  (\n    $json.coverLetterText\n    || $json.choices?.[0]?.message?.content\n    || $json.message?.content\n    || ''\n  ).toString().trim()\n}}",
              "type": "string"
            },
            {
              "id": "0684932c-68cf-463f-a62b-dde2359f93c3",
              "name": "=ctx",
              "value": "={{ (() => {   const src =     $json.ctx     || $items(\"Extra Cover Letter\", 0)[0]?.json?.ctx     || $items(\"Switch\", 0)[0]?.json?.ctx     || {};    const base = (src && typeof src === 'object') ? src : {};    return {     ...base,     coverLetterText:       (typeof $json.choices?.[0]?.message?.content === 'string'         ? $json.choices?.[0]?.message?.content.trim()         : (typeof $json.message?.content === 'string'             ? $json.message.content.trim()             : base.coverLetterText || ''           )       )   }; })() }}",
              "type": "object"
            },
            {
              "id": "1c168e61-4e0e-45af-8bbc-f6b295e27065",
              "name": "=joinKey",
              "value": "={{ (   $json.joinKey   || $json.ctx?.orderId   || $items(\"Extra Cover Letter\", 0)[0]?.json?.joinKey   || $items(\"Extra Cover Letter\", 0)[0]?.json?.ctx?.orderId   || $items(\"Switch\", 0)[0]?.json?.ctx?.orderId   || '' ).toString().trim().replace(/^=/,'') }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        15456,
        80
      ],
      "id": "2ff1eb1a-473f-4909-8253-d9531df147e0",
      "name": "Capture Cover Letter"
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "={{ $json._cfg?.bucket || $json.ctx?._cfg?.bucket || 'careeredge-orders' }}",
        "fileName": "={{\n  `orders/${($json.orderId || $json.joinKey || $json.ctx?.orderId || '').toString().trim().replace(/^=/,'')}/cover_letter.pdf`\n}}",
        "binaryPropertyName": "coverLetter",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.awsS3",
      "typeVersion": 2,
      "position": [
        16768,
        80
      ],
      "id": "715b1526-5257-4494-b501-3fe1decb1513",
      "name": "Upload CoverLetter1",
      "credentials": {
        "aws": {
          "id": "n5UgIcWbhOcd3PE6",
          "name": "AWS account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.documents (order_id, kind, storage_key)\nVALUES ($1::uuid, 'cover_letter', $2)\nON CONFLICT (order_id, kind) DO UPDATE\nSET storage_key = EXCLUDED.storage_key;",
        "options": {
          "queryReplacement": "={{ [\n  ($json.ctx?.orderId || $json.orderId || $json.joinKey),\n  ($json.coverLetterKey || $json.Key || `orders/${$json.ctx?.orderId || $json.orderId || $json.joinKey}/cover_letter.pdf`)\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        17472,
        208
      ],
      "id": "c80327a7-e713-4f87-b41d-3483ac5e198e",
      "name": "Postgres - Add Doc(cover)1",
      "credentials": {
        "postgres": {
          "id": "9OVCjeTvYAa1i2Cv",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "11d9d90d-863b-487b-a601-233e2c84d8c3",
              "name": "hasLinkedIn",
              "value": "={{   (() => {     if (typeof $json.hasLinkedIn === 'boolean') return $json.hasLinkedIn;     const a = $json.addons;     const arr = Array.isArray(a)       ? a       : (typeof a === 'string' && a.trim())         ? (a.trim().startsWith('[')             ? JSON.parse(a)             : a.split(',').map(s => s.trim()))         : [];     return arr.includes('linkedinoptimize');   })() }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        18256,
        80
      ],
      "id": "068452b7-9bc1-4e81-9fe1-b286bb90f447",
      "name": "Capture LinkedIn"
    },
    {
      "parameters": {
        "jsCode": "const text = String($json.cvRewriteText || $json.cvText || '');\nconst esc = (s) => s\n  .replace(/&/g, '&amp;')\n  .replace(/</g, '&lt;')\n  .replace(/>/g, '&gt;');\nconst html =\n  `<html><meta charset=\"utf-8\"><body style=\"font-family:Calibri,Arial; white-space:pre-wrap;\">${esc(text)}</body></html>`;\nreturn {\n  json: {\n    ...$json,\n    cvDocHtmlBase64: Buffer.from(html, 'utf8').toString('base64'),\n  },\n  binary: $binary\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        19616,
        112
      ],
      "id": "36976de3-aeaf-4956-be4d-478c5f0e312f",
      "name": "Build HTML"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.cloudconvert.com/v2/jobs",
        "authentication": "genericCredentialType",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type:",
              "value": "application/jso"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "value": "={   \"tasks\": {     \"import\": {       \"operation\": \"import/base64\",       \"file\": \"{{$json.cvDocHtmlBase64}}\",       \"filename\": \"cv.html\"     },     \"convert\": {       \"operation\": \"convert\",       \"input\": \"import\",       \"input_format\": \"html\",       \"output_format\": \"docx\"     },     \"export\": {       \"operation\": \"export/url\",       \"input\": \"convert\"     }   } }"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        19856,
        112
      ],
      "id": "9c578fd2-d888-4370-a9a3-49db2ade34d0",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "url": "={{    JSON.parse($json.body || $json.response || '{}')     .data?.tasks?.find(t => t.name === 'export')?.result?.files?.[0]?.url      || $json.data?.tasks?.find(t => t.name === 'export')?.result?.files?.[0]?.url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        20064,
        112
      ],
      "id": "62d0b3c9-559c-42ea-aa28-ce023cd39395",
      "name": "HTTP Request2"
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "={{$json.bucket || $json._cfg.bucket}}",
        "fileName": "={{ 'orders/' + $json.orderId + '/cv_rewritten.docx' }}",
        "binaryPropertyName": "cvDocx",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.awsS3",
      "typeVersion": 2,
      "position": [
        20288,
        112
      ],
      "id": "7b054352-6b19-4dd7-afa6-1ea54785078b",
      "name": "Upload DOCX",
      "credentials": {
        "aws": {
          "id": "n5UgIcWbhOcd3PE6",
          "name": "AWS account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.documents (order_id, kind, storage_key) VALUES ($1::uuid, 'cv_rewrite_docx', $2) ON CONFLICT (order_id, kind) DO UPDATE SET storage_key = EXCLUDED.storage_key;",
        "options": {
          "queryReplacement": "={{ [ $json.orderId, 'orders/' + $json.orderId + '/cv_rewritten.docx' ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        20512,
        112
      ],
      "id": "58a7abf6-b3b2-4c18-96b4-3b44198510be",
      "name": "Postgres - Add Doc1",
      "credentials": {
        "postgres": {
          "id": "9OVCjeTvYAa1i2Cv",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1c37f72a-a0cc-49a4-8f9c-fa849b64c4c1",
              "name": "sla",
              "value": "'1-day'",
              "type": "string"
            },
            {
              "id": "d1305341-7d12-4c11-9a2f-4b7cb4f69843",
              "name": "priorityFlag",
              "value": "true",
              "type": "string"
            },
            {
              "id": "bf2fc9f5-30a3-46d8-a2be-34fc17de6da5",
              "name": "dueDate",
              "value": "={{ new Date(Date.now() + 24*60*60*1000).toISOString() }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        21200,
        128
      ],
      "id": "948fc707-6de8-4814-a90c-691f2b6b780f",
      "name": "SLA MetaData"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE public.orders SET priority = true, sla = '1-day', due_date = $1::timestamptz WHERE id = $2::uuid;",
        "options": {
          "queryReplacement": "={{ [ $json.dueDate, $json.orderId ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        21408,
        128
      ],
      "id": "f06f5a0f-da71-47c5-b0aa-9906fb687270",
      "name": "Postgres - Update Order Priority",
      "credentials": {
        "postgres": {
          "id": "9OVCjeTvYAa1i2Cv",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Expected upstream: either an array on $json.docs or individual fields.\n// We normalise into: json.documents, json.keys, json.urls\n\nconst j = { ...$json };\n\n// Collect keys from various places\nconst docMap = {};  // kind -> storage_key\n\n// 1) from docs[]\nif (Array.isArray(j.docs)) {\n  for (const d of j.docs) {\n    if (d && d.kind && d.storage_key) docMap[d.kind] = d.storage_key;\n  }\n}\n\n// 2) from flat fields (fallbacks)\nif (j.cvRewriteKey)   docMap.cv_rewritten      = String(j.cvRewriteKey).replace(/^`+|`+$/g,'');\nif (j.coverLetterKey) docMap.cover_letter      = String(j.coverLetterKey).replace(/^`+|`+$/g,'');\nif (j.linkedinKey)    docMap.linkedin_profile  = String(j.linkedinKey).replace(/^`+|`+$/g,'');\n\n// Fix any \"orders/null/...\" mistakes\nObject.keys(docMap).forEach(k => {\n  if (/\\/null\\//.test(docMap[k])) {\n    const oid = j.orderId || j.order_id || '';\n    if (oid) docMap[k] = docMap[k].replace('/null/', `/${oid}/`);\n  }\n});\n\n// Build public URLs (public bucket)\nconst BUCKET = j._cfg?.bucket || 'careeredge-orders';\nconst projectRef = '<YOUR-PROJECT-REF>'; // OPTIONAL: you can hard-code your Supabase ref here.\nconst PUBLIC_BASE = `https://${projectRef}.supabase.co/storage/v1/object/public/${BUCKET}/`;\n\nconst urlFromKey = (key) =>\n  key ? (key.startsWith('http') ? key : (PUBLIC_BASE + key.replace(/^\\/+/, ''))) : '';\n\n// Urls with sensible fallbacks\nconst urls = {\n  cv:          urlFromKey(docMap.cv_rewritten)      || j.cvUrl          || j.cv_rewrite_url   || '',\n  coverLetter: urlFromKey(docMap.cover_letter)      || j.coverLetterUrl || j.cover_letter_url || '',\n  linkedin:    urlFromKey(docMap.linkedin_profile)  || j.linkedinUrl    || j.linkedin_url     || '',\n  docx:        urlFromKey(docMap.cv_rewrite_docx)   || j.docxUrl        || j.docx_url         || '',\n  rtf:         urlFromKey(docMap.cv_rewrite_rtf)    || j.rtfUrl         || j.rtf_url          || '',\n};\n\n// Keys object for Sheets/DB\nconst keys = {\n  cv:          docMap.cv_rewritten      || '',\n  coverLetter: docMap.cover_letter      || '',\n  linkedin:    docMap.linkedin_profile  || '',\n  docx:        docMap.cv_rewrite_docx   || '',\n  rtf:         docMap.cv_rewrite_rtf    || '',\n};\n\nreturn {\n  json: {\n    ...j,\n    documents: docMap,\n    urls,\n    keys,\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        22320,
        288
      ],
      "id": "22e92d3c-90f1-489d-85a3-1ebbcf8873c9",
      "name": "Shape Documents Map"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT kind, storage_key FROM public.documents WHERE order_id = $1::uuid ORDER BY kind;",
        "options": {
          "queryReplacement": "={{ [ $json.orderId ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        22096,
        144
      ],
      "id": "f0fa33c2-e815-427b-9849-101e21050b39",
      "name": "List Documents for Order",
      "credentials": {
        "postgres": {
          "id": "9OVCjeTvYAa1i2Cv",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH p AS (\n  SELECT\n    ($1::jsonb->>'order_id')::uuid         AS order_id,\n    COALESCE(($1::jsonb->>'priority')::boolean, false) AS new_priority\n),\nupd AS (\n  UPDATE public.orders o\n  SET\n    status       = 'done',\n    completed_at = now(),\n    priority     = COALESCE(o.priority, p.new_priority)\n  FROM p\n  WHERE o.id = p.order_id\n  RETURNING o.id AS order_id, o.status, o.priority, o.completed_at\n)\nSELECT * FROM upd;",
        "options": {
          "queryReplacement": "=={{ JSON.stringify({\n  order_id:    ($json.orderId || '').trim(),\n  priority:    ($json.entPriorityBool ?? false)\n}) }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        22992,
        272
      ],
      "id": "9e1a6cb8-c583-41bc-8a0e-dfe0240c2a6b",
      "name": "Mark Order Done",
      "credentials": {
        "postgres": {
          "id": "9OVCjeTvYAa1i2Cv",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4fa9445d-b39e-4b42-aba6-8b2e82950ceb",
              "name": "=jobDescription",
              "value": "={{$json.jobDescription   || $node[\"Sanitize JD\"]?.json.jdText   || $node[\"Normalise & Validate\"]?.json.jobDescription   || ''}}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7056,
        432
      ],
      "id": "a9ddd7b8-aef4-47da-8eb3-2be1e27c5433",
      "name": "Normalize String"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Normalize add-on flags to real booleans and avoid name clashes\nconst toArr = (v) => Array.isArray(v) ? v.map(x => String(x).toLowerCase().trim()) : [];\nconst isTrueStr = (v) => typeof v === 'string' && v.trim().toLowerCase() === 'true';\n\nconst addons = toArr($json.addons || []);\n\nconst hasExtraCoverLetterBool =\n  $json.hasExtraCoverLetter === true || isTrueStr($json.hasExtraCoverLetter) ||\n  addons.includes('extracoverletter');\n\nconst hasLinkedInBool =\n  $json.hasLinkedIn === true || isTrueStr($json.hasLinkedIn) ||\n  addons.includes('linkedin') || addons.includes('linkedinoptimize');\n\nconst needsEditableWordBool =\n  $json.needsEditableWord === true || isTrueStr($json.needsEditableWord) ||\n  addons.includes('editableword');\n\nconst isOneDayDeliveryBool =\n  $json.isOneDayDelivery === true || isTrueStr($json.isOneDayDelivery) ||\n  addons.includes('oneday');\n\nreturn {\n  json: {\n    ...$json,\n    // write NEW keys to avoid conflicts with any incoming string fields\n    hasExtraCoverLetterBool,\n    hasLinkedInBool,\n    needsEditableWordBool,\n    isOneDayDeliveryBool,\n  },\n  binary: $binary,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7280,
        432
      ],
      "id": "a540db59-20c9-48bb-87ba-d92d3dabb4e8",
      "name": "Normalize - Addon Flags to Boolean"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3414014b-cebc-48e5-8301-2cfce76191de",
              "leftValue": "={{ ($json.schema || '').trim() }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "df46ca21-1861-48ee-9212-a6e6b8a1af24",
              "leftValue": "={{ ($json.orderId || '').trim() }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        21872,
        272
      ],
      "id": "3a283c29-5ce9-4287-a9de-83278f776320",
      "name": "Validate - Has Schema and OrderId"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "373e5942-251d-47fb-bf01-02318df5efc0",
              "leftValue": "={{ !!$json.orderId }}",
              "rightValue": "=",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        22544,
        272
      ],
      "id": "5de75ef3-2e8f-4000-bf1d-2be29ef0f694",
      "name": "Validate - Has OrderId"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c941e5eb-da03-472b-a498-174ea211bbaf",
              "name": "schema",
              "value": "={{ $json.schema || $json._cfg?.pgSchema || 'public' }}",
              "type": "string"
            },
            {
              "id": "e3e9164b-ee20-4a33-87d3-3d99d633e0f5",
              "name": "orderId",
              "value": "={{ $json.orderId || $node[\"Code - Ensure orderID\"]?.json.orderId || '' }}",
              "type": "string"
            },
            {
              "id": "9fa2cf8f-d8ea-417a-9ff3-8a99aac3e782",
              "name": "bucket",
              "value": "={{ $json.bucket || $json._cfg?.bucket || '' }}",
              "type": "string"
            },
            {
              "id": "b72e8587-f9c5-428f-9f21-33e6f5cec77b",
              "name": "entPriorityBool",
              "value": "={{ ($json.entPriority === true) || (typeof $json.entPriority === 'string' && $json.entPriority.trim().toLowerCase() === 'true') }}",
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        22768,
        272
      ],
      "id": "61f8cb61-3de3-46a1-9abd-299131488f4d",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "55305d5c-5141-4752-b151-184c0acaaf98",
              "leftValue": "={{ /^[0-9a-f-]{36}$/i.test(($json.orderId || '').trim()) }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -560,
        864
      ],
      "id": "0ff1bf0e-bd0e-4bf3-88ff-e3b77e8404d6",
      "name": "If UUID"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c013366d-a353-4530-8f5f-f3da86fa616a",
              "name": "=cvOrigKey",
              "value": "={{ 'orders/' + $json.orderId + '/cv_original.' + ($json.cvExt || 'txt') }}",
              "type": "string"
            },
            {
              "id": "425fe294-ca91-4e66-9688-3ca6571a2940",
              "name": "=cvRewriteKey",
              "value": "={{ 'orders/' + $json.orderId + '/cv_rewritten.txt' }}",
              "type": "string"
            },
            {
              "id": "8bb38c2f-ee4d-48a6-873d-34bea5b63880",
              "name": "=coverLetterKey",
              "value": "={{ 'orders/' + $json.orderId + '/cover_letter.txt' }}",
              "type": "string"
            },
            {
              "id": "22c2be45-3e48-463e-bb0b-85caf5717639",
              "name": "=bucket",
              "value": "={{ $json.bucket || $json._cfg?.bucket }}",
              "type": "string"
            },
            {
              "id": "67b8da41-c087-40a3-ab01-6122edbcfe1c",
              "name": "=schema",
              "value": "={{ $json.schema || $json._cfg?.pgSchema || 'public' }}",
              "type": "string"
            },
            {
              "id": "5ef57e91-886f-4335-bcbc-c29d79cc2bc1",
              "name": "=linkedinKey",
              "value": "={{ 'orders/' + $json.orderId + '/linkedin.txt' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        112,
        864
      ],
      "id": "589baa70-4b2c-4fb0-90f8-3cc56a1b5b5c",
      "name": "Build Keys1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "43f25895-896b-48da-a6a3-41b60dea3f75",
              "name": "=orderId",
              "value": "={{ $json.orderId || $json.rows?.[0]?.orderId || $json.id || '' }}",
              "type": "string"
            },
            {
              "id": "de75ab4c-a642-493e-8e99-efc542eeaf6f",
              "name": "=extId",
              "value": "={{ $json.extId   || $json.rows?.[0]?.extId   || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -112,
        800
      ],
      "id": "f347f362-3d18-4fb9-8ebd-ee7f0eec1361",
      "name": "Capture orderId"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "insert into public.orders (ext_id, package, addons, email)\nvalues ($1, $2, $3::jsonb, $4)\non conflict (ext_id) do update\n  set package = excluded.package,\n      addons  = excluded.addons,\n      email   = coalesce(excluded.email, orders.email)\nreturning id as \"orderId\", ext_id as \"extId\";",
        "options": {
          "queryReplacement": "={{ [\n  // $1 ext_id\n  ($json.orderId ?? $json.sessionId ?? $json.extId ?? $json.verifiedOrderId ?? null),\n\n  // $2 package\n  String($json.package ?? $json.packageTier ?? '').trim() || null,\n\n  // $3 addons (jsonb)\n  JSON.stringify(Array.isArray($json.addons) ? $json.addons : []),\n\n  // $4 email\n  ($json.email ? String($json.email).trim() : null)\n] }}\n"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -336,
        800
      ],
      "id": "9072c9a1-a96c-4e76-bae8-291fefe583b2",
      "name": "Upsert Order",
      "credentials": {
        "postgres": {
          "id": "9OVCjeTvYAa1i2Cv",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Param bundle: $1 JSON with { orderId, sessionId }\nWITH params AS (\n  SELECT\n    ($1::jsonb->>'orderId')::uuid AS order_id,\n    NULLIF($1::jsonb->>'sessionId','')::text AS session_id\n),\nupd AS (\n  UPDATE public.orders o\n  SET\n    status = 'processing',\n    stripe_session_id = COALESCE(p.session_id, o.stripe_session_id)\n  FROM params p\n  WHERE o.id = p.order_id\n  RETURNING o.id AS order_id, o.status, o.stripe_session_id\n)\n-- If UPDATE matched, return the updated row.\nSELECT order_id, status, stripe_session_id, 'updated' AS outcome\nFROM upd\nUNION ALL\n-- Otherwise emit a synthetic row so n8n always has output.\nSELECT p.order_id,\n       'processing'::text AS status,\n       p.session_id::text AS stripe_session_id,\n       'not_found' AS outcome\nFROM params p\nWHERE NOT EXISTS (SELECT 1 FROM upd);",
        "options": {
          "queryReplacement": "=={{ JSON.stringify({ orderId: $json.orderId, sessionId: $json.sessionId ?? null }) }}\n"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4368,
        432
      ],
      "id": "6de7d4b5-cbc1-449a-8835-74a8abf8c2d5",
      "name": "Update Order",
      "credentials": {
        "postgres": {
          "id": "9OVCjeTvYAa1i2Cv",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "claude-sonnet-4-20250514",
          "mode": "list",
          "cachedResultName": "claude-sonnet-4-20250514"
        },
        "messages": {
          "values": [
            {
              "content": "You are a professional career coach. Write a professionally written, concise, tailored and compelling cover letter. Use a confident tone suitable for competitive roles.\nClear 4-part structure:\n\nOpening aligned to role\n\nValue proposition\n\nRelevant achievements\n\nConfident close\n\nNo fictional achievements\n\nClean, formal tone\n\nNo placeholders"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        9904,
        432
      ],
      "id": "f084585e-bf84-4171-80ab-1266b800e1bb",
      "name": "Cover Letter Rewrite",
      "credentials": {
        "anthropicApi": {
          "id": "QtCeYDpyX4nPfGg5",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "claude-sonnet-4-20250514",
          "mode": "list",
          "cachedResultName": "claude-sonnet-4-20250514"
        },
        "messages": {
          "values": [
            {
              "content": "You are a professional career coach. Write concise and compelling cover letters. Use a confident tone suitable for competitive roles.\nADVANCED COVER LETTER\n\nThe Premium-tier cover letter should feel:\n\nMore persuasive\n\nMore strategically positioned\n\nMore clearly aligned to employer business goals\n\nMore polished in tone\n\n180â€“250 words."
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        9552,
        624
      ],
      "id": "7f17b649-2b41-424c-9ce0-20c2dc562c93",
      "name": "Cover Letter Rewrite1",
      "credentials": {
        "anthropicApi": {
          "id": "QtCeYDpyX4nPfGg5",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "claude-opus-4-1-20250805",
          "mode": "list",
          "cachedResultName": "claude-opus-4-1-20250805"
        },
        "messages": {
          "values": [
            {
              "content": "You are a professional career coach. Write concise and compelling cover letters. Use a confident tone suitable for competitive roles.\n\nWrite a leadership-level cover letter (180â€“250 words):\n\nStrong opening positioning\n\nFocus on strategic value\n\nHigh-impact accomplishments (only if real)\n\nLeadership alignment with employer needs\n\nConfident, polished close"
            }
          ]
        },
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        9200,
        816
      ],
      "id": "4cdf0271-cfcc-4089-ba2e-9614bad2fdd8",
      "name": "Cover Letter Rewrite2",
      "credentials": {
        "anthropicApi": {
          "id": "QtCeYDpyX4nPfGg5",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Guard Node\n// Make sure this runs AFTER \"Extract from File1\"\n// and AFTER your JD normalisation nodes.\n\n// 0) Clone current json so we don't mutate $json directly\nconst j = { ...$json };\n\n// ------------------------------------------\n// Helper: safely read cvText from some node\n// ------------------------------------------\nfunction safeCvFrom(nodeName) {\n  try {\n    const n = $item(0).$node[nodeName]?.json;\n    if (!n) return '';\n    const v = n.cvText ?? n.text ?? '';\n    return typeof v === 'string' ? v : String(v || '');\n  } catch (e) {\n    return '';\n  }\n}\n\n// ------------------------------------------\n// 1) Resolve cvText\n// ------------------------------------------\nlet cvText = '';\n\n// a) If this item already has cvText and it's not a template artefact, use it\nif (typeof j.cvText === 'string') {\n  const trimmed = j.cvText.trim();\n  const looksLikeTemplate = trimmed.includes('{{$');\n  const looksLikeLabel = trimmed.startsWith('cvText (String) =');\n\n  if (trimmed && !looksLikeTemplate && !looksLikeLabel) {\n    cvText = trimmed;\n  }\n}\n\n// b) Otherwise, pull it from upstream extract nodes\nif (!cvText) {\n  // MAIN: your generic extractor for TXT uploads\n  const fromExtract = safeCvFrom('Extract from File1'); // <== make sure name matches exactly\n\n  // Fallbacks: old extract nodes if they exist in your workflow\n  const fromTxt  = safeCvFrom('TXT Field');\n  const fromPdf  = safeCvFrom('PDF - Text');\n  const fromDocx = safeCvFrom('DOCX - Text');\n  const fromDoc  = safeCvFrom('DOC - Text');\n\n  const rawCv = fromExtract || fromTxt || fromPdf || fromDocx || fromDoc || '';\n\n  cvText = String(rawCv).replace(/\\r\\n/g, '\\n').trim();\n}\n\n// c) If we STILL don't have CV text, fail loudly â€“ AI rewrite without CV is pointless\nif (!cvText) {\n  throw new Error(\n    \"[Guard] Missing cvText. Make sure 'Extract from File1' (or TXT/PDF/DOCX/DOC \" +\n    \"text nodes) run before this node and output a cvText field.\"\n  );\n}\n\n// ------------------------------------------\n// 2) Resolve jobDescription (keep your behaviour)\n// ------------------------------------------\nconst jobDescription =\n  j.jobDescription ||\n  $node['Sanitize JD']?.json?.jdText ||\n  $node['Normalise & Validate']?.json?.jobDescription ||\n  '';\n\nif (!jobDescription.trim()) {\n  console.warn(\n    '[Guard] jobDescription is empty for order',\n    j.orderId || j.order_id\n  );\n}\n\n// ------------------------------------------\n// 3) Return: keep everything, just ensure cvText + jobDescription are set\n// ------------------------------------------\nreturn {\n  json: {\n    ...j,\n    cvText,\n    jobDescription,\n  },\n  // pass through any binary (CV file etc.) unchanged\n  binary: $binary,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8176,
        432
      ],
      "id": "70c2e22b-0e00-4a01-9c82-81d6879ed968",
      "name": "Guard Node1"
    },
    {
      "parameters": {
        "sendTo": "={{ $env.ADMIN_EMAIL || 'admin@example.com' }}",
        "subject": "Unknown or Missing Package ",
        "message": "=â€œâš ï¸ Unknown or missing package for order {{$json.orderId}}. Please investigate.â€",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        8912,
        1008
      ],
      "id": "68f5826c-0ec8-4875-8ec8-99cdf389fcf7",
      "name": "Report a failed Order",
      "webhookId": "af376b83-feb9-4281-bc97-897f7bc6242c",
      "credentials": {
        "gmailOAuth2": {
          "id": "XifC0N82x0L992s5",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "try {\n  const j = $json;\n  const u = (typeof j.urls === 'string'\n    ? (JSON.parse(j.urls || '{}') || {})\n    : (j.urls || {}));\n\n  const cv   = u.cv          ?? '';\n  const cl   = u.coverLetter ?? '';\n  const li   = u.linkedin    ?? '';\n  const docx = u.docx        ?? '';\n  const rtf  = u.rtf         ?? '';\n\n  const linksHtml = [\n    cv   && `â€¢ CV: <a href=\"${cv}\">Download</a><br>`,\n    cl   && `â€¢ Cover Letter: <a href=\"${cl}\">Download</a><br>`,\n    li   && `â€¢ LinkedIn: <a href=\"${li}\">Download</a><br>`,\n    docx && `â€¢ DOCX: <a href=\"${docx}\">Download</a><br>`,\n    rtf  && `â€¢ RTF: <a href=\"${rtf}\">Download</a><br>`,\n  ].filter(Boolean).join('');\n\n  return {\n    json: {\n      ...j,\n      recipient: j.recipient || j.email || j.customer_email || '',\n      subject: \"Your tailored CV is ready\",\n      body_html: `Hi ${j.candidateName || 'there'},<br><br>\nYour tailored CV for <b>${j.jobTitle || j.role || 'the role'}</b> is ready.<br><br>\nDownloads:<br>\n${linksHtml}\n<br>Thanks for using <b>AI-Vitae</b>!`,\n      payload: {\n        urls: { cv, coverLetter: cl, linkedin: li, docx, rtf },\n        candidateName: j.candidateName || '',\n        jobTitle: j.jobTitle || j.role || ''\n      }\n    }\n  };\n} catch (err) {\n  return { json: { ...$json, buildEmailPayloadError: String(err || 'unknown') } };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        24560,
        272
      ],
      "id": "c5392cd8-46cb-407c-b558-10b3ce850711",
      "name": "Build Email Payload"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH p AS (\n  SELECT\n    ($1::jsonb->>'orderId')::uuid                AS order_id,\n    NULLIF($1::jsonb->>'recipient','')           AS recipient,\n    NULLIF($1::jsonb->>'subject','')             AS subject,\n    NULLIF($1::jsonb->>'body_html','')           AS body_html,\n    COALESCE($1::jsonb->'payload', '{}'::jsonb)  AS payload\n),\nnorm AS (\n  SELECT\n    p.order_id,\n    COALESCE(p.recipient, NULLIF(o.customer_email, '')) AS recipient,\n    p.subject,\n    p.body_html,\n    p.payload\n  FROM p\n  LEFT JOIN public.orders o ON o.id = p.order_id\n)\nINSERT INTO public.email_jobs (order_id, recipient, subject, body_html, payload)\nSELECT order_id, recipient, subject, body_html, payload\nFROM norm\nWHERE recipient IS NOT NULL             -- guard against nulls\nON CONFLICT (order_id, recipient) DO UPDATE\nSET subject    = EXCLUDED.subject,\n    body_html  = EXCLUDED.body_html,\n    payload    = EXCLUDED.payload,\n    updated_at = NOW()\nRETURNING id, status, created_at;",
        "options": {
          "queryReplacement": "={{ [\n  JSON.stringify({\n    orderId:   $json.orderId || $json.order_id || '',\n    recipient: $json.recipient || $json.email || $json.customer_email || '',\n    subject:   $json.subject || '',\n    body_html: $json.body_html || '',\n    payload:   $json.payload || {}\n  })\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        24784,
        272
      ],
      "id": "01fde0a7-7957-4d5c-8730-4a681e0e2d69",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "9OVCjeTvYAa1i2Cv",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Re-attach canonical context to each tail item\n\nconst carry = $item(0).$node['Context (carry)']?.json || {};\n\nconst ctx = {\n  orderId:       carry.orderId       || '',\n  email:         carry.email         || '',\n  candidateName: carry.candidateName || '',\n  package:       carry.package       || '',\n  addons:        Array.isArray(carry.addons) ? carry.addons : [],\n  cvExt:         carry.cvExt         || '',\n  source:        carry.source        || 'web',\n  tokenCostEur:  carry.tokenCostEur  ?? null,\n  priority:      carry.priority === true\n};\n\nreturn items.map(it => ({\n  json: { ...ctx, ...it.json }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        23216,
        272
      ],
      "id": "9ef280a5-44fe-46fe-8c10-1b1fa9ada91e",
      "name": "Reattach Context"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7918e434-92ec-486c-abd4-7a0d461cfb3f",
              "name": "=orderId",
              "value": "={{ $json.orderId || $json.order_id || '' }}",
              "type": "string"
            },
            {
              "id": "6d2c63a4-ccc0-420d-a679-bc60a5304f42",
              "name": "=email",
              "value": "={{ $json.email || $json.customer_email || '' }}",
              "type": "string"
            },
            {
              "id": "1a8bfa4c-22fc-4a3a-8adc-27a981a8ae1d",
              "name": "=candidateName",
              "value": "={{ \n  $json.candidateName \n  || $json.full_name \n  || $node[\"Webhook Intake\"].json.candidateName \n  || '' \n}}",
              "type": "string"
            },
            {
              "id": "985f7347-0b22-4cfa-be5f-261b970d14d6",
              "name": "=package",
              "value": "={{ ($json.package || $json.packageTier || '').toString().trim().toLowerCase() }}",
              "type": "string"
            },
            {
              "id": "1f012398-aa60-41d6-80bc-8a764a4ea712",
              "name": "=addons",
              "value": "={{ Array.isArray($json.addons) ? $json.addons : ($json._ctx?.rawAddons || []) }}",
              "type": "array"
            },
            {
              "id": "a58e8215-d7ad-4721-ad69-84ae136c1227",
              "name": "=cvExt",
              "value": "={{ $json.cvExt || '' }}",
              "type": "string"
            },
            {
              "id": "29406af4-058f-4801-a3aa-014839009819",
              "name": "=source",
              "value": "={{ $json.source || 'web' }}",
              "type": "string"
            },
            {
              "id": "e6254410-7fb7-4d1a-b2f5-79a133402681",
              "name": "=tokenCostEur",
              "value": "={{ $json.tokenCostEur ?? $json.cost_eur ?? null }}",
              "type": "number"
            },
            {
              "id": "d68204a5-b06b-4621-b17b-a25bb4f9b1f5",
              "name": "=priority",
              "value": "={{ $json.priority === true || $json.entPriority === true || $json.entPriorityBool === true }}",
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        8400,
        432
      ],
      "id": "6c5610b1-d80e-4c2e-9bc2-57dda0a79b0e",
      "name": "Context (carry)"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "with p as (\n  select\n    ($1::jsonb->>'orderId')::uuid                  as order_id,\n    nullif($1::jsonb->>'email','')                 as email,\n    nullif($1::jsonb->>'candidateName','')         as full_name,\n    nullif($1::jsonb->>'currentPosition','')       as current_position,\n    nullif($1::jsonb->>'targetPosition','')        as target_position\n)\ninsert into public.customer_data (order_id, email, full_name, current_position, target_position)\nselect order_id, email, full_name, current_position, target_position\nfrom p\non conflict (order_id) do update\nset email            = coalesce(excluded.email,            customer_data.email),\n    full_name        = coalesce(excluded.full_name,        customer_data.full_name),\n    current_position = coalesce(excluded.current_position, customer_data.current_position),\n    target_position  = coalesce(excluded.target_position,  customer_data.target_position),\n    updated_at       = now()\nreturning *;",
        "options": {
          "queryReplacement": "={{ [   JSON.stringify({     orderId:         $json.orderId || $json.order_id || '',     email:           $json.email   || $json.customer_email || '',     candidateName:   $json.candidateName || '',     currentPosition: $json.currentPosition || '',     targetPosition:  $json.targetPosition  || $json.jobTitle || ''   }) ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        24112,
        272
      ],
      "id": "8c307628-441e-4ce2-8479-049e4ec05b7d",
      "name": "Execute a SQL query1",
      "credentials": {
        "postgres": {
          "id": "9OVCjeTvYAa1i2Cv",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "/careeredge/submit",
        "responseMode": "responseNode",
        "options": {
          "binaryPropertyName": "cv"
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -3248,
        960
      ],
      "id": "98c4c07c-1ac3-428a-82e8-1398eebbb109",
      "name": "Webhook Intake",
      "webhookId": "5582e62f-8942-4d06-b5d9-d1f40faf9096"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Consolidate everything needed for the P&L row from authoritative nodes\n\n// 1) Canonical context (orderId, email, package, addons, etc.)\nconst carry = $item(0).$node['Context (carry)']?.json || {};\nconst ctx   = $json; // current item after Reattach Context, Mark Order Done, etc.\n\n// Prefer Reattach values, fallback to raw Context if needed\nconst orderId = ctx.orderId || ctx.order_id || carry.orderId || carry.order_id || '';\nconst email   = ctx.email   || carry.email || '';\nconst candidateName = ctx.candidateName || carry.candidateName || '';\n\n// Package & addons\nconst pkgRaw  = (ctx.package || carry.package || '').toString().trim().toLowerCase();\nconst addons  = Array.isArray(ctx.addons)\n  ? ctx.addons\n  : (Array.isArray(carry.addons) ? carry.addons : []);\n\n// 2) Document keys from Shape Documents Map\nconst docsNode = $item(0).$node['Shape Documents Map']?.json || {};\nconst keys = docsNode.keys || {};\n\n// 3) Pricing and execution estimate\nconst priceMap = {\n  starter:   4.99,\n  standard:  7.99,\n  premium:   14.99,\n  executive: 24.99,\n};\n\nconst priority =\n  ctx.priority === true ||\n  ctx.entPriority === true ||\n  ctx.entPriorityBool === true ||\n  carry.priority === true;\n\nlet execEst;\nif (priority) {\n  execEst = 24;\n} else if (pkgRaw === 'starter') {\n  execEst = 72;\n} else if (pkgRaw === 'standard') {\n  execEst = 96;\n} else if (pkgRaw === 'premium') {\n  execEst = 120;\n} else if (pkgRaw === 'executive') {\n  execEst = 168;\n} else {\n  execEst = 96;\n}\n\nconst priceEur = Number(priceMap[pkgRaw] ?? 0);\n\n// 4) Build the \"sheet\" object that your Google Sheets node will use\nconst sheet = {\n  orderId:        orderId,\n  timestamp:      new Date().toISOString(),\n  email:          email,\n  candidateName:  candidateName,\n  package:        pkgRaw,\n  addons:         JSON.stringify(addons),\n  price_eur:      priceEur,\n  priority:       priority,\n  exec_est:       execEst,\n  cv_ext:         ctx.cvExt || carry.cvExt || '',\n  source:         ctx.source || carry.source || 'web',\n\n  cv_re_key:      keys.cv          || '',\n  cover_key:      keys.coverLetter || '',\n  li_key:         keys.linkedin    || '',\n  docx_key:       keys.docx        || '',\n  rtf_key:        keys.rtf         || '',\n\n  status:         'done',\n  token_cost_eur: ctx.tokenCostEur ?? carry.tokenCostEur ?? null,\n  notes:          ctx.notes || ''\n};\n\nreturn {\n  json: {\n    ...ctx,   // keep everything else for debugging if needed\n    sheet\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        23664,
        272
      ],
      "id": "eceec08e-956a-4ee8-aac3-48e96301565e",
      "name": "Prepare Row for Sheets"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c36c808a-07c4-42a1-886c-dbf2efd4ea8b",
              "name": "orderId ",
              "value": "={{ $json.orderId || $json.order_id || '' }}",
              "type": "string"
            },
            {
              "id": "c01566e2-c08d-4e3f-ad4a-410e844d2bb6",
              "name": "package",
              "value": "={{ $json.package || '' }}",
              "type": "string"
            },
            {
              "id": "5820e4f1-e5cf-45c2-a162-dde74e676308",
              "name": "priority",
              "value": "={{ !!($json.priority ?? $json.entPriority ?? $json.entPriorityBool ?? false) }}",
              "type": "boolean"
            },
            {
              "id": "e5c3e352-addd-42c0-b6fd-ebc7daa215c5",
              "name": "dueDate",
              "value": "={{ $json.dueDate || '' }}",
              "type": "string"
            },
            {
              "id": "f5c492e7-fd53-43c6-b474-7c7ad51c5ed4",
              "name": "keys",
              "value": "={{ $json.keys || {\n  cv:          $json.documents?.cv_rewritten      || '',\n  coverLetter: $json.documents?.cover_letter      || '',\n  linkedin:    $json.documents?.linkedin_profile  || '',\n  docx:        $json.documents?.cv_rewrite_docx   || '',\n  rtf:         $json.documents?.cv_rewrite_rtf    || '',\n} }}",
              "type": "object"
            },
            {
              "id": "dddfd295-52ac-474f-9899-425db6faa221",
              "name": "urls",
              "value": "={{ $json.urls || {\n  cv:          $json.cvUrl           || $json.cv_rewrite_url   || '',\n  coverLetter: $json.coverLetterUrl  || $json.cover_letter_url || '',\n  linkedin:    $json.linkedinUrl     || $json.linkedin_url     || '',\n  docx:        $json.docxUrl         || $json.docx_url         || '',\n  rtf:         $json.rtfUrl          || $json.rtf_url          || '',\n} }}",
              "type": "object"
            },
            {
              "id": "2c69d80b-754e-48a2-a0c4-30725fbaab55",
              "name": "email",
              "value": "={{ $json.email || $json.recipient || $json.customer_email || '' }}",
              "type": "string"
            },
            {
              "id": "b80601c6-557a-4e65-a808-68ba1e11ae76",
              "name": "candidateName",
              "value": "={{ $json.candidateName || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        24336,
        272
      ],
      "id": "08596159-85eb-48a6-95a0-35d815e93258",
      "name": "Assemble Response"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Compute total token cost (EUR) for this order.\n *\n * Place this node AFTER all AI nodes and AFTER \"Reattach Context\".\n * Place BEFORE Google Sheets or database writes.\n */\n\n// -------------------------------------------------------------\n// 1) USD â†’ EUR conversion\n// -------------------------------------------------------------\nconst EUR_PER_USD = 0.92;        // adjust if needed\n\n// -------------------------------------------------------------\n// 2) Real API Prices (converted to EUR per TOKEN)\n// -------------------------------------------------------------\n//\n// All values use official API pricing PER MILLION tokens in USD:\n//   GPT-4o ............... $5 input / $15 output\n//   GPT-4 ................ $2 input / $8 output\n//   GPT-4o-mini .......... $0.15 input / $0.60 output\n//   Claude Sonnet 4 ...... $3 input / $15 output\n//   Claude Opus 4.1 ...... $15 input / $75 output\n//   Claude Haiku 3.5 ..... $0.80 input / $4 output\n//\n// Then converted to EUR/token.\n//\n\nconst PRICING = {\n  gpt_4o: {\n    input:  (5  * EUR_PER_USD) / 1_000_000,\n    output: (15 * EUR_PER_USD) / 1_000_000,\n  },\n  gpt_4: {\n    input:  (2  * EUR_PER_USD) / 1_000_000,\n    output: (8  * EUR_PER_USD) / 1_000_000,\n  },\n  gpt_4o_mini: {\n    input:  (0.15 * EUR_PER_USD) / 1_000_000,\n    output: (0.60 * EUR_PER_USD) / 1_000_000,\n  },\n  claude_sonnet_4: {\n    input:  (3  * EUR_PER_USD) / 1_000_000,\n    output: (15 * EUR_PER_USD) / 1_000_000,\n  },\n  claude_opus_4_1: {\n    input:  (15 * EUR_PER_USD) / 1_000_000,\n    output: (75 * EUR_PER_USD) / 1_000_000,\n  },\n  claude_haiku_3_5: {\n    input:  (0.8 * EUR_PER_USD) / 1_000_000,\n    output: (4   * EUR_PER_USD) / 1_000_000,\n  }\n};\n\n// -------------------------------------------------------------\n// 3) Map: Which AI node uses which model?\n//    (Names must match EXACTLY your n8n node names)\n// -------------------------------------------------------------\nconst STEPS = [\n  // Starter / Standard â†’ GPT-4o-mini\n  { name: 'cv_rewrite',       node: 'Rewrite CV',           model: 'gpt_4o_mini' },\n  { name: 'cv_rewrite_v1',    node: 'Rewrite CV1',          model: 'gpt_4o_mini' },\n  { name: 'cv_rewrite_v2',    node: 'Rewrite CV2',          model: 'gpt_4o_mini' },\n  { name: 'cv_rewrite_v3',    node: 'Rewrite CV3',          model: 'gpt_4o_mini' },\n  { name: 'cover_letter',     node: 'Cover Letter Rewrite', model: 'gpt_4o_mini' },\n\n  // Premium â†’ Claude Sonnet 4\n  { name: 'premium_cv',       node: 'Message a model3',     model: 'claude_sonnet_4' },\n\n  // Executive â†’ Claude Opus 4.1\n  { name: 'executive_cv',     node: 'Message a model11',    model: 'claude_opus_4_1' },\n];\n\n// -------------------------------------------------------------\n// 4) Extract token usage from a node's JSON\n// -------------------------------------------------------------\nfunction extractTokens(nodeJson = {}) {\n  const usage = nodeJson.usage || nodeJson.metrics || {};\n\n  const promptTokens =\n    usage.prompt_tokens ??\n    usage.input_tokens ??\n    0;\n\n  const completionTokens =\n    usage.completion_tokens ??\n    usage.output_tokens ??\n    0;\n\n  const totalTokens =\n    usage.total_tokens ??\n    (promptTokens + completionTokens);\n\n  return { promptTokens, completionTokens, totalTokens };\n}\n\n// -------------------------------------------------------------\n// 5) Compute cost for one step\n// -------------------------------------------------------------\nfunction costForStep(tokens, modelKey) {\n  const pricing = PRICING[modelKey];\n  if (!pricing) return 0;\n\n  const inputCost  = tokens.promptTokens     * pricing.input;\n  const outputCost = tokens.completionTokens * pricing.output;\n\n  return inputCost + outputCost;\n}\n\n// -------------------------------------------------------------\n// 6) Compute total + breakdown (using item 0)\n// -------------------------------------------------------------\nlet totalCost = 0;\nconst breakdown = {};\n\nfor (const step of STEPS) {\n  let nodeData;\n\n  try {\n    nodeData = $item(0).$node[step.node].json;\n  } catch (e) {\n    continue; // node didn't run in this branch\n  }\n\n  if (!nodeData) continue;\n\n  const tokens = extractTokens(nodeData);\n  const stepCost = costForStep(tokens, step.model);\n\n  breakdown[step.name] = {\n    model: step.model,\n    tokens,\n    cost_eur: stepCost,\n  };\n\n  totalCost += stepCost;\n}\n\n// -------------------------------------------------------------\n// 7) Attach cost to ALL items\n// -------------------------------------------------------------\nreturn items.map(it => ({\n  json: {\n    ...it.json,\n    tokenCostEur: totalCost,\n    tokenCostBreakdown: breakdown,\n  },\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        23440,
        272
      ],
      "id": "0bb1bf0c-2cca-4038-b7f9-adafeba07115",
      "name": "Compute Token Cost"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Extract CV text from the current item only.\n// Works for your TXT uploads (binary.cv or binary.cv0).\n\nconst j = { ...$json };\n\nlet cvText = '';\n\n// 1) If cvText already exists and is NOT a template artifact, keep it.\nif (typeof j.cvText === 'string') {\n  const trimmed = j.cvText.trim();\n  const looksLikeTemplate = trimmed.includes('{{$');\n  const looksLikeLabel = trimmed.startsWith('cvText (String) =');\n\n  if (trimmed && !looksLikeTemplate && !looksLikeLabel) {\n    cvText = trimmed;\n  }\n}\n\n// 2) Otherwise, decode from binary (TXT path)\nif (!cvText) {\n  const bin = $binary.cv || $binary.cv0 || null;\n  if (bin && bin.data) {\n    try {\n      cvText = Buffer.from(bin.data, 'base64').toString('utf8');\n    } catch (e) {\n      // leave empty if decoding fails\n    }\n  }\n}\n\n// 3) Normalise line endings & trim\nj.cvText = (cvText || '').replace(/\\r\\n/g, '\\n').trim();\n\n// Debug â€“ you should see a non-zero length if the CV was decoded\nconsole.log('[Extract CV Text] length:', j.cvText.length);\n\nreturn {\n  json: j,\n  binary: $binary,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6832,
        432
      ],
      "id": "0652e143-8c61-498a-bf73-acdbde233010",
      "name": "Extract CV Text"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "fd1a66d0-8f0b-4f44-b867-a2d93bac9c7b",
              "leftValue": "={{$json.cvExt}}",
              "rightValue": "\"doc\"",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1904,
        864
      ],
      "id": "0c172b28-d592-43c2-827d-b19eb5ae2c7a",
      "name": "File Type Routing"
    },
    {
      "parameters": {
        "authentication": "apiKey",
        "outputFormat": "txt",
        "inputBinaryPropertyName": "cv"
      },
      "type": "@cloudconvert/n8n-nodes-cloudconvert.cloudConvert",
      "typeVersion": 1,
      "position": [
        -1680,
        768
      ],
      "id": "db8906c1-40c6-43ba-aa49-0ba7c4964748",
      "name": "CloudConvert",
      "credentials": {
        "cloudConvertApi": {
          "id": "8Nso8hxUywKp9TfT",
          "name": "CloudConvert account"
        }
      }
    },
    {
      "parameters": {
        "operation": "fromJson",
        "binaryPropertyName": "cv0",
        "destinationKey": "cvText",
        "options": {
          "keepSource": "binary"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -1456,
        768
      ],
      "id": "b966c9ff-cfd2-4314-953c-1880c71b06ac",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "operation": "text",
        "binaryPropertyName": "cv0",
        "destinationKey": "cvText",
        "options": {
          "keepSource": "binary"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -1456,
        960
      ],
      "id": "6a50fe25-1a8a-4bc2-9cc1-c9f4e615f4f8",
      "name": "Extract from File1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://applysmart.app.n8n.cloud/webhook/email-dispatch",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "orderId",
              "value": "={{ \n  $json.orderId \n  || $json.order_id \n  || $item(0).$node[\"Mark Order Done\"].json.orderId \n  || $item(0).$node[\"Mark Order Done\"].json.order_id \n}}"
            },
            {
              "name": "email",
              "value": "={{$json.email}}"
            },
            {
              "name": "candidateName",
              "value": "={{$json.candidateName}}"
            },
            {
              "name": "package",
              "value": "={{$json.package}}"
            },
            {
              "name": "addons",
              "value": "={{$json.addons}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        25008,
        272
      ],
      "id": "5a289148-7f06-48ab-848d-37e6594a7c6f",
      "name": "Trigger Email Workflow",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Code node: \"Make Rewritten CV File\"\n\nconst j = { ...$json };\n\nconst text = String(j.cvRewriteText || '').trim();\n\nif (!text) {\n  // If for some reason we have no rewrite, just pass through\n  return { json: j, binary: $binary };\n}\n\n// Create a binary file called rewrittenCV\nconst data = Buffer.from(text, 'utf8').toString('base64');\n\nreturn {\n  json: j,\n  binary: {\n    ...( $binary || {} ),\n    rewrittenCV: {\n      data,\n      fileName: 'cv_rewritten.txt',\n      mimeType: 'text/plain',\n    },\n  },\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        10704,
        336
      ],
      "id": "c9c9040d-e673-446b-b3a6-53f8af9e8094",
      "name": "cvRewriteText"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ 'https://' + ($json._cfg?.supabaseUrl || 'REPLACE_WITH_SUPABASE_PROJECT_REF.supabase.co') + '/storage/v1/object/cvstore/orders/' + ($json.ctx?.orderId || $json.orderId || $json.joinKey || '') + '/cv_rewritten.pdf' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ 'Bearer ' + ($json._cfg?.supabaseKey || 'REPLACE_WITH_SUPABASE_SERVICE_ROLE_KEY') }}"
            },
            {
              "name": "Content-Type",
              "value": "application/pdf"
            },
            {
              "name": "x-upsert",
              "value": "true"
            },
            {
              "name": "apikey",
              "value": "={{ $json._cfg?.supabaseKey || 'REPLACE_WITH_SUPABASE_SERVICE_ROLE_KEY' }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "data",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        12848,
        512
      ],
      "id": "68473e46-f9ba-489d-9b53-a144fe5f75c0",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.documents (order_id, kind, storage_key)\nVALUES ($1::uuid, 'cv_rewritten', $2)\nON CONFLICT (order_id, kind) DO UPDATE\nSET storage_key = EXCLUDED.storage_key;",
        "options": {
          "queryReplacement": "={{ [\n  ($json.ctx?.orderId || $json.orderId || $json.joinKey),\n  ($json.Key || $json.storage_key || `cvstore/orders/${$json.ctx?.orderId || $json.orderId || $json.joinKey}/cv_rewritten.pdf`)\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        14064,
        416
      ],
      "id": "4d048595-dbb1-4806-bb4b-774bcb1afff6",
      "name": "Execute a SQL query2",
      "credentials": {
        "postgres": {
          "id": "9OVCjeTvYAa1i2Cv",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3fd9a3db-6b48-46e6-bbc9-3a3252f6324b",
              "name": "=docRow",
              "value": "={{\n  (() => {\n    const oid = $json.ctx?.orderId || $json.orderId || $json.body?.orderId || $json.joinKey || '';\n    return {\n      orderId: oid,\n      storage_key: `orders/${oid}/cv_rewritten.pdf`,\n      key: $json.Key || '',\n      id: $json.Id || '',\n      documentId: $json.documentId || $json.ctx?.documentId || ''\n    };\n  })()\n}}",
              "type": "object"
            },
            {
              "id": "9c43b73d-ad93-4723-a567-4aa7b290448f",
              "name": "=orderId",
              "value": "={{ $json.docRow?.orderId || $json.ctx?.orderId || $json.orderId || $json.body?.orderId || $json.joinKey || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        13840,
        272
      ],
      "id": "dbc1b28a-a309-4b04-9836-021beb1b8e65",
      "name": "Prepare Document Row"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{$json.documentId || $json.id}}",
          "mode": "id"
        },
        "options": {
          "googleFileConversion": {
            "conversion": {
              "docsToFormat": "application/pdf"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        12048,
        272
      ],
      "id": "58be6f68-522b-4c7d-8278-d20a0e8e92c7",
      "name": "Download file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "ioNgSTT7FJkSUINC",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "driveId": "=Ai-Vitae CVs",
        "folderId": "=1vpKP_zlqScqx8Ms9fWhGWqCs0f7jxS4H",
        "title": "=Rewritten CV - {{\n  $json.ctx?.candidateName\n  || $json.candidateName\n  || 'Candidate'\n}} - {{\n  $json.ctx?.orderId\n  || $json.orderId\n  || $json.joinKey\n  || ''\n}}"
      },
      "type": "n8n-nodes-base.googleDocs",
      "typeVersion": 2,
      "position": [
        11152,
        560
      ],
      "id": "8f26f3bf-d0d5-48e4-a09b-e1c4707e8141",
      "name": "Google Docs",
      "credentials": {
        "googleDocsOAuth2Api": {
          "id": "4vk8gMiMgE4tUsQY",
          "name": "Google Docs account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentURL": "={{ $json.documentId || $json.id }}",
        "actionsUi": {
          "actionFields": [
            {
              "action": "insert",
              "text": "={{\n  (() => {\n    const t = (\n      $json.cvRewriteText\n      || $json.ctx?.rewrittenCVText\n      || $json.rewrittenCVText\n      || ''\n    ).toString().trim();\n\n    return t.length ? t : 'CV rewrite was empty (upstream error).';\n  })()\n}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.googleDocs",
      "typeVersion": 2,
      "position": [
        11824,
        272
      ],
      "id": "7b44469d-e375-44f8-b042-3e11fba122f3",
      "name": "Google Docs - Write Content",
      "credentials": {
        "googleDocsOAuth2Api": {
          "id": "4vk8gMiMgE4tUsQY",
          "name": "Google Docs account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.pdf.co/v1/file/convert/to/text",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "cv",
        "options": {
          "response": {
            "response": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3248,
        96
      ],
      "id": "586ed5b4-eff9-42a0-b580-ad451beafa78",
      "name": "DOCX - Text",
      "credentials": {
        "httpHeaderAuth": {
          "id": "3XvhbUxK8iU6x7Hw",
          "name": "Header Auth account 2"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "840f0da9-4f91-4158-a548-6113b1a75965",
              "name": "=ctx.cvText",
              "value": "={{ $json.extractedText || $json.text || $json.body || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3472,
        96
      ],
      "id": "f285ca3c-443a-4c01-9384-b29ae09f2ea7",
      "name": "Edit Fields3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.pdf.co/v1/file/convert/to/text",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "cv",
        "options": {
          "response": {
            "response": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3248,
        288
      ],
      "id": "b141ff0d-cd7e-4df2-b50d-41b51cdd81ad",
      "name": "DOC - Text",
      "credentials": {
        "httpHeaderAuth": {
          "id": "3XvhbUxK8iU6x7Hw",
          "name": "Header Auth account 2"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "de93fa8d-5fb6-420c-8dda-8e12351b3af0",
              "name": "=ctx.cvText",
              "value": "={{ $json.extractedText || $json.text || $json.body || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3472,
        480
      ],
      "id": "bcca2e34-8eff-4f07-924b-8e50a5dabda1",
      "name": "TXT Field"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6cc2d607-c626-4a4a-8753-01aeb5a64d3c",
              "name": "=ctx",
              "value": "={{\n  (() => {\n    const body = $json.body || {};\n\n    const raw = body.addons;\n\n    const addons =\n      Array.isArray(raw)\n        ? raw.map(s => String(s).trim().toLowerCase()).filter(Boolean)\n        : typeof raw === 'string'\n          ? (() => {\n              const t = raw.trim();\n              try {\n                const j = JSON.parse(t);\n                if (Array.isArray(j)) return j.map(s => String(s).trim().toLowerCase()).filter(Boolean);\n              } catch {}\n              return t ? t.split(',').map(s => s.trim().toLowerCase()).filter(Boolean) : [];\n            })()\n          : [];\n\n    const addonSet = addons.reduce((acc, a) => (acc[a] = true, acc), {});\n\n    const flags = {\n      extraCoverLetter: !!addonSet.extracoverletter,\n      oneDay: !!addonSet.oneday,\n      editableWord: !!addonSet.editableword,\n      linkedIn: !!(addonSet.linkedin || addonSet.linkedinoptimize || addonSet.linkedinoptimization),\n    };\n\n    return {\n      ...body,\n      addons,\n      addonSet,\n      flags,\n    };\n  })()\n}}",
              "type": "object"
            },
            {
              "id": "a2436079-2417-4f35-a7d1-89af4035cff3",
              "name": "=cvBinaryKey",
              "value": "={{ Object.keys($binary || {})[0] || '' }}",
              "type": "string"
            },
            {
              "id": "b00055fa-145a-4bc4-82e9-d8bcd4368d57",
              "name": "=orderId",
              "value": "={{ $json.body?.orderId || $json.joinKey || '' }}",
              "type": "string"
            },
            {
              "id": "7b641c12-4bc8-4936-8843-d04d78cb3f80",
              "name": "=joinKey",
              "value": "={{ $json.joinKey || $json.body?.orderId || '' }}",
              "type": "string"
            },
            {
              "id": "541b640a-f251-4dee-abd5-37e2724dc0d3",
              "name": "=ack",
              "value": "={{ true }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2128,
        864
      ],
      "id": "f56ed3fb-c88c-40b8-88af-a54c54b26fbd",
      "name": "Stash Metadata"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d19c5879-6afc-4f19-bcb8-2ddaff6e8e80",
              "name": "=cvText",
              "value": "={{ $json.cvText || $json.text || $json.body || '' }}",
              "type": "string"
            },
            {
              "id": "90cacf60-7abe-43c3-a38d-9182482d6bc9",
              "name": "=addons",
              "value": "{{ $json.meta?.body?.addons || $json.body?.addons || '' }}",
              "type": "string"
            },
            {
              "id": "473a30fe-2547-4a82-8d14-2a03520c190d",
              "name": "=package",
              "value": "{{ $json.meta?.body?.package || $json.body?.package || '' }}",
              "type": "string"
            },
            {
              "id": "1d064bef-15e6-4b2c-8b45-e05631f698f7",
              "name": "=orderId",
              "value": "{{ $json.meta?.body?.orderId || $json.body?.orderId || '' }}",
              "type": "string"
            },
            {
              "id": "2d263fbe-cdb3-48c9-9830-2b30ac54eec4",
              "name": "=email",
              "value": "{{ $json.meta?.body?.email || $json.body?.email || '' }}",
              "type": "string"
            },
            {
              "id": "9e8128ab-aece-4d75-b5e7-27447b465e51",
              "name": "=candidateName",
              "value": "{{ $json.meta?.body?.candidateName || $json.body?.candidateName || '' }}",
              "type": "string"
            },
            {
              "id": "2be6482b-ec64-45d3-a23c-b3980e574952",
              "name": "=jobDescription",
              "value": "{{ $json.meta?.body?.jobDescription || $json.body?.jobDescription || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1008,
        864
      ],
      "id": "266d4b32-1502-408f-a911-dd78a3047de7",
      "name": "Normalize Input"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        14288,
        272
      ],
      "id": "95edb24e-fe51-4de3-be71-dbaf3110de6b",
      "name": "Merge SQL + Payload"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// The \"main\" item is the one that contains ctx/docRow\nconst main = items.find(i => i.json.ctx || i.json.docRow) ?? items[0];\n\n// The SQL result is the one that contains \"success\" or rows and does NOT have ctx/docRow\nconst sql = items.find(i => (i.json.success !== undefined || i.json.length !== undefined) && !i.json.ctx && !i.json.docRow) ?? {};\n\nmain.json.sql = sql.json;\n\nreturn [main];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        14512,
        272
      ],
      "id": "0dac9f6f-de99-45de-add5-0a600d9ed74b",
      "name": "Reattach Context1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6af4c17e-ff05-41a7-99b6-cf9a27216bff",
              "name": "=addons",
              "value": "={{\n  (() => {\n    const raw = $json.ctx?.addons ?? $json.addons ?? [];\n    if (Array.isArray(raw)) return raw.map(a => String(a).trim().toLowerCase()).filter(Boolean);\n    if (typeof raw === 'string') {\n      const t = raw.trim();\n      // allow JSON array string\n      try { const j = JSON.parse(t); if (Array.isArray(j)) return j.map(x => String(x).trim().toLowerCase()).filter(Boolean); } catch {}\n      // allow csv\n      return t ? t.split(',').map(x => x.trim().toLowerCase()).filter(Boolean) : [];\n    }\n    return [];\n  })()\n}}",
              "type": "array"
            },
            {
              "id": "3f180a36-1623-4072-b816-6e2545530b40",
              "name": "=hasExtraCoverLetter",
              "value": "={{\n  (() => {\n    const raw = $json.ctx?.addons ?? $json.addons ?? [];\n    const arr = Array.isArray(raw)\n      ? raw\n      : typeof raw === 'string'\n        ? raw.split(',')   // ok as fallback\n        : [];\n    return arr.map(a => String(a).trim().toLowerCase()).includes('extracoverletter');\n  })()\n}}",
              "type": "boolean"
            },
            {
              "id": "3530a70a-2544-4b12-a655-cb788d25ce2e",
              "name": "=jobDescription",
              "value": "={{ $json.ctx?.jobDescription ?? $json.jobDescription ?? '' }}",
              "type": "string"
            },
            {
              "id": "9300b829-90db-4659-a65c-4755033634dc",
              "name": "=rewrittenCVText",
              "value": "={{ $json.ctx?.rewrittenCVText ?? $json.ctx?.cvRewriteText ?? $json.rewrittenCVText ?? $json.cvRewriteText ?? '' }}",
              "type": "string"
            },
            {
              "id": "4533467c-ce0d-4bba-a9e1-1c10f26092f2",
              "name": "=cvText",
              "value": "={{ $json.ctx?.cvText ?? $json.cvText ?? '' }}",
              "type": "string"
            },
            {
              "id": "ea1e0a91-3ac7-44c8-80fb-377d3df5d1d0",
              "name": "=candidateName",
              "value": "={{ $json.ctx?.candidateName ?? $json.candidateName ?? '' }}",
              "type": "string"
            },
            {
              "id": "50afd495-4f16-4b1e-a21a-426dc1b5257c",
              "name": "=email",
              "value": "={{ $json.ctx?.email ?? $json.email ?? '' }}",
              "type": "string"
            },
            {
              "id": "b9669d53-fab3-48ee-866e-2d0815dc1c0c",
              "name": "=orderId",
              "value": "={{ $json.ctx?.orderId ?? $json.orderId ?? $json.docRow?.orderId ?? '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        14736,
        416
      ],
      "id": "61e2bb89-5f5a-451f-a299-564245c43459",
      "name": "Normalize Payload"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "=joinKey",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        13392,
        272
      ],
      "id": "998b1a77-53f4-4baa-a13a-737617625124",
      "name": "Merge Upload Result + Context"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nconst upload = items.find(i => i.json.Key && i.json.Id) ?? {};\nconst ctxItem = items.find(i => i.json.ctx) ?? {};\n\nreturn [{\n  json: {\n    ...upload.json,\n    ...ctxItem.json,\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13616,
        272
      ],
      "id": "0770d364-9450-4775-abdf-261843c08be5",
      "name": "Collapse To One"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fdfee87d-445e-48bf-bbd9-e7fe6d2a9616",
              "name": "orderId",
              "value": "={{\n  (() => {\n    const direct =\n      $json.orderId || $json.joinKey || $json.ctx?.orderId || '';\n\n    if (direct && String(direct).trim()) {\n      return String(direct).trim().replace(/^=/,'');\n    }\n\n    const k = String($json.Key || $json.key || '');\n    const m = k.match(/orders\\/([^/]+)\\//i);\n    return (m?.[1] || '').toString().trim().replace(/^=/,'');\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "a3deed37-3d58-4f99-aea7-c34c8552397f",
              "name": "=joinKey",
              "value": "={{\n  (() => {\n    // Prefer existing explicit ids if present\n    const direct =\n      $json.joinKey || $json.orderId || $json.ctx?.orderId || '';\n\n    if (direct && String(direct).trim()) {\n      return String(direct).trim().replace(/^=/,'');\n    }\n\n    // Fallback: parse from storage Key like:\n    // \"cvstore/orders/<orderId>/cv_rewritten.pdf\"\n    const k = String($json.Key || $json.key || '');\n    const m = k.match(/orders\\/([^/]+)\\//i);\n    return (m?.[1] || '').toString().trim().replace(/^=/,'');\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "776d673f-a275-4996-aef6-17f87c81a90c",
              "name": "=cvKey",
              "value": "={{\n  (() => {\n    const orderId =\n      ($json.orderId || $json.joinKey || $json.ctx?.orderId || '').toString().trim().replace(/^=/,'')\n      || (String($json.Key || $json.key || '').match(/orders\\/([^/]+)\\//i)?.[1] || '');\n\n    return `orders/${orderId}/cv_rewritten.pdf`;\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "1844de78-0b15-4938-ae62-6467597af96a",
              "name": "=cvUrl",
              "value": "={{\n  (() => {\n    const orderId =\n      ($json.orderId || $json.joinKey || $json.ctx?.orderId || '').toString().trim().replace(/^=/,'')\n      || (String($json.Key || $json.key || '').match(/orders\\/([^/]+)\\//i)?.[1] || '');\n\n    return 'https://' + ($json._cfg?.supabaseUrl || 'REPLACE_WITH_SUPABASE_PROJECT_REF.supabase.co') + '/storage/v1/object/public/cvstore/orders/' + orderId + '/cv_rewritten.pdf';\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "5aa7d888-99f6-46ba-9718-a75355c87c26",
              "name": "ctx",
              "value": "={{\n  (() => {\n    const orderId =\n      ($json.ctx?.orderId || $json.orderId || $json.joinKey || '').toString().trim().replace(/^=/,'')\n      || (String($json.Key || $json.key || '').match(/orders\\/([^/]+)\\//i)?.[1] || '');\n\n    const cvKey = `orders/${orderId}/cv_rewritten.pdf`;\n    const cvUrl = 'https://' + ($json._cfg?.supabaseUrl || 'REPLACE_WITH_SUPABASE_PROJECT_REF.supabase.co') + '/storage/v1/object/public/cvstore/' + cvKey;\n\n    return {\n      ...($json.ctx || {}),\n      orderId,\n      cvKey,\n      cvUrl,\n    };\n  })()\n}}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        13168,
        464
      ],
      "id": "da83db87-47ec-4a0c-893e-d53689941902",
      "name": "Edit Fields4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fdfee87d-445e-48bf-bbd9-e7fe6d2a9616",
              "name": "orderId",
              "value": "={{ $json.ctx.orderId }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        13168,
        272
      ],
      "id": "009039c9-dd00-4431-9bb1-3141a5cb4491",
      "name": "Edit Fields5"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b5bf1ae8-1bbb-4ece-a77b-375bd05560dc",
              "name": "=joinKey",
              "value": "={{\n  (\n    $json.joinKey\n    || $json.ctx?.orderId\n    || $json.orderId\n    || $if($(\"Reattach Context1\").isExecuted, $(\"Reattach Context1\").item.json.joinKey, \"\")\n    || $if($(\"Reattach Context1\").isExecuted, $(\"Reattach Context1\").item.json.ctx?.orderId, \"\")\n    || $if($(\"Stash Context\").isExecuted, $(\"Stash Context\").item.json.joinKey, \"\")\n    || $if($(\"Stash Context\").isExecuted, $(\"Stash Context\").item.json.ctx?.orderId, \"\")\n    || ''\n  ).toString().trim().replace(/^=/,'')\n}}",
              "type": "string"
            },
            {
              "id": "3dd19ff6-6899-4bd4-a401-0c0f051c1b6a",
              "name": "documentId",
              "value": "={{\n  ($json.documentId || $json.id || '').toString().trim()\n}}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        12320,
        384
      ],
      "id": "367c8f12-5536-47d2-8db4-b5f2ff6afefc",
      "name": "Add joinKey to DocResult"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4dc8c9b6-0323-46dc-a220-dc6162015a87",
              "name": "=joinKey",
              "value": "={{\n  (\n    $json.joinKey\n    || $json.ctx?.orderId\n    || $json.orderId\n    || $json.order_id\n    || $items(\"Switch\", 0)[0]?.json?.ctx?.orderId\n    || $items(\"Switch\", 0)[0]?.json?.orderId\n    || ''\n  ).toString().trim().replace(/^=/,'')\n}}",
              "type": "string"
            },
            {
              "id": "4b987d95-dd5a-4080-87a5-5e645e16de07",
              "name": "=ctx",
              "value": "={{\n(() => {\n  // Source of truth = pre-AI payload (Switch), fallback to current JSON\n  const src =\n    $items(\"Switch\", 0)[0]?.json\n    || $json\n    || {};\n\n  const base =\n    (src.ctx && typeof src.ctx === 'object') ? src.ctx : {};\n\n  const clean = (v) =>\n    v === undefined || v === null ? '' : v.toString().trim();\n\n  const orderId = clean(\n    base.orderId || src.orderId || src.order_id || src.joinKey\n  ).replace(/^=/, '');\n\n  const candidateName = clean(\n    src.candidateName || base.candidateName\n  );\n\n  const email = clean(\n    src.email || base.email\n  );\n\n  const pkg = clean(\n    src.package || base.package || src.packageTier\n  );\n\n  const jobDescription =\n    (src.jobDescription || base.jobDescription || '').toString();\n\n  // Normalize addons into array\n  let addons = base.addons || src.addons || [];\n  if (typeof addons === 'string') {\n    addons = addons\n      .split(',')\n      .map(a => a.trim())\n      .filter(Boolean);\n  }\n  if (!Array.isArray(addons)) addons = [];\n\n  const flags = base.flags || src.flags || {};\n\n  // ðŸ”‘ Canonical rewritten CV text (ALWAYS STRING)\n  const rewrittenCVText =\n    (\n      $json.message?.content\n      || $json.choices?.[0]?.message?.content\n      || base.rewrittenCVText\n      || ''\n    ).toString().trim();\n\n  return {\n    orderId,\n    candidateName,\n    email,\n    package: pkg,\n    jobDescription,\n    addons,\n    flags,\n    rewrittenCVText,\n  };\n})()\n}}",
              "type": "object"
            },
            {
              "id": "e3074ca8-49ec-45c5-bc07-ee4b0820160a",
              "name": "=cvRewriteText",
              "value": "={{\n(\n  $json.message?.content\n  || $json.choices?.[0]?.message?.content\n  || $json.ctx?.rewrittenCVText\n  || ''\n).toString().trim()\n}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        10928,
        336
      ],
      "id": "1af10576-6705-4783-9300-a276573a006f",
      "name": "Stash Context"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "joinKey",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        12576,
        272
      ],
      "id": "48803bc0-0b45-440e-9340-d5978aade834",
      "name": "Merge Back"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// 1) Find the item that has ctx (this is your â€œmainâ€ payload)\nconst ctxItem = items.find(i => i.json?.ctx) || items[0];\n\n// 2) Find the item that has the PDF binary (binary field is \"data\")\nconst binItem = items.find(i => i.binary?.data) || ctxItem;\n\n// 3) Resolve documentId safely (prefer non-null, non-empty)\nconst docId =\n  items.map(i => i.json?.documentId).find(v => v !== null && v !== undefined && String(v).trim() !== '') ||\n  ctxItem.json?.ctx?.documentId ||\n  null;\n\n// 4) Create one final JSON object (prefer ctxItem as base)\nconst outJson = {\n  ...(ctxItem.json || {}),\n  // force documentId to the best value we found (won't be overwritten by null)\n  documentId: docId,\n};\n\n// 5) Ensure ctx exists and has orderId (since downstream relies on ctx.orderId)\noutJson.ctx = outJson.ctx || {};\noutJson.ctx.orderId = outJson.ctx.orderId || outJson.orderId || outJson.joinKey || \"\";\n\n// 6) Output ONE item that includes BOTH json + binary\nreturn [{\n  json: outJson,\n  binary: binItem.binary,\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12800,
        272
      ],
      "id": "6532a614-d7bd-4cd0-b752-2480b34516d3",
      "name": "Collapse To One1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0cd8513a-472a-4a12-be0d-d6821e4d53bf",
              "name": "=joinKey",
              "value": "={{ ($json.body?.orderId || $json.orderId || $json.order_id || $json.body?.order_id || '').toString().trim() }}",
              "type": "string"
            },
            {
              "id": "d5a74961-e196-4881-8a3b-0a4da8f25e28",
              "name": "=ctx",
              "value": "={{\n  (() => {\n    const body = $json.body ?? {};\n    const root = $json ?? {};\n\n    const get = (...paths) => {\n      for (const p of paths) {\n        const v =\n          p.startsWith('body.')\n            ? body[p.slice(5)]\n            : root[p];\n\n        if (v !== undefined && v !== null && String(v).trim() !== '') return v;\n      }\n      return '';\n    };\n\n    // Addons normalization (string | array | json-string | csv | addons[0] style)\n    const rawAddons =\n      body.addons ?? root.addons ??\n      (() => {\n        const src = body && Object.keys(body).length ? body : root;\n        const collected = Object.keys(src || {})\n          .filter(k => /^addons\\[\\d+\\]$/.test(k))\n          .sort()\n          .map(k => src[k]);\n        return collected.length ? collected : '';\n      })();\n\n    const normalizeAddons = (raw) => {\n      if (!raw) return [];\n      if (Array.isArray(raw)) return raw.map(x => String(x).trim().toLowerCase()).filter(Boolean);\n\n      if (typeof raw === 'string') {\n        const t = raw.trim();\n        // stringified JSON array?\n        try {\n          const j = JSON.parse(t);\n          if (Array.isArray(j)) return j.map(x => String(x).trim().toLowerCase()).filter(Boolean);\n        } catch {}\n        // csv\n        return t ? t.split(',').map(x => x.trim().toLowerCase()).filter(Boolean) : [];\n      }\n      return [];\n    };\n\n    const addons = normalizeAddons(rawAddons);\n\n    const flags = {\n      extraCoverLetter: addons.includes('extracoverletter'),\n      oneDayDelivery: addons.includes('onedaydelivery') || addons.includes('oneday'),\n      editableWord: addons.includes('editableword') || addons.includes('word') || addons.includes('docx'),\n      linkedin: addons.includes('linkedin') || addons.includes('linkedinoptimization'),\n    };\n\n    const cvBinaryKey = Object.keys($binary || {})[0] || '';\n\n    // try to infer extension\n    const cvExt = cvBinaryKey\n      ? String($binary?.[cvBinaryKey]?.fileExtension || $binary?.[cvBinaryKey]?.fileName || '')\n          .split('.')\n          .pop()\n          .toLowerCase()\n      : '';\n\n    return {\n      orderId: String(get('body.orderId', 'body.order_id', 'orderId', 'order_id')).trim(),\n      package: String(get('body.package', 'body.packageTier', 'package', 'packageTier')).trim(),\n      email: String(get('body.email', 'email')).trim(),\n      candidateName: String(get('body.candidateName', 'body.candidate_name', 'candidateName', 'candidate_name', 'name', 'fullName')).trim(),\n      jobDescription: String(get('body.jobDescription', 'body.jdText', 'body.job_description', 'jobDescription', 'jdText', 'job_description')).trim(),\n      source: String(get('body.source', 'source')).trim(),\n      addons,\n      addonSet: addons.reduce((acc, a) => (acc[a] = true, acc), {}),\n      flags,\n      cvBinaryKey,\n      cvExt,\n    };\n  })()\n}}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3024,
        960
      ],
      "id": "a62f571a-33cc-401c-8dc0-8e333a75573e",
      "name": "Build ctx"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "4861a890-93ed-4946-92e1-8374e85f6501",
              "leftValue": "={{ ($json.ctx?.orderId || '').trim().length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "a760cb6d-6088-4b5f-a466-9f6988c8e41b",
              "leftValue": "={{ ($json.ctx?.email || '').trim().length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "348d8365-498f-4dd1-a1cf-87399b825387",
              "leftValue": "={{ ($json.ctx?.cvBinaryKey || '').trim().length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "ab4a6391-607d-4089-8772-433aea9c4b8c",
              "leftValue": "={{ ($json.ctx?.jobDescription || '').trim().length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -2800,
        960
      ],
      "id": "632c210d-42e2-4bbb-878c-186ffbcba04a",
      "name": "Validate Intake"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"error\",\n  \"message\": \"Missing required fields (orderId/email/CV file).\"\n}",
        "options": {
          "responseCode": "={{ 400 }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -2576,
        1056
      ],
      "id": "9f1cd418-5611-49dc-8ab9-9da2d7b56214",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"accepted\",\n  \"orderId\": \"={{ String($json.ctx?.orderId || $json.body?.orderId || $json.joinKey || '').replace(/^=/,'') }}\",\n  \"joinKey\": \"={{ String($json.joinKey || $json.ctx?.orderId || $json.body?.orderId || '').replace(/^=/,'') }}\",\n  \"message\": \"Processing started. You will receive results by email shortly.\"\n}",
        "options": {
          "responseCode": 202
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -2352,
        864
      ],
      "id": "8d7cfb0c-8bb9-487c-adfc-8cf097c8e190",
      "name": "Respond 202"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "365d2124-621d-4ba9-9d93-666b2072d3a5",
              "name": "=joinKey",
              "value": "={{\n(\n  $json.ctx?.orderId\n  || $json.body?.orderId\n  || $json.orderId\n  || $json.order_id\n  || $json.joinKey\n  || ''\n).toString().trim().replace(/^=/,'')\n}}",
              "type": "string"
            },
            {
              "id": "453333f8-b3fe-47f9-add4-eca7308abd45",
              "name": "=ctx",
              "value": "={{\n(() => {\n  const body =\n    ($json.body && typeof $json.body === 'object')\n      ? $json.body\n      : {};\n\n  const ctx0 =\n    ($json.ctx && typeof $json.ctx === 'object')\n      ? $json.ctx\n      : {};\n\n  const orderId =\n    String(\n      ctx0.orderId ||\n      body.orderId ||\n      $json.orderId ||\n      $json.joinKey ||\n      ''\n    ).trim().replace(/^=/, '');\n\n  const candidateName =\n    String(\n      body.candidateName ||\n      ctx0.candidateName ||\n      $json.candidateName ||\n      ''\n    ).trim();\n\n  const email =\n    String(\n      body.email ||\n      ctx0.email ||\n      $json.email ||\n      ''\n    ).trim();\n\n  const pkg =\n    String(\n      body.package ||\n      ctx0.package ||\n      $json.package ||\n      $json.packageTier ||\n      ''\n    ).trim();\n\n  const jobDescription =\n    String(\n      body.jobDescription ||\n      ctx0.jobDescription ||\n      $json.jobDescription ||\n      ''\n    );\n\n  let addonsRaw =\n    body.addons ||\n    ctx0.addons ||\n    $json.addons ||\n    [];\n\n  let addons = [];\n  if (Array.isArray(addonsRaw)) {\n    addons = addonsRaw.map(a => String(a).trim()).filter(Boolean);\n  } else if (typeof addonsRaw === 'string') {\n    addons = addonsRaw.split(',').map(s => s.trim()).filter(Boolean);\n  }\n\n  const flags =\n    (ctx0.flags && typeof ctx0.flags === 'object')\n      ? ctx0.flags\n      : (body.flags || {});\n\n  return {\n    ...ctx0,\n    orderId,\n    candidateName,\n    email,\n    package: pkg,\n    jobDescription,\n    addons,\n    flags,\n  };\n})()\n}}",
              "type": "string"
            },
            {
              "id": "e5cf5e4a-3508-431c-8496-a3eb6c29ef56",
              "name": "=candidateName",
              "value": "={{ $json.ctx?.candidateName || $json.body?.candidateName || $json.candidateName || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1232,
        864
      ],
      "id": "03dde19b-eed1-4447-b8d7-71a098c58164",
      "name": "joinKey1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a231b1eb-a02b-486e-ab77-03efdf9b53b6",
              "name": "=joinKey",
              "value": "={{ $json.ctx?.orderId || $json.orderId || $json.order_id || $json.joinKey || '' }}\n",
              "type": "string"
            },
            {
              "id": "2d2982d6-5868-4193-bbc5-48f8cec183b1",
              "name": "=cvRewriteText",
              "value": "={{ \n  $json.cvRewriteText\n  || $json.choices?.[0]?.message?.content\n  || $json.message?.content\n  || $json.data?.choices?.[0]?.message?.content\n  || $json.output_text\n  || ''\n}}",
              "type": "string"
            },
            {
              "id": "0cc4e300-ae4e-45d4-b405-fd2bdf9d9f14",
              "name": "=ctx",
              "value": "={{ $json.ctx || {\n  orderId: $json.orderId || $json.order_id || '',\n  email: $json.email || '',\n  candidateName: $json.candidateName || '',\n  package: $json.package || $json.packageTier || '',\n  addons: $json.addons || [],\n  jobDescription: $json.jobDescription || '',\n  cvText: $json.cvText || '',\n  rewrittenCVText: $json.rewrittenCVText || ''\n} }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        10256,
        432
      ],
      "id": "399f2d1e-c2cf-438c-b5cd-b4d3ab7362b0",
      "name": "Capture Rewrite1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a231b1eb-a02b-486e-ab77-03efdf9b53b6",
              "name": "=joinKey",
              "value": "={{ $json.ctx?.orderId || $json.orderId || $json.order_id || $json.joinKey || '' }}\n",
              "type": "string"
            },
            {
              "id": "2d2982d6-5868-4193-bbc5-48f8cec183b1",
              "name": "=cvRewriteText",
              "value": "={{ \n  $json.cvRewriteText\n  || $json.choices?.[0]?.message?.content\n  || $json.message?.content\n  || $json.data?.choices?.[0]?.message?.content\n  || $json.output_text\n  || ''\n}}",
              "type": "string"
            },
            {
              "id": "0cc4e300-ae4e-45d4-b405-fd2bdf9d9f14",
              "name": "=ctx",
              "value": "={{ $json.ctx || {\n  orderId: $json.orderId || $json.order_id || '',\n  email: $json.email || '',\n  candidateName: $json.candidateName || '',\n  package: $json.package || $json.packageTier || '',\n  addons: $json.addons || [],\n  jobDescription: $json.jobDescription || '',\n  cvText: $json.cvText || '',\n  rewrittenCVText: $json.rewrittenCVText || ''\n} }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        10256,
        624
      ],
      "id": "08eef137-bd4c-412d-8a19-4ebf645bf2a2",
      "name": "Capture Rewrite2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a231b1eb-a02b-486e-ab77-03efdf9b53b6",
              "name": "=joinKey",
              "value": "={{ $json.ctx?.orderId || $json.orderId || $json.order_id || $json.joinKey || '' }}\n",
              "type": "string"
            },
            {
              "id": "2d2982d6-5868-4193-bbc5-48f8cec183b1",
              "name": "=cvRewriteText",
              "value": "={{ \n  $json.cvRewriteText\n  || $json.choices?.[0]?.message?.content\n  || $json.message?.content\n  || $json.data?.choices?.[0]?.message?.content\n  || $json.output_text\n  || ''\n}}",
              "type": "string"
            },
            {
              "id": "0cc4e300-ae4e-45d4-b405-fd2bdf9d9f14",
              "name": "=ctx",
              "value": "={{ $json.ctx || {\n  orderId: $json.orderId || $json.order_id || '',\n  email: $json.email || '',\n  candidateName: $json.candidateName || '',\n  package: $json.package || $json.packageTier || '',\n  addons: $json.addons || [],\n  jobDescription: $json.jobDescription || '',\n  cvText: $json.cvText || '',\n  rewrittenCVText: $json.rewrittenCVText || ''\n} }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        10256,
        816
      ],
      "id": "effce366-e022-4244-bd2f-b8f5dc63d467",
      "name": "Capture Rewrite3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "eb1dc396-33fe-4a4b-b41e-71a3252da346",
              "name": "rewrittenCVText",
              "value": "=={{   $json.cvRewriteText   || $json.cvRewriteText_1  || $json.cvRewriteText_2  || $json.cvRewriteText_3  || ''}}",
              "type": "string"
            },
            {
              "id": "96cae4bc-66f3-4c6d-89c9-735def4883c0",
              "name": "",
              "value": "",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        10480,
        336
      ],
      "id": "0464318a-060e-4ba9-9d79-fc013775a282",
      "name": "cvRewriteText (final)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b91e1f9b-18e3-473f-b2dc-ff7147481fab",
              "name": "=status",
              "value": "accepted",
              "type": "string"
            },
            {
              "id": "a1b3ffb1-5503-4019-8be2-9aa4e944b54c",
              "name": "orderId",
              "value": "={{ $json.ctx?.orderId || $json.body?.orderId || $json.orderId || '' }}",
              "type": "string"
            },
            {
              "id": "ca0aaad9-a005-41d1-a3fa-0b0e8eb093ce",
              "name": "=message",
              "value": "Processing started. You will receive results by email shortly.",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2576,
        864
      ],
      "id": "9352b6bb-d60a-4102-adca-e425bfb43062",
      "name": "Ack Payload"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "joinKey",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        11600,
        272
      ],
      "id": "df2fc858-08db-48c5-b5af-e7130d232b45",
      "name": "Merge1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb8d4b82-885b-495b-a0b3-a1469a02a56d",
              "name": "=joinKey",
              "value": "={{ $items(\"Stash Context\", 0)[0]?.json?.joinKey || $json.joinKey || '' }}",
              "type": "string"
            },
            {
              "id": "c8ae8393-d045-4a31-b914-535dbde0aec5",
              "name": "=ctx",
              "value": "={{\n  (() => {\n    const ctx0 = $items(\"Stash Context\", 0)[0]?.json?.ctx || {};\n    return {\n      ...ctx0,\n      documentId: $json.id,     // âœ… the created doc id\n    };\n  })()\n}}",
              "type": "object"
            },
            {
              "id": "e6da2631-c224-4112-a8ba-12d6aa44595f",
              "name": "=documentId",
              "value": "={{ $json.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        11376,
        560
      ],
      "id": "9a3204c9-579f-41e1-b0cf-cb1d2f9f9ad5",
      "name": "Google Docs joinKey"
    },
    {
      "parameters": {
        "driveId": "=Ai-Vitae CVs",
        "folderId": "=1vpKP_zlqScqx8Ms9fWhGWqCs0f7jxS4H",
        "title": "={{\n  `Cover Letter - ${$json.ctx?.candidateName || $json.candidateName || 'Candidate'} - ${$json.joinKey || $json.ctx?.orderId || $json.orderId || ''}`\n}}\n"
      },
      "type": "n8n-nodes-base.googleDocs",
      "typeVersion": 2,
      "position": [
        15680,
        80
      ],
      "id": "a5bb2f7e-4758-49db-aa97-7b70ba6138da",
      "name": "Create Cover Letter Doc",
      "credentials": {
        "googleDocsOAuth2Api": {
          "id": "4vk8gMiMgE4tUsQY",
          "name": "Google Docs account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentURL": "={{ $json.documentId || $json.id }}",
        "actionsUi": {
          "actionFields": [
            {
              "action": "insert",
              "text": "={{\n  (\n    $items(\"Capture Cover Letter\", 0)[0]?.json?.coverLetterText\n    || $items(\"Message a model\", 0)[0]?.json?.coverLetterText\n    || $items(\"Message a model\", 0)[0]?.json?.choices?.[0]?.message?.content\n    || $items(\"Message a model\", 0)[0]?.json?.message?.content\n    || ''\n  ).toString().trim()\n}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.googleDocs",
      "typeVersion": 2,
      "position": [
        15904,
        80
      ],
      "id": "1455d18c-0122-4106-84f7-e65d4d0b15a7",
      "name": "Write Cover Letter Content",
      "credentials": {
        "googleDocsOAuth2Api": {
          "id": "4vk8gMiMgE4tUsQY",
          "name": "Google Docs account"
        }
      }
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{$json.documentId || $json.id}}",
          "mode": "id"
        },
        "options": {
          "googleFileConversion": {
            "conversion": {
              "docsToFormat": "application/pdf"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        16128,
        80
      ],
      "id": "6e832db7-3f38-4ff0-ada2-c366200b2db4",
      "name": "Download Cover Letter PDF",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "ioNgSTT7FJkSUINC",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "36d28f0d-7b41-4ee4-8203-40bfe1f828bb",
              "name": "=coverLetter",
              "value": "={{ $binary.data }}",
              "type": "string"
            },
            {
              "id": "b872c70c-9520-4a7d-a86f-12645436bc76",
              "name": "=data",
              "value": "==",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        16352,
        80
      ],
      "id": "aa902e73-0357-40b7-8f46-aabd50aa9360",
      "name": "Binary Cover Letter"
    },
    {
      "parameters": {
        "jsCode": "// Rename Google Drive's default binary field \"data\" -> \"coverLetter\"\nconst item = items[0];\n\nif (!item.binary?.data) {\n  throw new Error('Expected binary field \"data\" from Download node, but none found.');\n}\n\nitem.binary.coverLetter = item.binary.data;\ndelete item.binary.data;\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16576,
        80
      ],
      "id": "bd95c5cd-a4eb-45da-bf42-2b1ed9826d73",
      "name": "Move Binary Data"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "05a91e2e-f4bf-4551-bea9-09bc5d9934e4",
              "name": "=pgCoverInserted",
              "value": "=true",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        17264,
        208
      ],
      "id": "b0a425f1-7b97-427a-a59a-c43a0df6c51a",
      "name": "Set joinKey"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "joinKey",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        17072,
        208
      ],
      "id": "331bd1e1-42de-4326-8356-15575f4ebb40",
      "name": "Merge by Key"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6af4c17e-ff05-41a7-99b6-cf9a27216bff",
              "name": "=addons",
              "value": "={{\n  (() => {\n    const raw = $json.ctx?.addons ?? $json.addons ?? [];\n    if (Array.isArray(raw)) return raw.map(a => String(a).trim().toLowerCase()).filter(Boolean);\n    if (typeof raw === 'string') {\n      const t = raw.trim();\n      // allow JSON array string\n      try { const j = JSON.parse(t); if (Array.isArray(j)) return j.map(x => String(x).trim().toLowerCase()).filter(Boolean); } catch {}\n      // allow csv\n      return t ? t.split(',').map(x => x.trim().toLowerCase()).filter(Boolean) : [];\n    }\n    return [];\n  })()\n}}",
              "type": "array"
            },
            {
              "id": "3f180a36-1623-4072-b816-6e2545530b40",
              "name": "=hasExtraCoverLetter",
              "value": "={{\n  (() => {\n    const raw = $json.ctx?.addons ?? $json.addons ?? [];\n    const arr = Array.isArray(raw)\n      ? raw\n      : typeof raw === 'string'\n        ? raw.split(',')   // ok as fallback\n        : [];\n    return arr.map(a => String(a).trim().toLowerCase()).includes('extracoverletter');\n  })()\n}}",
              "type": "boolean"
            },
            {
              "id": "3530a70a-2544-4b12-a655-cb788d25ce2e",
              "name": "=jobDescription",
              "value": "={{ $json.ctx?.jobDescription ?? $json.jobDescription ?? '' }}",
              "type": "string"
            },
            {
              "id": "9300b829-90db-4659-a65c-4755033634dc",
              "name": "=rewrittenCVText",
              "value": "={{ $json.ctx?.rewrittenCVText ?? $json.ctx?.cvRewriteText ?? $json.rewrittenCVText ?? $json.cvRewriteText ?? '' }}",
              "type": "string"
            },
            {
              "id": "4533467c-ce0d-4bba-a9e1-1c10f26092f2",
              "name": "=cvText",
              "value": "={{ $json.ctx?.cvText ?? $json.cvText ?? '' }}",
              "type": "string"
            },
            {
              "id": "ea1e0a91-3ac7-44c8-80fb-377d3df5d1d0",
              "name": "=candidateName",
              "value": "={{ $json.ctx?.candidateName ?? $json.candidateName ?? '' }}",
              "type": "string"
            },
            {
              "id": "50afd495-4f16-4b1e-a21a-426dc1b5257c",
              "name": "=email",
              "value": "={{ $json.ctx?.email ?? $json.email ?? '' }}",
              "type": "string"
            },
            {
              "id": "b9669d53-fab3-48ee-866e-2d0815dc1c0c",
              "name": "=orderId",
              "value": "={{ $json.ctx?.orderId ?? $json.orderId ?? $json.docRow?.orderId ?? '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        19152,
        80
      ],
      "id": "35feb71d-d8a1-4c30-bfdf-eb3ebe40d253",
      "name": "Normalize Payload2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6af4c17e-ff05-41a7-99b6-cf9a27216bff",
              "name": "=addons",
              "value": "={{\n  (() => {\n    const raw = $json.ctx?.addons ?? $json.addons ?? [];\n    if (Array.isArray(raw)) return raw.map(a => String(a).trim().toLowerCase()).filter(Boolean);\n    if (typeof raw === 'string') {\n      const t = raw.trim();\n      // allow JSON array string\n      try { const j = JSON.parse(t); if (Array.isArray(j)) return j.map(x => String(x).trim().toLowerCase()).filter(Boolean); } catch {}\n      // allow csv\n      return t ? t.split(',').map(x => x.trim().toLowerCase()).filter(Boolean) : [];\n    }\n    return [];\n  })()\n}}",
              "type": "array"
            },
            {
              "id": "3f180a36-1623-4072-b816-6e2545530b40",
              "name": "=hasExtraCoverLetter",
              "value": "={{\n  (() => {\n    const raw = $json.ctx?.addons ?? $json.addons ?? [];\n    const arr = Array.isArray(raw)\n      ? raw\n      : typeof raw === 'string'\n        ? raw.split(',')   // ok as fallback\n        : [];\n    return arr.map(a => String(a).trim().toLowerCase()).includes('extracoverletter');\n  })()\n}}",
              "type": "boolean"
            },
            {
              "id": "3530a70a-2544-4b12-a655-cb788d25ce2e",
              "name": "=jobDescription",
              "value": "={{ $json.ctx?.jobDescription ?? $json.jobDescription ?? '' }}",
              "type": "string"
            },
            {
              "id": "9300b829-90db-4659-a65c-4755033634dc",
              "name": "=rewrittenCVText",
              "value": "={{ $json.ctx?.rewrittenCVText ?? $json.ctx?.cvRewriteText ?? $json.rewrittenCVText ?? $json.cvRewriteText ?? '' }}",
              "type": "string"
            },
            {
              "id": "4533467c-ce0d-4bba-a9e1-1c10f26092f2",
              "name": "=cvText",
              "value": "={{ $json.ctx?.cvText ?? $json.cvText ?? '' }}",
              "type": "string"
            },
            {
              "id": "ea1e0a91-3ac7-44c8-80fb-377d3df5d1d0",
              "name": "=candidateName",
              "value": "={{ $json.ctx?.candidateName ?? $json.candidateName ?? '' }}",
              "type": "string"
            },
            {
              "id": "50afd495-4f16-4b1e-a21a-426dc1b5257c",
              "name": "=email",
              "value": "={{ $json.ctx?.email ?? $json.email ?? '' }}",
              "type": "string"
            },
            {
              "id": "b9669d53-fab3-48ee-866e-2d0815dc1c0c",
              "name": "=orderId",
              "value": "={{ $json.ctx?.orderId ?? $json.orderId ?? $json.docRow?.orderId ?? '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        20736,
        112
      ],
      "id": "30000f0b-7945-45c9-b51a-88377920a0d2",
      "name": "Normalize Payload3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6af4c17e-ff05-41a7-99b6-cf9a27216bff",
              "name": "=addons",
              "value": "={{\n  (() => {\n    const raw = $json.ctx?.addons ?? $json.addons ?? [];\n    if (Array.isArray(raw)) return raw.map(a => String(a).trim().toLowerCase()).filter(Boolean);\n    if (typeof raw === 'string') {\n      const t = raw.trim();\n      // allow JSON array string\n      try { const j = JSON.parse(t); if (Array.isArray(j)) return j.map(x => String(x).trim().toLowerCase()).filter(Boolean); } catch {}\n      // allow csv\n      return t ? t.split(',').map(x => x.trim().toLowerCase()).filter(Boolean) : [];\n    }\n    return [];\n  })()\n}}",
              "type": "array"
            },
            {
              "id": "3f180a36-1623-4072-b816-6e2545530b40",
              "name": "=hasExtraCoverLetter",
              "value": "={{\n  (() => {\n    const raw = $json.ctx?.addons ?? $json.addons ?? [];\n    const arr = Array.isArray(raw)\n      ? raw\n      : typeof raw === 'string'\n        ? raw.split(',')   // ok as fallback\n        : [];\n    return arr.map(a => String(a).trim().toLowerCase()).includes('extracoverletter');\n  })()\n}}",
              "type": "boolean"
            },
            {
              "id": "3530a70a-2544-4b12-a655-cb788d25ce2e",
              "name": "=jobDescription",
              "value": "={{ $json.ctx?.jobDescription ?? $json.jobDescription ?? '' }}",
              "type": "string"
            },
            {
              "id": "9300b829-90db-4659-a65c-4755033634dc",
              "name": "=rewrittenCVText",
              "value": "={{ $json.ctx?.rewrittenCVText ?? $json.ctx?.cvRewriteText ?? $json.rewrittenCVText ?? $json.cvRewriteText ?? '' }}",
              "type": "string"
            },
            {
              "id": "4533467c-ce0d-4bba-a9e1-1c10f26092f2",
              "name": "=cvText",
              "value": "={{ $json.ctx?.cvText ?? $json.cvText ?? '' }}",
              "type": "string"
            },
            {
              "id": "ea1e0a91-3ac7-44c8-80fb-377d3df5d1d0",
              "name": "=candidateName",
              "value": "={{ $json.ctx?.candidateName ?? $json.candidateName ?? '' }}",
              "type": "string"
            },
            {
              "id": "50afd495-4f16-4b1e-a21a-426dc1b5257c",
              "name": "=email",
              "value": "={{ $json.ctx?.email ?? $json.email ?? '' }}",
              "type": "string"
            },
            {
              "id": "b9669d53-fab3-48ee-866e-2d0815dc1c0c",
              "name": "=orderId",
              "value": "={{ $json.ctx?.orderId ?? $json.orderId ?? $json.docRow?.orderId ?? '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        21632,
        128
      ],
      "id": "d6caa489-acfa-4c12-af87-547758e7e96f",
      "name": "Normalize Payload4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "05a91e2e-f4bf-4551-bea9-09bc5d9934e4",
              "name": "=joinKey",
              "value": "={{\n  $json.joinKey\n  || $json.orderId\n  || $json.ctx?.orderId\n  || $items(\"Reattach Context1\", 0)[0]?.json?.joinKey\n  || $items(\"Reattach Context1\", 0)[0]?.json?.ctx?.orderId\n  || ''\n}}",
              "type": "string"
            },
            {
              "id": "3045ee38-e2c8-4e39-b55f-6a49f8958f60",
              "name": "=orderId",
              "value": "={{\n  $json.orderId\n  || $json.ctx?.orderId\n  || $items(\"Reattach Context1\", 0)[0]?.json?.ctx?.orderId\n  || $items(\"Reattach Context1\", 0)[0]?.json?.joinKey\n  || ''\n}}",
              "type": "string"
            },
            {
              "id": "695e5c64-ce58-465d-a3b9-4dbf32b76c88",
              "name": "=ctx",
              "value": "={{ $json.ctx || {} }}",
              "type": "object"
            },
            {
              "id": "a67e2074-a029-4eb5-a6da-2edbbd9c6603",
              "name": "=coverLetterKey",
              "value": "={{ $json.coverLetterKey || $json.Key || '' }}",
              "type": "string"
            },
            {
              "id": "f5d91ef0-2e6f-4a80-a170-435ed4bc7266",
              "name": "=coverLetterUrl",
              "value": "={{ $json.coverLetterUrl || $json.Location || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        16944,
        80
      ],
      "id": "bc25a26b-7a49-4467-90dd-4063ff162dba",
      "name": "Reattach Context2"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        13024,
        400
      ],
      "id": "3f5b3092-5f8c-4dad-9692-ede5bb24a7f1",
      "name": "Merge2"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        17536,
        400
      ],
      "id": "ebc5a2b2-6f56-433a-b0e3-2540d6357c77",
      "name": "Merge3"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "id"
        },
        "messages": {
          "values": [
            {
              "content": "={{$json.promptTemplate || $node[\"Model & Prompt Params (Package - Model)\"].json.promptTemplate || 'You are an expert CV writer. Rewrite the candidate\\'s CV strictly using only provided information. Preserve factual accuracy. Return only the rewritten CV as plain text.'}}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        9000,
        240
      ],
      "id": "ai-orchestrator-0001",
      "name": "AI Orchestrator",
      "alwaysOutputData": false,
      "credentials": {
        "openAiApi": {
          "id": "yJxo3UoYqsd6bATu",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "orchestrator-capture-1",
              "name": "=ctx",
              "value": "={{ ( $json.ctx || {} ), Object.assign(($json.ctx || {}), { rewrittenCVText: ( $node['AI Orchestrator']?.json?.choices?.[0]?.message?.content || $node['AI Orchestrator']?.json?.content || '' ) }) }}",
              "type": "object"
            },
            {
              "id": "orchestrator-capture-2",
              "name": "=cvRewriteText",
              "value": "={{ $node['AI Orchestrator']?.json?.choices?.[0]?.message?.content || $node['AI Orchestrator']?.json?.content || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        9240,
        240
      ],
      "id": "orchestrator-capture-0001",
      "name": "Orchestrator Capture"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [
        -3248,
        1200
      ],
      "id": "error-handler-trigger",
      "name": "Error Handler"
    },
    {
      "parameters": {
        "sendTo": "={{ $env.ADMIN_EMAIL || 'admin@example.com' }}",
        "subject": "Ai-Vitae Workflow Error - Order {{ $json.execution?.customData?.orderId || 'Unknown' }}",
        "message": "Error in Ai-Vitae Workflow\n\nNode: {{ $json.execution?.lastNodeExecuted || 'Unknown' }}\nError: {{ $json.execution?.error?.message || 'Unknown error' }}\nExecution ID: {{ $json.execution?.id || 'N/A' }}\nTimestamp: {{ new Date().toISOString() }}\n\nPlease investigate immediately.",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -3008,
        1200
      ],
      "id": "error-notification-email",
      "name": "Error Notification Email",
      "credentials": {
        "gmailOAuth2": {
          "id": "XifC0N82x0L992s5",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Rate Limiting Node\n// Place after Webhook Intake\n\nconst ip = $json.headers?.['x-forwarded-for'] || $json.headers?.['x-real-ip'] || 'unknown';\nconst email = String($json.body?.email || '').toLowerCase();\n\n// Use n8n static data for rate tracking\nconst staticData = $getWorkflowStaticData('global');\nconst now = Date.now();\nconst windowMs = 60000; // 1 minute window\nconst maxRequests = 10; // max 10 requests per minute per IP\n\n// Initialize or clean old entries\nif (!staticData.rateLimits) staticData.rateLimits = {};\nconst limits = staticData.rateLimits;\n\n// Clean entries older than window\nObject.keys(limits).forEach(key => {\n  limits[key] = limits[key].filter(ts => now - ts < windowMs);\n  if (limits[key].length === 0) delete limits[key];\n});\n\n// Check rate limit\nconst ipRequests = limits[ip] || [];\nif (ipRequests.length >= maxRequests) {\n  throw new Error(`Rate limit exceeded for IP ${ip}. Max ${maxRequests} requests per minute.`);\n}\n\n// Record this request\nlimits[ip] = [...ipRequests, now];\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3008,
        960
      ],
      "id": "rate-limiter-node",
      "name": "Rate Limiter"
    },
    {
      "parameters": {
        "jsCode": "// Idempotency Check\n// Prevents duplicate order processing\n\nconst orderId = $json.orderId || $json.body?.orderId || '';\nif (!orderId) {\n  // No orderId yet, pass through\n  return $input.all();\n}\n\nconst staticData = $getWorkflowStaticData('global');\n\nif (!staticData.processedOrders) staticData.processedOrders = {};\n\n// Check if already processed (within last 24 hours)\nconst now = Date.now();\nconst processed = staticData.processedOrders[orderId];\nif (processed && (now - processed.timestamp) < 86400000) {\n  // Already processed within 24 hours - skip processing\n  return [{\n    json: {\n      ...$json,\n      isDuplicate: true,\n      originalProcessedAt: new Date(processed.timestamp).toISOString(),\n      message: 'Order already processed'\n    }\n  }];\n}\n\n// Mark as processing\nstaticData.processedOrders[orderId] = { timestamp: now, status: 'processing' };\n\n// Clean old entries (older than 24 hours)\nObject.keys(staticData.processedOrders).forEach(key => {\n  if (now - staticData.processedOrders[key].timestamp > 86400000) {\n    delete staticData.processedOrders[key];\n  }\n});\n\nreturn [{\n  json: {\n    ...$json,\n    isDuplicate: false\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2768,
        960
      ],
      "id": "idempotency-check-node",
      "name": "Idempotency Check"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { status: 'error', code: 'INVALID_PACKAGE', message: 'Invalid package tier: ' + ($json.packageTier || $json.package || 'unknown') + '. Valid options: starter, standard, premium, executive.' } }}",
        "options": {
          "responseCode": 400
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        8912,
        1200
      ],
      "id": "unknown-package-error",
      "name": "Error - Unknown Package Tier"
    }
  ],
  "pinData": {},
  "connections": {
    "Rewrite CV": {
      "main": [
        [
          {
            "node": "Capture Rewrite",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalise & Validate": {
      "main": [
        [
          {
            "node": "Add Ons",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "CV < 5MB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Message - No CV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDF - Text": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "File Type": {
      "main": [
        [
          {
            "node": "PDF - Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "DOCX - Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "DOC - Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "TXT Field",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Merge10",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "Merge10",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Error Message": {
      "main": [
        []
      ]
    },
    "Error Message - No CV": {
      "main": [
        []
      ]
    },
    "CV < 5MB": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "CV too Large",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CV too Large": {
      "main": [
        []
      ]
    },
    "Scan Upload": {
      "main": [
        [
          {
            "node": "Restore Binary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Clean": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "CV Infected",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF JD Provided": {
      "main": [
        [
          {
            "node": "Code - Ensure orderID",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "JD Required",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JD Required": {
      "main": [
        []
      ]
    },
    "Rewrite CV1": {
      "main": [
        [
          {
            "node": "Cover Letter Rewrite",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Standard - Proofread CV": {
      "main": [
        [
          {
            "node": "Executive - Format CV Layout",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Starter - Proofread CV": {
      "main": [
        [
          {
            "node": "Capture Rewrite2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extra Cover Letter": {
      "main": [
        [
          {
            "node": "Cover Letter - Generate",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "LinkedIn Optimization1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Editable Word": {
      "main": [
        [
          {
            "node": "Build HTML",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "One Day Delivery",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "One Day Delivery": {
      "main": [
        [
          {
            "node": "SLA MetaData",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validate - Has Schema and OrderId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cover Letter - Generate": {
      "main": [
        [
          {
            "node": "Capture Cover Letter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sanitize JD": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set - Config": {
      "main": [
        [
          {
            "node": "If UUID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Ensure orderID": {
      "main": [
        [
          {
            "node": "Update Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Have binary CV": {
      "main": [
        [
          {
            "node": "Upload Original CV",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge: Ready to Upload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "cvText - Binary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload Original CV": {
      "main": [
        [
          {
            "node": "Remember cv_orig_key",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Remember cv_orig_key": {
      "main": [
        [
          {
            "node": "Add Doc(cv_original)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Doc(cv_original)": {
      "main": [
        [
          {
            "node": "Ack AddDoc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cvText - Binary": {
      "main": [
        [
          {
            "node": "Merge: Ready to Upload",
            "type": "main",
            "index": 0
          },
          {
            "node": "Upload Original CV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload LinkedIn": {
      "main": [
        [
          {
            "node": "Postgres - Add Doc(linkedin)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres - Add Doc(linkedin)": {
      "main": [
        [
          {
            "node": "Normalize Payload2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet": {
      "main": [
        [
          {
            "node": "Execute a SQL query1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Premium - CV Rewrite (Claude Sonnet)": {
      "main": [
        [
          {
            "node": "Cover Letter Rewrite1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Executive - CV Rewrite (Claude Opus)": {
      "main": [
        [
          {
            "node": "Cover Letter Rewrite2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Executive - Format CV Layout": {
      "main": [
        [
          {
            "node": "Capture Rewrite3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Scan Upload",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "cvExt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cvExt": {
      "main": [
        [
          {
            "node": "fileType",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fileType": {
      "main": [
        [
          {
            "node": "File Type",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge10": {
      "main": [
        [
          {
            "node": "IF JD Provided",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge11": {
      "main": [
        [
          {
            "node": "Have binary CV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge: Ready to Upload": {
      "main": [
        [
          {
            "node": "Build Keys",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ack AddDoc": {
      "main": [
        [
          {
            "node": "Merge: Ready to Upload",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Add Ons": {
      "main": [
        [
          {
            "node": "Sanitize JD",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Order Flags": {
      "main": [
        [
          {
            "node": "Merge11",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Restore Binary": {
      "main": [
        [
          {
            "node": "IF Clean",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LinkedIn Optimization1": {
      "main": [
        [
          {
            "node": "LI Build Sections1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Editable Word",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LI Build Sections1": {
      "main": [
        [
          {
            "node": "Capture LinkedIn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate & Clean2": {
      "main": [
        [
          {
            "node": "Upload LinkedIn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Keys": {
      "main": [
        [
          {
            "node": "Extract CV Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture Rewrite": {
      "main": [
        [
          {
            "node": "cvRewriteText (final)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Flags": {
      "main": [
        [
          {
            "node": "Entitlements",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Entitlements": {
      "main": [
        [
          {
            "node": "Model & Prompt Params (Package - Model)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Model & Prompt Params (Package - Model)": {
      "main": [
        [
          {
            "node": "Guard Node1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture Cover Letter": {
      "main": [
        [
          {
            "node": "Create Cover Letter Doc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload CoverLetter1": {
      "main": [
        [
          {
            "node": "Reattach Context2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres - Add Doc(cover)1": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Rewrite CV",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Rewrite CV1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Premium - CV Rewrite (Claude Sonnet)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Executive - CV Rewrite (Claude Opus)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Report a failed Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture LinkedIn": {
      "main": [
        [
          {
            "node": "Validate & Clean2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build HTML": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2": {
      "main": [
        [
          {
            "node": "Upload DOCX",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload DOCX": {
      "main": [
        [
          {
            "node": "Postgres - Add Doc1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres - Add Doc1": {
      "main": [
        [
          {
            "node": "Normalize Payload3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SLA MetaData": {
      "main": [
        [
          {
            "node": "Postgres - Update Order Priority",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres - Update Order Priority": {
      "main": [
        [
          {
            "node": "Normalize Payload4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "List Documents for Order": {
      "main": [
        [
          {
            "node": "Shape Documents Map",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Shape Documents Map": {
      "main": [
        [
          {
            "node": "Validate - Has OrderId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark Order Done": {
      "main": [
        [
          {
            "node": "Reattach Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize String": {
      "main": [
        [
          {
            "node": "Normalize - Addon Flags to Boolean",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize - Addon Flags to Boolean": {
      "main": [
        [
          {
            "node": "Flags",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate - Has Schema and OrderId": {
      "main": [
        [
          {
            "node": "List Documents for Order",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Shape Documents Map",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate - Has OrderId": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Mark Order Done",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If UUID": {
      "main": [
        [
          {
            "node": "Build Keys1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Upsert Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture orderId": {
      "main": [
        [
          {
            "node": "Build Keys1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Keys1": {
      "main": [
        [
          {
            "node": "Normalise & Validate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Order": {
      "main": [
        [
          {
            "node": "Capture orderId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Order": {
      "main": [
        [
          {
            "node": "Upsert Order Flags",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cover Letter Rewrite": {
      "main": [
        [
          {
            "node": "Capture Rewrite1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cover Letter Rewrite1": {
      "main": [
        [
          {
            "node": "Starter - Proofread CV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cover Letter Rewrite2": {
      "main": [
        [
          {
            "node": "Standard - Proofread CV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guard Node1": {
      "main": [
        [
          {
            "node": "AI Orchestrator",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Context (carry)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Orchestrator": {
      "main": [
        [
          {
            "node": "Orchestrator Capture",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Orchestrator Capture": {
      "main": [
        [
          {
            "node": "Capture Rewrite",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Email Payload": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Trigger Email Workflow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reattach Context": {
      "main": [
        [
          {
            "node": "Compute Token Cost",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Context (carry)": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query1": {
      "main": [
        [
          {
            "node": "Assemble Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Intake": {
      "main": [
        [
          {
            "node": "Build ctx",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Row for Sheets": {
      "main": [
        [
          {
            "node": "Append or update row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Assemble Response": {
      "main": [
        [
          {
            "node": "Build Email Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compute Token Cost": {
      "main": [
        [
          {
            "node": "Prepare Row for Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract CV Text": {
      "main": [
        [
          {
            "node": "Normalize String",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "File Type Routing": {
      "main": [
        [
          {
            "node": "CloudConvert",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract from File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CloudConvert": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "joinKey1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File1": {
      "main": [
        [
          {
            "node": "joinKey1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Email Workflow": {
      "main": [
        []
      ]
    },
    "cvRewriteText": {
      "main": [
        [
          {
            "node": "Stash Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Execute a SQL query2": {
      "main": [
        [
          {
            "node": "Merge SQL + Payload",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Prepare Document Row": {
      "main": [
        [
          {
            "node": "Execute a SQL query2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge SQL + Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download file": {
      "main": [
        [
          {
            "node": "Add joinKey to DocResult",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Docs": {
      "main": [
        [
          {
            "node": "Google Docs joinKey",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Docs - Write Content": {
      "main": [
        [
          {
            "node": "Download file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DOCX - Text": {
      "main": [
        [
          {
            "node": "Edit Fields3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DOC - Text": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TXT Field": {
      "main": [
        [
          {
            "node": "Merge10",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Edit Fields3": {
      "main": [
        [
          {
            "node": "Merge10",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Stash Metadata": {
      "main": [
        [
          {
            "node": "File Type Routing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Input": {
      "main": [
        [
          {
            "node": "Set - Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge SQL + Payload": {
      "main": [
        [
          {
            "node": "Reattach Context1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reattach Context1": {
      "main": [
        [
          {
            "node": "Normalize Payload",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge by Key",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Payload": {
      "main": [
        [
          {
            "node": "Extra Cover Letter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Upload Result + Context": {
      "main": [
        [
          {
            "node": "Collapse To One",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Collapse To One": {
      "main": [
        [
          {
            "node": "Prepare Document Row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields4": {
      "main": [
        [
          {
            "node": "Merge Upload Result + Context",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Edit Fields5": {
      "main": [
        [
          {
            "node": "Merge Upload Result + Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add joinKey to DocResult": {
      "main": [
        [
          {
            "node": "Merge Back",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Stash Context": {
      "main": [
        [
          {
            "node": "Google Docs",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Back",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Back": {
      "main": [
        [
          {
            "node": "Collapse To One1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Collapse To One1": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          },
          {
            "node": "Edit Fields5",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build ctx": {
      "main": [
        [
          {
            "node": "Validate Intake",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Intake": {
      "main": [
        [
          {
            "node": "Ack Payload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond to Webhook": {
      "main": [
        []
      ]
    },
    "Respond 202": {
      "main": [
        [
          {
            "node": "Stash Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "joinKey1": {
      "main": [
        [
          {
            "node": "Normalize Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture Rewrite1": {
      "main": [
        [
          {
            "node": "cvRewriteText (final)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture Rewrite2": {
      "main": [
        [
          {
            "node": "cvRewriteText (final)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture Rewrite3": {
      "main": [
        [
          {
            "node": "cvRewriteText (final)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cvRewriteText (final)": {
      "main": [
        [
          {
            "node": "cvRewriteText",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ack Payload": {
      "main": [
        [
          {
            "node": "Respond 202",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Google Docs - Write Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Docs joinKey": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Create Cover Letter Doc": {
      "main": [
        [
          {
            "node": "Write Cover Letter Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write Cover Letter Content": {
      "main": [
        [
          {
            "node": "Download Cover Letter PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Cover Letter PDF": {
      "main": [
        [
          {
            "node": "Binary Cover Letter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Binary Cover Letter": {
      "main": [
        [
          {
            "node": "Move Binary Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Move Binary Data": {
      "main": [
        [
          {
            "node": "Upload CoverLetter1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set joinKey": {
      "main": [
        [
          {
            "node": "Postgres - Add Doc(cover)1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge3",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge by Key": {
      "main": [
        [
          {
            "node": "Set joinKey",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Payload2": {
      "main": [
        [
          {
            "node": "Editable Word",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Payload3": {
      "main": [
        [
          {
            "node": "One Day Delivery",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Payload4": {
      "main": [
        [
          {
            "node": "Validate - Has Schema and OrderId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reattach Context2": {
      "main": [
        [
          {
            "node": "Merge by Key",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Edit Fields4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge3": {
      "main": [
        [
          {
            "node": "LinkedIn Optimization1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Handler": {
      "main": [
        [
          {
            "node": "Error Notification Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rate Limiter": {
      "main": [
        [
          {
            "node": "Idempotency Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timeSavedMode": "fixed",
    "saveDataSuccessExecution": "none",
    "saveExecutionProgress": false,
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": true
  },
  "versionId": "0ffc3a73-2788-42ce-9604-71632453b456",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "a0bd724e63ffbe7e9aebb17c63f2c95b7433c836c31b856f6262bbd8df4cb9a6"
  },
  "id": "5kApShRu0WnR4nX9",
  "tags": []
}
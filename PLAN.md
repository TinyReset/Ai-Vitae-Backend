# Ai-Vitae Project Plan

## ⚠️ CRITICAL: Workflow Source of Truth

**NEVER use local JSON workflow files - they are OUTDATED.**
- The **ONLY** valid workflow is the live n8n workflow via MCP connection
- **ALL** workflow reads: `n8n_get_workflow(id="40hfyY9Px6peWs3wWFkEY", mode="structure")`
- **ALL** workflow changes: `n8n_update_partial_workflow(id="40hfyY9Px6peWs3wWFkEY", operations=[...])`
- Local `.json` files are snapshots for reference only - DO NOT modify or rely on them

---

## Project Overview

**Ai-Vitae** is a CV/resume rewriting service built on n8n with tiered AI processing.

**Repository:** https://github.com/TinyReset/Ai-Vitae-Backend

### Current Status (as of 2026-02-01)
- **Main Workflow:** Ai-Vitae Workflow - Multiple nodes optimized for fast response
- **Workflow ID:** `40hfyY9Px6peWs3wWFkEY`
- **Nodes:** 145
- **Batch 1-16:** Complete — ALL 4 tiers PASSED, Email Delivery FIXED
- **Starter pipeline:** PASSED (execution #2842 — 91 nodes, 148s, CV only)
- **Standard pipeline:** PASSED (execution #2835 — 103 nodes, 148s, CV + Cover Letter + Email)
- **Premium pipeline:** PASSED (execution #2827 — 104 nodes, 167s)
- **Executive pipeline:** PASSED (execution #2837 — 91 nodes, 195s, CV + CL + Layout + Priority)
- **Next:** 524 Cloudflare timeout fix, addon testing, frontend investigation

### Repositories
| Repo | URL | Purpose |
|------|-----|---------|
| Backend | https://github.com/TinyReset/Ai-Vitae-Backend | n8n workflow docs, migrations, scripts |
| Frontend | https://github.com/TinyReset/CVBuidler | Next.js website (Vercel deployed) |

---

## Architecture Summary

### Package Tiers
| Tier | Price | AI Model | Includes |
|------|-------|----------|----------|
| Starter | €4.99 | GPT-4o-mini | CV rewrite only |
| Standard | €7.99 | GPT-4o-mini | CV rewrite + Cover Letter |
| Premium | €14.99 | Claude Sonnet 4 | CV rewrite + Cover Letter (advanced AI) |
| Executive | €24.99 | Claude Opus 4.1 | CV + Cover Letter + Layout guidance + Priority |

**Note:** Cover letter is INCLUDED in Standard, Premium, and Executive packages (not an add-on).

### Add-ons (Extra, on top of any package)
1. **Extra Cover Letter** - Additional GPT-4o generated cover letter PDF
2. **LinkedIn Optimization** - Optimized LinkedIn profile text
3. **Editable Word** - HTML → DOCX conversion
4. **One Day Delivery** - Priority processing with 24h SLA

### Supporting Workflows
| Workflow | ID | Status |
|----------|-----|--------|
| Email Delivery | `IS4rAklMjfCiQnV5` | ✅ Validated |
| Error & Alert Monitor | `dpobArFb9d8F6RZp` | ✅ Validated |
| Data Retention Cleaning | `hYDSPAe1oNN1Sgrs` | ✅ Validated |

---

## Batch 15: Premium Pipeline End-to-End Testing & Cover Letter Document Fix (COMPLETE)

### Session: 2026-01-30

**Goal:** Test Premium package order end-to-end; fix cover letter document not being saved for included packages; verify email delivery.

#### Problem
Premium package includes a cover letter (generated by Cover Letter Rewrite1), but the cover letter document was never created as a PDF, uploaded to S3, or tracked in the database. The "Extra Cover Letter" addon path was the ONLY code path that created a cover letter document — included cover letters were silently dropped.

Additionally, the Email Delivery workflow crashed with a binary attachment error because `Reattach Email Meta` lost binary data through the merge chain.

#### Root Cause Chain (7 test iterations: executions #2818-#2827)
1. **Stash Context** reconstructed `ctx` without `coverLetterText` — field lost
2. **Normalize Payload** couldn't find `coverLetterText` from any source — Extra Cover Letter IF always FALSE
3. **Write Cover Letter Content** called `$items('Cover Letter - Generate', 0)` which throws when node was skipped
4. **Capture Cover Letter** `joinKey` expression couldn't find `orderId` from available sources
5. **Google Docs pipeline** (Create → Write → Download → Move) strips all context — only passes doc metadata
6. **Upload CoverLetter1** and **Reattach Context2** couldn't find `orderId` after Google Docs pipeline
7. **Reattach Context1** had no `joinKey` field — Merge by Key output 0 items (nothing to merge on)

#### Fixes Applied (11 nodes across 2 workflows)

**Main Workflow (`40hfyY9Px6peWs3wWFkEY`):**
| # | Node | ID | Fix |
|---|------|----|-----|
| 1 | Capture Rewrite1 | `dd8975e5` | Added `coverLetterText` extraction (OpenAI format) |
| 2 | Capture Rewrite2 | `f05556f7` | Added `coverLetterText` extraction (Anthropic format) |
| 3 | Capture Rewrite3 | `fb682146` | Added `coverLetterText` extraction (Anthropic format) |
| 4 | Stash Context | `a2bbc558` | Added `coverLetterText` to ctx object construction |
| 5 | Normalize Payload | `e9e01295` | Added `$node['Capture Rewrite1/2/3']` fallback references for `coverLetterText` |
| 6 | Write Cover Letter Content | `25c0ee39` | Wrapped `$items('Cover Letter - Generate')` in try-catch; try Capture Cover Letter first |
| 7 | Capture Cover Letter | `eb5dcfaa` | Added `$json.orderId`, `$json.docRow.orderId`, `$items("Extra Cover Letter")` fallbacks for joinKey |
| 8 | Upload CoverLetter1 | `09321213` | Added `$node['Capture Cover Letter'].json.joinKey` reference for S3 key |
| 9 | Reattach Context2 | `aebbdf44` | Added `$node['Capture Cover Letter']` references for joinKey/orderId |
| 10 | Reattach Context1 | `f4e185bd` | Added `joinKey` field derivation from orderId/docRow.orderId/ctx.orderId |

**Email Delivery Workflow (`IS4rAklMjfCiQnV5`):**
| # | Node | ID | Fix |
|---|------|----|-----|
| 11 | Reattach Email Meta | `85369918` | Pull binary from `$node["Download Rewritten CV"]` and `$node["Download a file"]` by name instead of `$input` |

#### Cover Letter Document Architecture (new path)
```
Extra Cover Letter [TRUE] → Need CL Generation? → [FALSE: has text] → Capture Cover Letter
  → Create Cover Letter Doc → Write Cover Letter Content → Download Cover Letter PDF
  → Move Binary Data → Upload CoverLetter1 → Reattach Context2 → Merge by Key [input 1]

Reattach Context1 [with joinKey] → Merge by Key [input 0]
Merge by Key (combine by joinKey) → Set joinKey → Shape Documents Map → Assemble Response
  → Execute a SQL query → Trigger Email Workflow
```

#### Test Results
| Execution | Status | Issues Found |
|-----------|--------|--------------|
| 2818 | ERROR | Non-UUID orderId filtered by "If UUID" node |
| 2820 | PARTIAL | coverLetterText empty at Extra Cover Letter (Stash Context + Normalize Payload) |
| 2822 | ERROR | "Node 'Cover Letter - Generate' hasn't been executed" (Write Cover Letter Content) |
| 2824 | PARTIAL | S3 key `orders//cover_letter.pdf` (missing orderId), Merge by Key 0 items |
| 2825 | PARTIAL | S3 key still missing orderId (Google Docs strips context) |
| 2826 | PARTIAL | S3 key fixed, Reattach Context2 fixed, but Reattach Context1 missing joinKey |
| **2827** | **SUCCESS** | **Full pipeline: CV + Cover Letter + Email. 104 nodes, 167s** |

#### Known Issue — FIXED
- ~~**Email Delivery "If Email Sent Ok"** routes to FALSE despite Gmail success~~ → FIXED (fix #9, execution #2836)

---

## Batch 16: Cross-Tier Testing & CV PDF + Email Delivery Fixes (COMPLETE)

### Sessions: 2026-01-31 to 2026-02-01

**Goal:** Test all 4 package tiers end-to-end. Fix CV PDF empty content. Fix Email Delivery false negative. Fix Capture Rewrite (Starter) Responses API extraction.

#### Problems Found & Fixed

**Problem 1: Package tier not reaching Switch node**
- `Build ctx` mapped `ctx.package` from `$json.package` but webhook sends `packageTier`
- `Switch` catch-all condition used `={{ true }}` (boolean) with `typeValidation: "strict"` → type error
- `Normalise & Validate` didn't parse the stringified `ctx` JSON to recover package value

**Problem 2: CV Rewrite nodes using wrong API format**
- Rewrite CV (Starter) and Rewrite CV1 (Standard) used `messages` property (Chat Completions)
- OpenAI node v2.1 defaults to Responses API → `messages` ignored → 7 input tokens (empty)
- Same bug fixed for Proofread CV nodes in Batch 14b, but Rewrite nodes were missed

**Problem 3: CV PDF document empty ("CV rewrite was empty (upstream error)")**
- `Stash Context` extracted `rewrittenCVText` using Chat Completions format (`$json.message.content`)
- After Responses API conversion, output is `$json.output[0].content[0].text` — not matched
- `Capture Rewrite1` correctly extracts `cvRewriteText` as top-level field, but Stash Context didn't check it
- `Google Docs - Write Content` used `$json.cvRewriteText` but Google Docs create replaces `$json` with drive metadata

**Problem 4: Email Delivery "If Email Sent Ok" false negative**
- Condition: `=={{ $json.statusCode ? $json.statusCode < 400 : ($json.success ?? true) }}`
- `==` prefix (instead of `=`) puts literal `=` before `{{ }}`, converting boolean to string `"=true"`
- With `typeValidation: "strict"`, string is not boolean → always FALSE
- `Mark Sent` and `Retry or Dead Letter` used `$json.jobId` but Gmail replaces `$json` with `{ id, threadId, labelIds }`

#### Fixes Applied (11 nodes across 2 workflows)

**Main Workflow (`40hfyY9Px6peWs3wWFkEY`):**
| # | Node | ID | Fix |
|---|------|----|-----|
| 1 | Build ctx | `e88c0ab6` | Added `packageTier` lookup from webhook body |
| 2 | Switch | `0366e8b2` | Fixed catch-all from `={{ true }}` (boolean) to `={{ 'true' }}` (string) |
| 3 | Normalise & Validate | `3010f2fd` | Added ctx JSON string parsing fallback for package, name, email, etc. |
| 4 | Rewrite CV (Starter) | `d9e754f1` | Converted `messages` → `responses.values` (Responses API format) |
| 5 | Rewrite CV1 (Standard) | `3cbc6655` | Converted `messages` → `responses.values` (Responses API format) |
| 6 | Stash Context | `a2bbc558` | Added `$json.cvRewriteText` + Responses API `output[0].content[0].text` fallback |
| 7 | Google Docs - Write Content | `5354860c` | Added `$node['Stash Context']` reference (Google Docs create strips $json) |
| 8 | Capture Rewrite (Starter) | `39e44a7b` | Rewrote to use Responses API format (`$json.output[0].content[0].text`) + `$('Context (carry)')` refs |

**Email Delivery Workflow (`IS4rAklMjfCiQnV5`):**
| # | Node | ID | Fix |
|---|------|----|-----|
| 9 | If Email Sent Ok | `ff589bf3` | Changed `=={{ ... }}` → `={{ !!$json.id }}` (Gmail returns id on success) |
| 10 | Mark Sent | `3b6ca0de` | Parameterized query, `$node['Reattach Email Meta'].json.jobId` |
| 11 | Retry or Dead Letter | `24bf7569` | Parameterized query, upstream node reference for jobId |

#### Test Results
| Execution | Tier | Status | Notes |
|-----------|------|--------|-------|
| 2829 | Standard | ERROR | Package empty at Switch → catch-all (Build ctx + Switch bugs) |
| 2830 | Standard | ERROR | Package empty after Build ctx fix (Normalise & Validate ctx parsing) |
| 2831 | Standard | PARTIAL | Pipeline OK but Rewrite CV1 = 7 tokens (Responses API bug) |
| 2833 | Standard | PARTIAL | CV rewrite 858→616 tokens ✅ but PDF empty (Stash Context bug) |
| **2835** | **Standard** | **SUCCESS** | **CV PDF populated, email delivered, Mark Sent ✅. 103 nodes, 148s** |
| 2836 | Email | **SUCCESS** | **First successful email delivery — If Email Sent Ok → TRUE → Mark Sent (status: "sent")** |
| **2837** | **Executive** | **SUCCESS** | **4-step AI chain (Opus→CL→Proofread→Layout), email delivered. 91 nodes, 195s** |
| 2838 | Email | **SUCCESS** | Executive email delivery ✅ |
| 2839 | Starter | PARTIAL | Rewrite CV ✅ but Capture Rewrite cvRewriteText empty (old Chat Completions extraction) |
| 2841 | Starter | CRASHED | n8n cloud crash (0 nodes executed, Unknown error — platform issue) |
| **2842** | **Starter** | **SUCCESS** | **CV only, no cover letter (correct), email delivered. 91 nodes, 148s** |
| 2843 | Email | **SUCCESS** | Starter email delivery ✅ |

#### Quality Assessment by Tier
| Tier | CV Rating | CL Rating | Model | Duration | Notes |
|------|-----------|-----------|-------|----------|-------|
| Starter (€4.99) | 7/10 | N/A | GPT-4o-mini | 148s | Good structure, keyword targeting. Missing languages section, no contact header. |
| Standard (€7.99) | 7/10 | 8/10 | GPT-4o-mini + Claude Sonnet 4 | 148s | Job-tailored summary, strong verbs. Cover letter professional with quantified achievements. |
| Premium (€14.99) | 8/10 | 8/10 | Claude Sonnet 4 | 167s | Nuanced phrasing, better context awareness. |
| Executive (€24.99) | 9/10 | 9/10 | Claude Opus 4.1 | 195s | Sophisticated language, strategic positioning, layout guidance. |

---

## Batch 14c: Shape Documents Map Fix (COMPLETE)

### Session: 2026-01-29

**Goal:** Fix Shape Documents Map producing empty keys/urls/documents despite valid document data in upstream nodes.

#### Root Cause
Shape Documents Map code only handled `$json.docs[]` array input, but actual inputs are:
- **List Documents for Order** (Postgres): returns separate items with `{kind, storage_key}` — NOT a `docs[]` array
- **No-addon path**: Validate - Has Schema and OrderId fails (no `schema` field), bypasses List Documents, passes `docRow` object directly
- **URL generation**: Used placeholder `<YOUR-PROJECT-REF>` instead of real Supabase URL

#### Fix Applied (1 operation)
| Node | ID | Fix |
|------|----|-----|
| Shape Documents Map | `ae58cc77` | Rewrote to handle 4 input formats: (1) `$input.all()` items with `{kind, storage_key}`, (2) `$json.docs[]` array, (3) `$json.docRow` with kind inference from storage_key path, (4) flat key fields. Hardcoded Supabase URL `xidmgkcqltvknvtuoeoh.supabase.co` |

---

## Batch 14b: Execution #2812 Post-Test Fixes (COMPLETE)

### Session: 2026-01-28

**Goal:** Fix issues discovered in Premium test execution #2812: Proofread CV still 7 input tokens (wrong API format), SQL NOT NULL constraint on subject/body_html.

#### Root Cause Analysis
1. **Proofread CV**: OpenAI node v2.1 defaults `resource: "text"` (Responses API) which uses `responses` property. Batch 14's `messages.values` fix was completely ignored — the node never looked at `messages`.
2. **Execute a SQL query**: `email_jobs` table requires NOT NULL `subject` and `body_html`. Assemble Response doesn't produce these fields. `NULLIF('','')` → NULL → constraint violation.
3. **Frontend 524**: Cloudflare timeout between Vercel and n8n cloud. Transient network issue, not n8n-fixable.

#### Fixes Applied (3 operations)
| # | Node | ID | Fix |
|---|------|----|-----|
| 1 | Starter - Proofread CV | `35bf08e4` | Set `resource: "text"`, `operation: "response"`, `responses.values` with type/role/content, `.first().json` |
| 2 | Standard - Proofread CV | `df4bf557` | Same Responses API format fix |
| 3 | Execute a SQL query | `31ce791b` | Added subject fallback construction, body_html template, full payload object |

#### Key Discovery: OpenAI Node v2.1 Dual API Format
- `messages` property → `resource: "conversation"`, `operation: "create"` (Chat Completions API)
- `responses` property → `resource: "text"`, `operation: "response"` (Responses API, **DEFAULT**)
- Nodes without explicit `resource` use Responses API by default

---

## Batch 14: Execution #2811 Analysis & Fixes (COMPLETE)

### Session: 2026-01-27

**Goal:** Fix issues discovered in Premium test execution #2811: Proofread CV empty prompts (OpenAI 2-message requirement), cvRewriteText double `=`, disconnected Assemble Response → email flow, empty Assemble Response fields.

#### Fixes Applied (5 operations, atomic)
| # | Node | Fix |
|---|------|-----|
| 1 | Starter - Proofread CV (`35bf08e4`) | Split single message to system + user messages for OpenAI node |
| 2 | Standard - Proofread CV (`df4bf557`) | Split single message to system + user messages for OpenAI node |
| 3 | cvRewriteText (final) (`021894d0`) | Fixed `=={{` → `={{`, removed empty `name:"",value:""` assignment |
| 4 | Connection (new) | Added: Assemble Response → Execute a SQL query (was disconnected) |
| 5 | Assemble Response (`f798ff3f`) | Fixed `orderId ` trailing space, refs to `$('Context (carry)').first().json.*` + `$('Shape Documents Map').first().json.*` |

#### Deferred: Frontend confirmation page slowness
Webhook responds in ~10ms with 202. Slowness is in the Next.js frontend on Vercel, not n8n. Requires separate investigation in CVBuilder repo.

---

## Batch 13: AI Prompt & Capture Node Fixes (COMPLETE)

### Session: 2026-01-27

**Goal:** Fix static prompts in Cover Letter, Proofread, and Format nodes. Fix Capture Rewrite nodes to handle Anthropic/OpenAI output formats. Add Merge by Key error handling.

#### Problem (from test execution #2810)
All Cover Letter Rewrite, Proofread CV, and Format CV Layout nodes had **static prompts** - no `=` prefix, no `{{ }}` expressions. The AI received vague instructions but no actual CV text, job description, or candidate name. Capture Rewrite nodes used `$json.*` which couldn't extract data from Anthropic or OpenAI Responses API output formats.

#### Fixes Applied (10 operations)
1. **Cover Letter Rewrite1** (Premium) - Dynamic prompt with Context (carry) + Premium CV Rewrite refs
2. **Cover Letter Rewrite** (Standard) - Dynamic prompt with Context (carry) + Rewrite CV1 refs
3. **Cover Letter Rewrite2** (Executive) - Dynamic prompt with Context (carry) + Executive CV Rewrite refs
4. **Starter - Proofread CV** - Dynamic prompt referencing Premium CV Rewrite (Anthropic format)
5. **Standard - Proofread CV** - Dynamic prompt referencing Executive CV Rewrite (Anthropic format)
6. **Capture Rewrite1** - joinKey/cvRewriteText/ctx from upstream nodes directly
7. **Capture Rewrite2** - Multi-format AI output extraction (Anthropic + OpenAI Responses)
8. **Capture Rewrite3** - Multi-format AI output extraction
9. **Merge by Key** - Added `onError: continueRegularOutput` for empty input handling
10. **Executive - Format CV Layout** - Dynamic prompt referencing Standard - Proofread CV output

#### Nodes Modified
| Node | ID | Change |
|------|-----|--------|
| Cover Letter Rewrite1 | `dde6a403-d7f1-41c9-9d5d-7addb8cd299b` | Dynamic prompt with `=` + `{{ }}` |
| Cover Letter Rewrite | `b6a6f5f5-f488-4c54-b399-6365b8a05496` | Dynamic prompt with `=` + `{{ }}` |
| Cover Letter Rewrite2 | `f115fc99-e1ea-452e-9ecc-ef09fdbee5d6` | Dynamic prompt with `=` + `{{ }}` |
| Starter - Proofread CV | `35bf08e4-1293-4a3b-9db6-4651aa8fa324` | Dynamic prompt referencing upstream |
| Standard - Proofread CV | `df4bf557-d290-4c3d-9ccf-e0aead973556` | Dynamic prompt referencing upstream |
| Capture Rewrite1 | `dd8975e5-6935-41d2-8254-cddb252ae5b9` | Upstream node references for all 3 fields |
| Capture Rewrite2 | `f05556f7-e910-4f24-87d4-452b31ebb3d1` | Multi-format output extraction |
| Capture Rewrite3 | `fb682146-be44-49b9-b491-90ae5eecd58d` | Multi-format output extraction |
| Merge by Key | `434cc86a-d552-4f72-b194-0d29ed3d0f74` | `onError: continueRegularOutput` |
| Executive - Format CV Layout | `e16e2f32-067d-46d8-9182-a5e794bd4e99` | Dynamic prompt referencing upstream |

---

## Batch 12: Cover Letter Node Reconnection (COMPLETE)

### Session: 2026-01-27

**Goal:** Reconnect Cover Letter Rewrite nodes to Standard, Premium, and Executive tier flows.

#### Problem (from test order #2809)
Cover Letter Rewrite nodes were **ORPHANED** - no input connections. CV Rewrite nodes bypassed cover letter generation entirely.

#### Fix Applied
Used `rewireConnection` operations to redirect CV Rewrite `main` outputs through Cover Letter Rewrite nodes:

| Tier | Before (Broken) | After (Fixed) |
|------|-----------------|---------------|
| Standard | Rewrite CV1 → Capture Rewrite1 | Rewrite CV1 → **Cover Letter Rewrite** → Capture Rewrite1 |
| Premium | Premium CV Rewrite → Capture Rewrite2 | Premium CV Rewrite → **Cover Letter Rewrite1** → Proofread → Capture Rewrite2 |
| Executive | Executive CV Rewrite → Capture Rewrite3 | Executive CV Rewrite → **Cover Letter Rewrite2** → Proofread → Format → Capture Rewrite3 |

#### Verified Flows (from live workflow data)
- **Starter:** Switch → Rewrite CV → Capture Rewrite → cvRewriteText (final) (no cover letter - correct)
- **Standard:** Switch → Rewrite CV1 → Cover Letter Rewrite → Capture Rewrite1 → cvRewriteText (final)
- **Premium:** Switch → Premium CV Rewrite → Cover Letter Rewrite1 → Starter - Proofread CV → Capture Rewrite2 → cvRewriteText (final)
- **Executive:** Switch → Executive CV Rewrite → Cover Letter Rewrite2 → Standard - Proofread CV → Executive - Format CV Layout → Capture Rewrite3 → cvRewriteText (final)

#### Operations Applied
1. `rewireConnection`: Rewrite CV1 main output from Capture Rewrite1 → Cover Letter Rewrite
2. `rewireConnection`: Premium CV Rewrite main output from Capture Rewrite2 → Cover Letter Rewrite1
3. `rewireConnection`: Executive CV Rewrite main output from Capture Rewrite3 → Cover Letter Rewrite2
4. `removeConnection`: Cleaned up 3 erroneous "0" type connections from initial attempt

---

## Batch 11: Supabase Storage & Data Flow Fixes (COMPLETE)

### Session: 2026-01-26

**Goal:** Fix orderId data flow and configure Supabase Storage for file uploads.

#### Issues Diagnosed & Fixed

**1. orderId Lost After Extract from File [FIXED]**
- **Symptom:** `null value in column "order_id" of relation "documents" violates not-null constraint`
- **Root Cause:** Extract from File nodes extract text but don't preserve ctx object
- **Fix:** Updated joinKey1 and Stash Context to reference upstream nodes directly

**2. Supabase Storage Not Configured [FIXED]**
- **Symptom:** `getaddrinfo ENOTFOUND replace_with_supabase_project_ref.supabase.co`
- **Root Cause:** Missing Supabase URL and service role key in Set - Config
- **Fix:** Added credentials: `xidmgkcqltvknvtuoeoh.supabase.co` + service role JWT

**3. HTTP Request _cfg Access [FIXED]**
- **Symptom:** HTTP Request couldn't access `_cfg.supabaseUrl`
- **Root Cause:** Collapse To One1 node doesn't pass `_cfg` through
- **Fix:** Updated HTTP Request to reference `$('Context (carry)').item.json._cfg` directly

#### Nodes Modified
| Node | Change | Node ID |
|------|--------|---------|
| joinKey1 | References `$('Stash Metadata').item.json.ctx` directly | `5d66af5a-b825-429e-8223-e1841764767b` |
| Stash Context | References `$('Context (carry)').item.json` directly | `a2bbc558-8da5-440c-a7b3-035e3c7dd1c0` |
| Set - Config | Added `_cfg.supabaseUrl` and `_cfg.supabaseKey` | `31a26c23-1239-428e-8b61-3990b2ae0893` |
| HTTP Request | References `$('Context (carry)').item.json._cfg` | `154aace9-5adf-4929-8e59-0013e9e4a00b` |

#### Test Results
| Execution | Status | Notes |
|-----------|--------|-------|
| 2809 | PARTIAL | CV ✅, Cover Letter ❌ (led to Batch 12 discovery) |
| 2806 | ERROR | null order_id SQL constraint (fixed) |

---

## Batch 10: Data Flow & Performance Fixes (COMPLETE)

### Session: 2026-01-25

**Goal:** Fix data flow issues causing order processing failures.

#### Issues Fixed
- Build ctx node empty - added field mappings
- Idempotency Check too slow - DISABLED
- Binary data lost after Respond 202 - converted Stash Metadata to Code node
- Set - Config $env access denied - replaced with hardcoded values
- Duplicate Error Handler - DISABLED

---

## Currently Disabled Nodes (for performance/compatibility)

| Node | Node ID | Reason |
|------|---------|--------|
| Rate Limiter | `b0f341bb-668e-4fcc-9dfe-5b9825cd7918` | Was adding 2.2s delay |
| Idempotency Check | `b7dad4ba-70b5-45fa-8f0f-14f6d82f66df` | Was adding 2.2s delay |
| Error Handler | `0d11e236-af2b-4175-9285-9963c4a43ee5` | Duplicates separate error workflow |

---

## Completed Batches Summary

### Batch 1: Main Workflow Optimization (COMPLETE)
- Removed AI Orchestrator layer
- Fixed security node positioning
- Consolidated file processing nodes
- Enhanced tier-specific AI prompts
- **Result:** 15 nodes removed, ~$0.02 saved per order

### Batch 2: Workflow Validation & Error Fixes (COMPLETE)
- Fixed 15 IF nodes missing error handling
- Fixed 17 nodes with optional chaining issues
- Validated 5 errors as false positives
- **Result:** Warnings reduced from 229 to 154

### Batch 3: Optional Improvements (COMPLETE)
- Upgraded typeVersions on 37 nodes
- Added error handling to 40+ nodes
- **Result:** Warnings reduced to 94

### Batch 4: Supporting Workflows Validation (COMPLETE)
- Validated and fixed 3 supporting workflows
- Applied 17 total operations

### Batch 5: Database Security Audit (COMPLETE)
- Added 11 payment tracking columns
- Created audit_log table with triggers
- Enabled RLS on all tables

### Batch 6: Stripe Payment Passthrough (COMPLETE)
- Frontend captures payment_intent, customer_id from Stripe
- n8n workflow stores payment data in orders table

### Batch 7: P&L Fixes & Addon Pricing (COMPLETE)
- Fixed Compute Token Cost node references
- Enabled addon pricing in Stripe checkout

### Batch 8: Binary Data Fix (COMPLETE)
- Rewrote Idempotency Check to preserve binary
- Added `includeBinary: true` to 4 Set nodes

### Batch 9: Timeout Fix & Frontend Repairs (COMPLETE)
- Disabled Rate Limiter to fix 524 timeout
- Fixed frontend orderId generation
- Fixed corrupted checkout file

---

## Key Files

| File | Description |
|------|-------------|
| `PLAN.md` | This file - project planning and context |
| `TODO.md` | Current task tracking and checklists |
| `VALIDATION_REPORT.md` | Complete validation documentation |
| `OPTIMIZATION_SUMMARY.md` | Optimization details and testing checklist |

---

## Session Resume Instructions

When starting a new Claude Code session:

### Quick Start
1. Read `PLAN.md` (this file) for project context and current status
2. Read `TODO.md` for actionable tasks and checklists

### IMPORTANT: Workflow Source of Truth
- **DO NOT** use any local JSON workflow files - they are outdated
- The **ONLY** valid workflow is the live n8n workflow (ID: `40hfyY9Px6peWs3wWFkEY`)
- **ALL** workflow changes must be made via MCP connection to n8n cloud
- Use `n8n_get_workflow` to read current state, `n8n_update_partial_workflow` to modify

### MCP Tools Available

**n8n MCP (workflow management):**
- `n8n_list_workflows` - List all workflows
- `n8n_get_workflow` - Get workflow details (use mode='structure' for node list)
- `n8n_validate_workflow` - Validate workflow (use profile='runtime')
- `n8n_update_partial_workflow` - Apply incremental changes
- `n8n_executions` - Check execution history and errors

### Current State Summary
- **Main Workflow ID:** `40hfyY9Px6peWs3wWFkEY`
- **Workflow Status:** Rate Limiter, Idempotency Check, Error Handler DISABLED
- **Response Time:** ~10ms to Respond 202 (was 2.3s+)
- **Database Status:** Migrations executed, payment tracking active
- **Frontend Status:** Fixed and deployed
- **Supabase Storage:** Configured with credentials (`xidmgkcqltvknvtuoeoh.supabase.co`)

### What's Next (Post Batch 16)
1. ~~TEST STANDARD ORDER~~ ✅ PASSED (execution #2835)
2. ~~FIX EMAIL DELIVERY "If Email Sent Ok"~~ ✅ FIXED (execution #2836)
3. ~~TEST EXECUTIVE ORDER~~ ✅ PASSED (execution #2837)
4. ~~TEST STARTER ORDER~~ ✅ PASSED (execution #2842, required Capture Rewrite fix)
5. **524 CLOUDFLARE TIMEOUT** - Workflow takes ~148-195s, Cloudflare times out at ~100s. Use "Respond to Webhook" node for async pattern.
6. **ADDON TESTING** - Extra Cover Letter, LinkedIn Optimization, Editable Word, One Day Delivery
7. **INVESTIGATE FRONTEND** - Confirmation page slowness (Next.js/Vercel, not n8n)
8. **FUTURE: Re-enable Rate Limiter & Idempotency Check** - Move after Respond 202

---

**Last Updated:** 2026-02-01
**Session:** Batch 16 COMPLETE — ALL 4 tiers PASSED (11 fixes across 2 workflows), Email Delivery FIXED
**Next Action:** 524 timeout fix, addon testing
